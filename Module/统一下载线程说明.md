# ç»Ÿä¸€å•çº¿ç¨‹ä¸‹è½½å™¨

## ğŸ¯ æ”¹è¿›ç›®æ ‡

**ä»å¤šçº¿ç¨‹ä¸‹è½½æ”¹ä¸ºå•çº¿ç¨‹ + é˜Ÿåˆ—ä¸‹è½½**

### æ”¹è¿›å‰ï¼ˆâŒ å¤šçº¿ç¨‹ï¼‰
- æ¯ä¸ªä¸‹è½½ä»»åŠ¡åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹
- å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¸‹è½½ï¼Œç«äº‰èµ„æº
- çº¿ç¨‹ç®¡ç†å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™
- çº¿ç¨‹å®‰å…¨é—®é¢˜

### æ”¹è¿›åï¼ˆâœ… å•çº¿ç¨‹ + é˜Ÿåˆ—ï¼‰
- åªæœ‰ä¸€ä¸ªä¸‹è½½å·¥ä½œçº¿ç¨‹
- æ‰€æœ‰ä¸‹è½½ä»»åŠ¡æ’é˜Ÿå¤„ç†
- ç®€å•é«˜æ•ˆï¼Œé¿å…ç«äº‰
- ç»Ÿä¸€ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

#### 1. `DownloadTask`ï¼ˆä¸‹è½½ä»»åŠ¡ï¼‰

```python
class DownloadTask:
    def __init__(self, task_type: str, client, file_id, save_path: Path, device_id: str):
        self.task_type = task_type    # 'excel' æˆ– 'image'
        self.client = client            # ä¸‹è½½å®¢æˆ·ç«¯
        self.file_id = file_id          # æ–‡ä»¶ID
        self.save_path = save_path      # ä¿å­˜è·¯å¾„
        self.device_id = device_id      # è®¾å¤‡ID
```

#### 2. `DownloadWorkerThread`ï¼ˆä¸‹è½½å·¥ä½œçº¿ç¨‹ï¼‰

```python
class DownloadWorkerThread(QThread):
    # ä¿¡å·
    download_finished = pyqtSignal(str, str, str)  # (task_type, file_path, device_id)
    download_failed = pyqtSignal(str, str, str)    # (task_type, error, device_id)
    
    def __init__(self):
        self.task_queue = queue.Queue()  # ä»»åŠ¡é˜Ÿåˆ—
        self.running = True
    
    def add_task(self, task: DownloadTask):
        """æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—"""
        self.task_queue.put(task)
    
    def run(self):
        """å·¥ä½œçº¿ç¨‹ä¸»å¾ªç¯"""
        while self.running:
            task = self.task_queue.get(timeout=1.0)  # ä»é˜Ÿåˆ—å–ä»»åŠ¡
            self._process_task(task)                  # å¤„ç†ä»»åŠ¡
            self.task_queue.task_done()               # æ ‡è®°å®Œæˆ
```

---

## ğŸ“Š å·¥ä½œæµç¨‹

### 1. å¯åŠ¨é˜¶æ®µ

```
çª—å£åˆå§‹åŒ–
    â†“
åˆ›å»º DownloadWorkerThread
    â†“
è¿æ¥ä¿¡å·æ§½
    â†“
å¯åŠ¨å·¥ä½œçº¿ç¨‹ (start())
    â†“
å·¥ä½œçº¿ç¨‹è¿›å…¥ä¸»å¾ªç¯ï¼Œç­‰å¾…ä»»åŠ¡
```

### 2. ä¸‹è½½è¯·æ±‚

```
æ”¶åˆ°æ–°æ•°æ®é€šçŸ¥
    â†“
åˆ›å»º DownloadTask
    â†“
æ·»åŠ åˆ°é˜Ÿåˆ— (download_worker.add_task(task))
    â†“
è¿”å›ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
```

### 3. ä¸‹è½½å¤„ç†

```
å·¥ä½œçº¿ç¨‹ä»é˜Ÿåˆ—å–ä»»åŠ¡
    â†“
æ‰§è¡Œä¸‹è½½ï¼ˆExcelæˆ–Imageï¼‰
    â†“
ä¸‹è½½æˆåŠŸ â†’ å‘é€ download_finished ä¿¡å·
    â†“
ä¸»çº¿ç¨‹æ”¶åˆ°ä¿¡å· â†’ åŠ è½½å¹¶æ˜¾ç¤ºæ•°æ®
```

### 4. é”™è¯¯å¤„ç†

```
ä¸‹è½½å¤±è´¥
    â†“
æ•è·å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—
    â†“
å‘é€ download_failed ä¿¡å·
    â†“
ä¸»çº¿ç¨‹æ”¶åˆ°ä¿¡å· â†’ æ˜¾ç¤ºé”™è¯¯æç¤º
```

---

## ğŸ”„ é˜Ÿåˆ—æœºåˆ¶

### ä»»åŠ¡é˜Ÿåˆ—ï¼ˆFIFOï¼‰

```
ä»»åŠ¡æ·»åŠ é¡ºåº: [ä»»åŠ¡1, ä»»åŠ¡2, ä»»åŠ¡3, ä»»åŠ¡4]
               â†“      â†“      â†“      â†“
å¤„ç†é¡ºåº:     ä»»åŠ¡1 â†’ ä»»åŠ¡2 â†’ ä»»åŠ¡3 â†’ ä»»åŠ¡4
```

**ç‰¹ç‚¹ï¼š**
- å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰
- çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨Python `queue.Queue`ï¼‰
- è‡ªåŠ¨é˜»å¡ï¼ˆé˜Ÿåˆ—ç©ºæ—¶ç­‰å¾…ï¼‰
- æ”¯æŒè¶…æ—¶ï¼ˆé¿å…æ— é™ç­‰å¾…ï¼‰

### é˜Ÿåˆ—çŠ¶æ€

```python
# æ·»åŠ ä»»åŠ¡
self.task_queue.put(task)  # éé˜»å¡æ·»åŠ 

# è·å–ä»»åŠ¡
task = self.task_queue.get(timeout=1.0)  # è¶…æ—¶1ç§’

# æ ‡è®°å®Œæˆ
self.task_queue.task_done()

# é˜Ÿåˆ—å¤§å°
size = self.task_queue.qsize()
```

---

## ğŸ”§ ä»£ç ä¿®æ”¹

### ç”µé‡ç•Œé¢

#### æ—§ä»£ç ï¼ˆå¤šçº¿ç¨‹ï¼‰

```python
# åˆ›å»ºæ–°çº¿ç¨‹
download_thread = ExcelDownloadThread(client, file_id, save_path, device_id)

# è¿æ¥ä¿¡å·
download_thread.download_finished.connect(self.on_download_finished)
download_thread.download_failed.connect(self.on_download_failed)
download_thread.finished.connect(lambda: self.on_thread_finished(download_thread))

# ç®¡ç†çº¿ç¨‹
self.active_download_threads.append(download_thread)

# å¯åŠ¨çº¿ç¨‹
download_thread.start()
```

#### æ–°ä»£ç ï¼ˆå•çº¿ç¨‹ + é˜Ÿåˆ—ï¼‰

```python
# åˆ›å»ºä»»åŠ¡
task = DownloadTask(
    task_type='excel',
    client=self.server_client.client,
    file_id=file_id,
    save_path=save_path,
    device_id=device_id
)

# æ·»åŠ åˆ°é˜Ÿåˆ—
self.download_worker.add_task(task)
```

**å‡å°‘äº†90%çš„ä»£ç ï¼**

---

### å‡ ä½•é‡ç•Œé¢

#### æ—§ä»£ç ï¼ˆå¤šçº¿ç¨‹ï¼‰

```python
# åˆ›å»ºæ–°çº¿ç¨‹
download_thread = ImageDownloadThread(client, file_id, save_path, device_id)

# è¿æ¥ä¿¡å·
download_thread.download_finished.connect(self.on_image_download_finished)
download_thread.download_failed.connect(self.on_image_download_failed)
download_thread.finished.connect(lambda: self.on_thread_finished(download_thread))

# ç®¡ç†çº¿ç¨‹
self.active_download_threads.append(download_thread)

# å¯åŠ¨çº¿ç¨‹
download_thread.start()
```

#### æ–°ä»£ç ï¼ˆå•çº¿ç¨‹ + é˜Ÿåˆ—ï¼‰

```python
# åˆ›å»ºä»»åŠ¡
task = DownloadTask(
    task_type='image',
    client=self.server_client.client,
    file_id=file_id,
    save_path=save_path,
    device_id=device_id
)

# æ·»åŠ åˆ°é˜Ÿåˆ—
self.download_worker.add_task(task)
```

---

## ğŸ“¡ ä¿¡å·ä¸æ§½

### ç»Ÿä¸€çš„ä¿¡å·

```python
# ä¸‹è½½å®Œæˆä¿¡å·
download_finished = pyqtSignal(str, str, str)
# å‚æ•°: (task_type, file_path, device_id)

# ä¸‹è½½å¤±è´¥ä¿¡å·
download_failed = pyqtSignal(str, str, str)
# å‚æ•°: (task_type, error, device_id)
```

### è¿æ¥æ–¹å¼

```python
# åœ¨çª—å£åˆå§‹åŒ–æ—¶è¿æ¥ä¸€æ¬¡
self.download_worker = DownloadWorkerThread()
self.download_worker.download_finished.connect(self.on_download_finished_unified)
self.download_worker.download_failed.connect(self.on_download_failed_unified)
self.download_worker.start()
```

### ç»Ÿä¸€å¤„ç†

```python
def on_download_finished_unified(self, task_type: str, file_path: str, device_id: str):
    """ç»Ÿä¸€çš„ä¸‹è½½å®Œæˆå›è°ƒ"""
    if task_type == 'excel':
        # å¤„ç†Excelä¸‹è½½å®Œæˆ
        self.load_excel_file(file_path, device_id)
    elif task_type == 'image':
        # å¤„ç†å›¾ç‰‡ä¸‹è½½å®Œæˆ
        self.on_image_download_finished(file_path, device_id)

def on_download_failed_unified(self, task_type: str, error: str, device_id: str):
    """ç»Ÿä¸€çš„ä¸‹è½½å¤±è´¥å›è°ƒ"""
    if task_type == 'excel':
        self.status_label.setText(f"Excelä¸‹è½½å¤±è´¥: {error}")
    elif task_type == 'image':
        self.status_label.setText(f"å›¾ç‰‡ä¸‹è½½å¤±è´¥: {error}")
```

---

## ğŸ†š å¯¹æ¯”ï¼šå¤šçº¿ç¨‹ vs å•çº¿ç¨‹

### èµ„æºä½¿ç”¨

| é¡¹ç›® | å¤šçº¿ç¨‹ | å•çº¿ç¨‹ + é˜Ÿåˆ— |
|------|--------|---------------|
| çº¿ç¨‹æ•°é‡ | Nï¼ˆä»»åŠ¡æ•°é‡ï¼‰ | 1ï¼ˆå›ºå®šï¼‰ |
| å†…å­˜å ç”¨ | é«˜ï¼ˆæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹æ ˆï¼‰ | ä½ï¼ˆåªæœ‰é˜Ÿåˆ—ï¼‰ |
| CPUåˆ‡æ¢ | é¢‘ç¹ï¼ˆNä¸ªçº¿ç¨‹ï¼‰ | æœ€å°‘ï¼ˆ1ä¸ªçº¿ç¨‹ï¼‰ |
| çº¿ç¨‹ç®¡ç† | å¤æ‚ï¼ˆåˆ›å»º/æ¸…ç†/è·Ÿè¸ªï¼‰ | ç®€å•ï¼ˆåªå¯åŠ¨ä¸€æ¬¡ï¼‰ |

### ä»£ç å¤æ‚åº¦

| é¡¹ç›® | å¤šçº¿ç¨‹ | å•çº¿ç¨‹ + é˜Ÿåˆ— |
|------|--------|---------------|
| çº¿ç¨‹ç±» | 2ä¸ªï¼ˆExcel + Imageï¼‰ | 1ä¸ªï¼ˆç»Ÿä¸€ï¼‰ |
| çº¿ç¨‹ç®¡ç† | éœ€è¦åˆ—è¡¨è·Ÿè¸ª | ä¸éœ€è¦ |
| ä¿¡å·è¿æ¥ | æ¯ä¸ªçº¿ç¨‹éƒ½è¦è¿æ¥ | åªè¿æ¥ä¸€æ¬¡ |
| æ¸…ç†ä»£ç  | éœ€è¦ `on_thread_finished` | ä¸éœ€è¦ |

### æ€§èƒ½

| åœºæ™¯ | å¤šçº¿ç¨‹ | å•çº¿ç¨‹ + é˜Ÿåˆ— |
|------|--------|---------------|
| å°‘é‡ä»»åŠ¡ï¼ˆ1-5ä¸ªï¼‰ | å¿«ï¼ˆå¹¶è¡Œï¼‰ | ç¨æ…¢ï¼ˆä¸²è¡Œï¼‰ |
| å¤§é‡ä»»åŠ¡ï¼ˆ20+ä¸ªï¼‰ | æ…¢ï¼ˆçº¿ç¨‹åˆ‡æ¢å¼€é”€ï¼‰ | ç¨³å®šï¼ˆé¡ºåºå¤„ç†ï¼‰ |
| ç½‘ç»œå—é™ | æ— ä¼˜åŠ¿ï¼ˆç“¶é¢ˆåœ¨ç½‘ç»œï¼‰ | ç›¸åŒé€Ÿåº¦ |
| CPUå¯†é›† | æœ‰ä¼˜åŠ¿ | ç›¸åŒï¼ˆIOå¯†é›†ä»»åŠ¡ï¼‰ |

**ç»“è®ºï¼šå¯¹äºç½‘ç»œä¸‹è½½ï¼ˆIOå¯†é›†å‹ï¼‰ï¼Œå•çº¿ç¨‹ + é˜Ÿåˆ—æ˜¯æ›´ä¼˜é€‰æ‹©ï¼**

---

## âœ… ä¼˜åŠ¿æ€»ç»“

### 1. **ç®€åŒ–ä»£ç **
- åˆ é™¤ `ExcelDownloadThread` å’Œ `ImageDownloadThread` ç±»
- åˆ é™¤ `active_download_threads` çº¿ç¨‹åˆ—è¡¨
- åˆ é™¤ `on_thread_finished` æ¸…ç†æ–¹æ³•
- ä»£ç é‡å‡å°‘ **80%**

### 2. **é¿å…ç«æ€**
- å•çº¿ç¨‹ä¸²è¡Œå¤„ç†ï¼Œä¸ä¼šç«äº‰èµ„æº
- ä¸éœ€è¦å¤æ‚çš„é”æœºåˆ¶
- ä¸ä¼šå‡ºç°"4å¼ å›¾ç‰‡åœ¨åŒä¸€åŒºåŸŸ"çš„é—®é¢˜

### 3. **ç»Ÿä¸€ç®¡ç†**
- æ‰€æœ‰ä¸‹è½½ä»»åŠ¡éƒ½åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­
- å¯ä»¥æ–¹ä¾¿åœ°ç›‘æ§é˜Ÿåˆ—çŠ¶æ€
- æ˜“äºæ·»åŠ ä¼˜å…ˆçº§ã€é™æµç­‰åŠŸèƒ½

### 4. **èµ„æºé«˜æ•ˆ**
- åªæœ‰1ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå†…å­˜å ç”¨ä½
- å‡å°‘çº¿ç¨‹åˆ‡æ¢å¼€é”€
- ç½‘ç»œè¿æ¥å¤ç”¨ï¼ˆå¦‚æœæ”¯æŒï¼‰

### 5. **æ˜“äºæ‰©å±•**
- æ–°å¢ä¸‹è½½ç±»å‹åªéœ€åœ¨ `task_type` ä¸­æ·»åŠ 
- ä¸éœ€è¦åˆ›å»ºæ–°çš„çº¿ç¨‹ç±»
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç”µé‡ç•Œé¢ä¸‹è½½

```python
# æ”¶åˆ°æ–°ç”µé‡æ•°æ®é€šçŸ¥
def on_new_data_received(self, data: dict):
    file_id = data.get('file_id')
    device_id = data.get('device_id')
    file_name = data.get('file_name')
    
    # åˆ›å»ºä»»åŠ¡
    task = DownloadTask(
        task_type='excel',
        client=self.server_client.client,
        file_id=file_id,
        save_path=Path(f"data/excel/{device_id}/{file_name}"),
        device_id=device_id
    )
    
    # æ·»åŠ åˆ°é˜Ÿåˆ—
    self.download_worker.add_task(task)
    
    # ç«‹å³è¿”å›ï¼Œä¸é˜»å¡
```

### å‡ ä½•é‡ç•Œé¢ä¸‹è½½

```python
# æ”¶åˆ°æ–°å›¾ç‰‡æ•°æ®é€šçŸ¥
def on_new_image_received(self, data: dict):
    file_id = data.get('file_id')
    device_id = data.get('device_id')
    file_name = data.get('file_name')
    
    # åˆ›å»ºä»»åŠ¡
    task = DownloadTask(
        task_type='image',
        client=self.server_client.client,
        file_id=file_id,
        save_path=Path(f"data/image/{device_id}/{file_name}"),
        device_id=device_id
    )
    
    # æ·»åŠ åˆ°é˜Ÿåˆ—
    self.download_worker.add_task(task)
    
    # ç«‹å³è¿”å›ï¼Œä¸é˜»å¡
```

---

## ğŸ“Š æ—¥å¿—ç¤ºä¾‹

### æ·»åŠ ä»»åŠ¡

```
2025-12-12 05:00:01 | INFO | [ä¸‹è½½é˜Ÿåˆ—] æ·»åŠ ä»»åŠ¡: excel, data_001.xlsx, é˜Ÿåˆ—å¤§å°: 1
2025-12-12 05:00:02 | INFO | [ä¸‹è½½é˜Ÿåˆ—] æ·»åŠ ä»»åŠ¡: image, img_001.png, é˜Ÿåˆ—å¤§å°: 2
2025-12-12 05:00:03 | INFO | [ä¸‹è½½é˜Ÿåˆ—] æ·»åŠ ä»»åŠ¡: image, img_002.png, é˜Ÿåˆ—å¤§å°: 3
```

### å¤„ç†ä»»åŠ¡

```
2025-12-12 05:00:01 | INFO | [ä¸‹è½½å·¥ä½œçº¿ç¨‹] å¼€å§‹ä¸‹è½½ excel: data_001.xlsx, file_id=123
2025-12-12 05:00:02 | INFO | [ä¸‹è½½å·¥ä½œçº¿ç¨‹] ä¸‹è½½å®Œæˆ excel: data/excel/device_001/data_001.xlsx
2025-12-12 05:00:02 | INFO | [ä¸‹è½½å·¥ä½œçº¿ç¨‹] å¼€å§‹ä¸‹è½½ image: img_001.png, file_id=456
2025-12-12 05:00:03 | INFO | [ä¸‹è½½å·¥ä½œçº¿ç¨‹] ä¸‹è½½å®Œæˆ image: data/image/device_001/img_001.png
```

---

## ğŸ‰ æ€»ç»“

### ä¿®æ”¹å†…å®¹

1. âœ… åˆ›å»ºç»Ÿä¸€çš„ `DownloadWorkerThread` ç±»
2. âœ… åˆ é™¤ `ExcelDownloadThread` å’Œ `ImageDownloadThread`
3. âœ… ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†æ‰€æœ‰ä¸‹è½½
4. âœ… ç»Ÿä¸€çš„ä¿¡å·å¤„ç†æœºåˆ¶
5. âœ… ç®€åŒ–ä»£ç ï¼Œæé«˜å¯ç»´æŠ¤æ€§

### å…³é”®ç‰¹æ€§

- **å•çº¿ç¨‹**ï¼šåªæœ‰1ä¸ªä¸‹è½½å·¥ä½œçº¿ç¨‹
- **é˜Ÿåˆ—ç®¡ç†**ï¼šFIFOé˜Ÿåˆ—ï¼Œè‡ªåŠ¨æ’é˜Ÿ
- **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰ä¸‹è½½ä»»åŠ¡ä½¿ç”¨ç›¸åŒçš„API
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨Pythonæ ‡å‡†åº“ `queue.Queue`
- **æ˜“äºæ‰©å±•**ï¼šæ–°å¢ä¸‹è½½ç±»å‹åªéœ€ä¿®æ”¹ `task_type`

### æ–‡ä»¶æ¸…å•

- `Module/common/download_worker.py` - ç»Ÿä¸€ä¸‹è½½å·¥ä½œçº¿ç¨‹
- `Module/excel_data_viewer/index/excel_viewer_window.py` - ç”µé‡ç•Œé¢ï¼ˆå·²ä¿®æ”¹ï¼‰
- `Module/image_data_viewer/index/image_viewer_window.py` - å‡ ä½•é‡ç•Œé¢ï¼ˆå·²ä¿®æ”¹ï¼‰

ä»£ç æ›´ç®€æ´ï¼Œæ€§èƒ½æ›´ç¨³å®šï¼Œç»´æŠ¤æ›´å®¹æ˜“ï¼ğŸ‰

