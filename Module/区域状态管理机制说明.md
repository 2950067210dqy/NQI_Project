# å‡ ä½•é‡ç•Œé¢ - åŒºåŸŸçŠ¶æ€ç®¡ç†æœºåˆ¶

## ğŸ¯ é—®é¢˜æ ¹æº

### åŸæœ‰é—®é¢˜
å³ä½¿åŠ äº†é”ï¼Œ`next_index` ä»ç„¶å‡ºç° `0, 1, 1, 0` çš„æ··ä¹±æƒ…å†µï¼ŒåŸå› æ˜¯ï¼š

1. **ç´¢å¼•ç®¡ç†ä¸å¤Ÿæ˜ç¡®**ï¼šä¾èµ– `next_index` é€’å¢ï¼Œä½†ä¸èƒ½å‡†ç¡®åæ˜ å“ªäº›åŒºåŸŸçœŸæ­£å¯ç”¨
2. **å¼‚æ­¥ä¸‹è½½ç«äº‰**ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶ä¸‹è½½å®Œæˆï¼Œå¯èƒ½åœ¨é”é‡Šæ”¾çš„ç¬é—´è·å–åˆ°ç›¸åŒçš„åŒºåŸŸ
3. **çŠ¶æ€ä¸æ¸…æ™°**ï¼šåªçŸ¥é“ç´¢å¼•ï¼Œä¸çŸ¥é“åŒºåŸŸçš„å®é™…çŠ¶æ€ï¼ˆç©ºé—²/ä½¿ç”¨ä¸­/å·²å ç”¨ï¼‰

---

## âœ… æ–°çš„è§£å†³æ–¹æ¡ˆï¼šçŠ¶æ€æ ‡è®°æœºåˆ¶

### æ ¸å¿ƒæ€æƒ³
ä¸ºæ¯ä¸ª `ImageDisplayWidget` æ·»åŠ æ˜ç¡®çš„çŠ¶æ€æ ‡è®°ï¼Œåœ¨åˆ†é…åŒºåŸŸæ—¶ç«‹å³æ ‡è®°ä¸º"é¢„ç•™"ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹ä½¿ç”¨ã€‚

---

## ğŸ“Š çŠ¶æ€æšä¸¾

### ä¸‰ç§çŠ¶æ€

```python
class ImageDisplayWidget(QFrame):
    # âœ… åŒºåŸŸçŠ¶æ€æšä¸¾
    STATUS_EMPTY = 'empty'      # ç©ºé—²ï¼šå¯ä»¥è¢«åˆ†é…
    STATUS_RESERVED = 'reserved'  # å·²é¢„ç•™ï¼šæ­£åœ¨ä¸‹è½½ä¸­ï¼Œä¸å¯åˆ†é…
    STATUS_OCCUPIED = 'occupied'  # å·²å ç”¨ï¼šæœ‰å›¾ç‰‡æ˜¾ç¤ºï¼Œä¸å¯åˆ†é…
```

### çŠ¶æ€è½¬æ¢æµç¨‹

```
åˆå§‹åŒ–
  â†“
[EMPTY] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â†“                           â”‚
  åˆ†é…ç»™çº¿ç¨‹                   â”‚
  â†“                           â”‚
[RESERVED] â† (ç«‹å³æ ‡è®°)        â”‚ å¾ªç¯è¦†ç›–
  â†“                           â”‚ (FIFO)
  ä¸‹è½½å®Œæˆï¼ŒåŠ è½½å›¾ç‰‡             â”‚
  â†“                           â”‚
[OCCUPIED]                    â”‚
  â†“                           â”‚
  éœ€è¦è¦†ç›–æ—¶ï¼Œè°ƒç”¨ clear()      â”‚
  â†“                           â”‚
[EMPTY] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ å…³é”®æ–¹æ³•

### 1. `reserve(identifier=None)`

**ä½œç”¨**ï¼šé¢„ç•™æ­¤åŒºåŸŸ

```python
def reserve(self, identifier=None):
    """é¢„ç•™æ­¤åŒºåŸŸ"""
    self.status = self.STATUS_RESERVED
    self.reserved_by = identifier  # è®°å½•é¢„ç•™è€…ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    logger.debug(f"[åŒºåŸŸ{self.index}] å·²é¢„ç•™ by {identifier}")
```

**è°ƒç”¨æ—¶æœº**ï¼šåœ¨ `get_next_widget_for_device` ä¸­ï¼Œåˆ†é…åŒºåŸŸæ—¶ç«‹å³è°ƒç”¨

### 2. `occupy()`

**ä½œç”¨**ï¼šæ ‡è®°ä¸ºå·²å ç”¨

```python
def occupy(self):
    """æ ‡è®°ä¸ºå·²å ç”¨"""
    self.status = self.STATUS_OCCUPIED
    self.reserved_by = None
    logger.debug(f"[åŒºåŸŸ{self.index}] å·²å ç”¨")
```

**è°ƒç”¨æ—¶æœº**ï¼šåœ¨ `load_original_image` ä¸­ï¼Œå›¾ç‰‡åŠ è½½å®Œæˆåè°ƒç”¨

### 3. `is_available()`

**ä½œç”¨**ï¼šæ£€æŸ¥æ˜¯å¦å¯ç”¨

```python
def is_available(self):
    """æ˜¯å¦å¯ç”¨ï¼ˆç©ºé—²çŠ¶æ€ï¼‰"""
    return self.status == self.STATUS_EMPTY
```

**è°ƒç”¨æ—¶æœº**ï¼šåœ¨ `get_next_widget_for_device` ä¸­ï¼ŒæŸ¥æ‰¾å¯ç”¨åŒºåŸŸæ—¶è°ƒç”¨

### 4. `clear()`

**ä½œç”¨**ï¼šæ¸…ç©ºæ˜¾ç¤ºï¼Œé‡ç½®ä¸ºç©ºé—²çŠ¶æ€

```python
def clear(self):
    """æ¸…ç©ºæ˜¾ç¤º"""
    self.original_label.clear()
    self.recognized_label.clear()
    self.original_image_path = None
    self.recognized_image_path = None
    
    # âœ… é‡ç½®çŠ¶æ€ä¸ºç©ºé—²
    self.status = self.STATUS_EMPTY
    self.reserved_by = None
    
    self.filename_label.setText("--")
    self.status_label.setText("ç­‰å¾…æ•°æ®...")
```

**è°ƒç”¨æ—¶æœº**ï¼šåœ¨ FIFO å¾ªç¯è¦†ç›–æ—¶è°ƒç”¨

---

## ğŸ² åŒºåŸŸåˆ†é…ç­–ç•¥

### `get_next_widget_for_device(device_tab)`

ä¸‰ä¸ªç­–ç•¥æŒ‰ä¼˜å…ˆçº§ä¾æ¬¡æ‰§è¡Œï¼š

#### **ç­–ç•¥1ï¼šæŸ¥æ‰¾ç©ºé—²åŒºåŸŸ**

```python
# âœ… ä¼˜å…ˆæŸ¥æ‰¾ç¬¬ä¸€ä¸ªç©ºé—²åŒºåŸŸ
for widget in image_widgets:
    if widget.is_available():  # status == 'empty'
        widget.reserve(f"è®¾å¤‡{device_tab.device_id}")  # ç«‹å³æ ‡è®°ä¸ºé¢„ç•™
        return widget
```

**ä¼˜ç‚¹**ï¼š
- å……åˆ†åˆ©ç”¨å·²æœ‰åŒºåŸŸ
- é¿å…ä¸å¿…è¦çš„åŒºåŸŸåˆ›å»º
- çŠ¶æ€æ£€æŸ¥æ¯”ç´¢å¼•è®¡ç®—æ›´å‡†ç¡®

#### **ç­–ç•¥2ï¼šæ·»åŠ æ–°åŒºåŸŸ**

```python
# âœ… å¦‚æœæ²¡æœ‰ç©ºé—²åŒºåŸŸï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥æ·»åŠ æ–°åŒºåŸŸ
if len(image_widgets) < self.max_widget_count:
    index = len(image_widgets)
    row = index // 2
    col = index % 2
    
    display_widget = ImageDisplayWidget(index)
    display_widget.reserve(f"è®¾å¤‡{device_tab.device_id}")  # ç«‹å³æ ‡è®°
    
    image_widgets.append(display_widget)
    grid_layout.addWidget(display_widget, row, col)
    
    return display_widget
```

**è§¦å‘æ¡ä»¶**ï¼š
- æ‰€æœ‰ç°æœ‰åŒºåŸŸéƒ½ä¸æ˜¯ç©ºé—²çŠ¶æ€ï¼ˆRESERVED æˆ– OCCUPIEDï¼‰
- åŒºåŸŸæ€»æ•° < 20ï¼ˆæœ€å¤§é™åˆ¶ï¼‰

#### **ç­–ç•¥3ï¼šFIFO å¾ªç¯è¦†ç›–**

```python
# âœ… è¾¾åˆ°æœ€å¤§æ•°é‡ï¼Œä½¿ç”¨FIFOå¾ªç¯è¦†ç›–
widget_index = device_tab.next_index % len(image_widgets)
widget = image_widgets[widget_index]

logger.info(f"[è®¾å¤‡{device_tab.device_id}] FIFOè¦†ç›–åŒºåŸŸ {widget_index}")

# æ¸…ç©ºå¹¶é¢„ç•™
widget.clear()  # é‡ç½®ä¸º EMPTY
widget.reserve(f"è®¾å¤‡{device_tab.device_id}")  # æ ‡è®°ä¸º RESERVED

# æ›´æ–°ç´¢å¼•
device_tab.next_index += 1

return widget
```

**è§¦å‘æ¡ä»¶**ï¼š
- æ‰€æœ‰åŒºåŸŸéƒ½ä¸æ˜¯ç©ºé—²çŠ¶æ€
- å·²è¾¾åˆ°æœ€å¤§åŒºåŸŸæ•°é‡ï¼ˆ20ä¸ªï¼‰

**FIFOé€»è¾‘**ï¼š
- ä½¿ç”¨ `next_index % len(image_widgets)` å¾ªç¯
- è¦†ç›–æœ€æ—§çš„åŒºåŸŸ
- `next_index` æŒç»­é€’å¢

---

## ğŸ”’ çº¿ç¨‹å®‰å…¨ä¿è¯

### æ•´ä¸ªæ–¹æ³•åŠ é”

```python
def get_next_widget_for_device(self, device_tab):
    with self.widget_access_lock:  # æ•´ä¸ªæ–¹æ³•åŠ é”
        # ç­–ç•¥1: æŸ¥æ‰¾ç©ºé—²åŒºåŸŸ
        # ç­–ç•¥2: æ·»åŠ æ–°åŒºåŸŸ
        # ç­–ç•¥3: FIFO å¾ªç¯è¦†ç›–
        
        # ç«‹å³æ ‡è®°ä¸º RESERVED
        widget.reserve(...)
        
        return widget
```

### åŸå­æ“ä½œä¿è¯

- **æŸ¥æ‰¾ + æ ‡è®°** åœ¨åŒä¸€ä¸ªé”å†…å®Œæˆ
- **è¯»å–çŠ¶æ€ + ä¿®æ”¹çŠ¶æ€** ä¸å¯åˆ†å‰²
- **è¿”å›åŒºåŸŸæ—¶å·²æ ‡è®°ä¸ºé¢„ç•™**ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•å†ä½¿ç”¨

---

## ğŸ“‹ å®Œæ•´æ‰§è¡Œæµç¨‹

### å¤šçº¿ç¨‹åœºæ™¯

```
æ—¶åˆ»1: çº¿ç¨‹Aè¿›å…¥ get_next_widget_for_device
       [é”å®š]
       â†’ æŸ¥æ‰¾ç©ºé—²åŒºåŸŸï¼Œæ‰¾åˆ°åŒºåŸŸ0 (status=EMPTY)
       â†’ widget[0].reserve("è®¾å¤‡001")  # status=RESERVED
       â†’ è¿”å› widget[0]
       [é‡Šæ”¾é”]

æ—¶åˆ»2: çº¿ç¨‹Bè¿›å…¥ get_next_widget_for_device
       [ç­‰å¾…é”...]
       [é”å®š]
       â†’ æŸ¥æ‰¾ç©ºé—²åŒºåŸŸï¼Œè·³è¿‡åŒºåŸŸ0 (status=RESERVED)
       â†’ æ‰¾åˆ°åŒºåŸŸ1 (status=EMPTY)
       â†’ widget[1].reserve("è®¾å¤‡001")  # status=RESERVED
       â†’ è¿”å› widget[1]
       [é‡Šæ”¾é”]

æ—¶åˆ»3: çº¿ç¨‹Aä¸‹è½½å®Œæˆ
       â†’ load_original_image(image_path)
       â†’ widget[0].occupy()  # status=OCCUPIED

æ—¶åˆ»4: çº¿ç¨‹Cè¿›å…¥ get_next_widget_for_device
       [é”å®š]
       â†’ æŸ¥æ‰¾ç©ºé—²åŒºåŸŸï¼Œè·³è¿‡åŒºåŸŸ0 (OCCUPIED)ï¼Œè·³è¿‡åŒºåŸŸ1 (RESERVED)
       â†’ æ‰¾åˆ°åŒºåŸŸ2 (status=EMPTY)
       â†’ widget[2].reserve("è®¾å¤‡001")
       â†’ è¿”å› widget[2]
       [é‡Šæ”¾é”]

æ—¶åˆ»5: çº¿ç¨‹Bä¸‹è½½å®Œæˆ
       â†’ load_original_image(image_path)
       â†’ widget[1].occupy()  # status=OCCUPIED
```

### ç»“æœ

```
åŒºåŸŸ0: RESERVED â†’ OCCUPIED  âœ…
åŒºåŸŸ1: RESERVED â†’ OCCUPIED  âœ…
åŒºåŸŸ2: RESERVED â†’ (ç­‰å¾…ä¸‹è½½å®Œæˆ)  âœ…
```

**æ²¡æœ‰å†²çªï¼Œæ²¡æœ‰è¦†ç›–ï¼**

---

## ğŸ†š å¯¹æ¯”ï¼šæ—§æ–¹æ¡ˆ vs æ–°æ–¹æ¡ˆ

### æ—§æ–¹æ¡ˆï¼ˆç´¢å¼•é€’å¢ï¼‰

```python
# âŒ é—®é¢˜ï¼šä¾èµ– next_indexï¼ŒçŠ¶æ€ä¸æ˜ç¡®
next_index = device_tab.next_index
widget = image_widgets[next_index % len(image_widgets)]

# å¯èƒ½è¢«è¦†ç›–ï¼Œå› ä¸ºçŠ¶æ€ä¸æ¸…æ¥š
if widget.original_image_path:
    widget.clear()

device_tab.next_index += 1
return widget
```

**ç¼ºç‚¹**ï¼š
- å³ä½¿åŠ é”ï¼Œ`next_index` ä¹Ÿå¯èƒ½è·³å·æˆ–é‡å¤
- æ— æ³•åŒºåˆ†"æ­£åœ¨ä¸‹è½½"å’Œ"å·²ä¸‹è½½"çš„åŒºåŸŸ
- å¾ªç¯è¦†ç›–æ—¶å¯èƒ½è¦†ç›–æ­£åœ¨ä¸‹è½½çš„åŒºåŸŸ

### æ–°æ–¹æ¡ˆï¼ˆçŠ¶æ€æ ‡è®°ï¼‰

```python
# âœ… ä¼˜åŠ¿ï¼šæ˜ç¡®çš„çŠ¶æ€ç®¡ç†
for widget in image_widgets:
    if widget.is_available():  # æ£€æŸ¥çŠ¶æ€
        widget.reserve(...)  # ç«‹å³æ ‡è®°
        return widget

# æˆ–æ·»åŠ æ–°åŒºåŸŸ
if len(image_widgets) < max_count:
    widget = create_new_widget()
    widget.reserve(...)
    return widget

# æˆ–FIFOå¾ªç¯è¦†ç›–
widget = image_widgets[next_index % len(image_widgets)]
widget.clear()  # é‡ç½®ä¸º EMPTY
widget.reserve(...)  # æ ‡è®°ä¸º RESERVED
return widget
```

**ä¼˜ç‚¹**ï¼š
- çŠ¶æ€æ˜ç¡®ï¼Œä¸ä¼šè¯¯ç”¨æ­£åœ¨ä¸‹è½½çš„åŒºåŸŸ
- ä¼˜å…ˆä½¿ç”¨ç©ºé—²åŒºåŸŸï¼Œå‡å°‘ä¸å¿…è¦çš„è¦†ç›–
- çº¿ç¨‹å®‰å…¨ï¼Œé˜²æ­¢ç«äº‰

---

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

### 1. **ç«‹å³æ ‡è®°**
- åˆ†é…åŒºåŸŸæ—¶ï¼Œç«‹å³è°ƒç”¨ `widget.reserve()`
- çŠ¶æ€ä» `EMPTY` å˜ä¸º `RESERVED`
- å…¶ä»–çº¿ç¨‹æ— æ³•å†è·å–æ­¤åŒºåŸŸ

### 2. **çŠ¶æ€é©±åŠ¨**
- ä¸å†ä¾èµ– `next_index` æ¥åˆ¤æ–­å“ªä¸ªåŒºåŸŸå¯ç”¨
- é€šè¿‡ `widget.is_available()` ç›´æ¥æŸ¥è¯¢çŠ¶æ€
- æ›´å‡†ç¡®ã€æ›´å¯é 

### 3. **ä¼˜å…ˆç­–ç•¥**
- ä¼˜å…ˆä½¿ç”¨ç©ºé—²åŒºåŸŸï¼ˆç­–ç•¥1ï¼‰
- å…¶æ¬¡æ·»åŠ æ–°åŒºåŸŸï¼ˆç­–ç•¥2ï¼‰
- æœ€åå¾ªç¯è¦†ç›–ï¼ˆç­–ç•¥3ï¼‰
- å……åˆ†åˆ©ç”¨èµ„æºï¼Œé¿å…æµªè´¹

### 4. **è°ƒè¯•å‹å¥½**
- `reserved_by` å±æ€§è®°å½•é¢„ç•™è€…
- è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- æ–¹ä¾¿æ’æŸ¥é—®é¢˜

---

## ğŸ“Š çŠ¶æ€ç»Ÿè®¡ç¤ºä¾‹

### æŸä¸€æ—¶åˆ»çš„çŠ¶æ€åˆ†å¸ƒ

```
è®¾å¤‡001:
  åŒºåŸŸ0: OCCUPIED (å›¾ç‰‡A.jpg)
  åŒºåŸŸ1: RESERVED (æ­£åœ¨ä¸‹è½½B.jpg)
  åŒºåŸŸ2: OCCUPIED (å›¾ç‰‡C.jpg)
  åŒºåŸŸ3: EMPTY
  åŒºåŸŸ4: EMPTY
  åŒºåŸŸ5: RESERVED (æ­£åœ¨ä¸‹è½½D.jpg)
  åŒºåŸŸ6: OCCUPIED (å›¾ç‰‡E.jpg)
  åŒºåŸŸ7: EMPTY

ä¸‹ä¸€ä¸ªè¯·æ±‚ä¼šåˆ†é…ï¼šåŒºåŸŸ3 (ç¬¬ä¸€ä¸ªç©ºé—²åŒºåŸŸ)
```

---

## âœ… è§£å†³äº†å“ªäº›é—®é¢˜

### é—®é¢˜1ï¼š`next_index` æ··ä¹± (0, 1, 1, 0)
**åŸå› **ï¼šå¤šçº¿ç¨‹ç«äº‰ï¼Œç´¢å¼•æ›´æ–°ä¸åŒæ­¥  
**è§£å†³**ï¼šä¸å†ä¾èµ–ç´¢å¼•ï¼Œä½¿ç”¨çŠ¶æ€æ ‡è®°

### é—®é¢˜2ï¼šå¤šä¸ªçº¿ç¨‹è·å–åŒä¸€åŒºåŸŸ
**åŸå› **ï¼šåˆ†é…å’Œæ ‡è®°ä¸æ˜¯åŸå­æ“ä½œ  
**è§£å†³**ï¼šåœ¨é”å†…ç«‹å³æ ‡è®°ä¸º `RESERVED`

### é—®é¢˜3ï¼šè¦†ç›–æ­£åœ¨ä¸‹è½½çš„åŒºåŸŸ
**åŸå› **ï¼šæ— æ³•åŒºåˆ†"ä¸‹è½½ä¸­"å’Œ"å·²ä¸‹è½½"  
**è§£å†³**ï¼š`RESERVED` çŠ¶æ€è¡¨ç¤ºä¸‹è½½ä¸­ï¼Œä¸ä¼šè¢«è¦†ç›–

### é—®é¢˜4ï¼šä¸å……åˆ†åˆ©ç”¨ç©ºé—²åŒºåŸŸ
**åŸå› **ï¼šåªæŒ‰ `next_index` é¡ºåºåˆ†é…  
**è§£å†³**ï¼šä¼˜å…ˆæŸ¥æ‰¾æ‰€æœ‰ç©ºé—²åŒºåŸŸ

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæœºåˆ¶
1. **çŠ¶æ€æšä¸¾**ï¼šEMPTY / RESERVED / OCCUPIED
2. **ç«‹å³æ ‡è®°**ï¼šåˆ†é…æ—¶ç«‹å³ `reserve()`
3. **çŠ¶æ€é©±åŠ¨**ï¼šåŸºäº `is_available()` è€Œä¸æ˜¯ç´¢å¼•
4. **ä¸‰ç­–ç•¥åˆ†é…**ï¼šç©ºé—² â†’ æ–°å¢ â†’ FIFO

### çº¿ç¨‹å®‰å…¨
- æ•´ä¸ªæ–¹æ³•åŠ é”
- æŸ¥æ‰¾ + æ ‡è®° åŸå­æ“ä½œ
- çŠ¶æ€æ£€æŸ¥å’Œä¿®æ”¹åœ¨åŒä¸€é”å†…

### ä¼˜åŠ¿
- âœ… é¿å…åŒºåŸŸå†²çª
- âœ… å……åˆ†åˆ©ç”¨ç©ºé—²åŒºåŸŸ
- âœ… æ˜ç¡®çš„çŠ¶æ€ç®¡ç†
- âœ… è°ƒè¯•å‹å¥½
- âœ… çº¿ç¨‹å®‰å…¨

ç°åœ¨ä¸ä¼šå†å‡ºç° `next_index` æ··ä¹±å’ŒåŒºåŸŸè¦†ç›–çš„é—®é¢˜äº†ï¼ğŸ‰

