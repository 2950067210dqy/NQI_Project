# å‡ ä½•é‡ç•Œé¢ - ç®€åŒ–ç‰ˆåŒºåŸŸç®¡ç†æ–¹æ¡ˆ

## ğŸ¯ æ–°æ–¹æ¡ˆæ ¸å¿ƒæ€æƒ³

**æŒ‰éœ€åˆ›å»ºï¼ŒFIFOç®¡ç†**

1. **åˆå§‹çŠ¶æ€**ï¼šä¸åˆ›å»ºä»»ä½•åŒºåŸŸ
2. **ä¸‹è½½å®Œæˆ**ï¼šåˆ›å»ºæ–°åŒºåŸŸå¹¶æ˜¾ç¤ºå›¾ç‰‡
3. **è¾¾åˆ°ä¸Šé™ï¼ˆ20ä¸ªï¼‰**ï¼šFIFOå‰ç§»æ‰€æœ‰å›¾ç‰‡ï¼Œæ–°å›¾ç‰‡æ”¾åœ¨æœ€å

---

## âœ… æ–¹æ¡ˆä¼˜åŠ¿

### 1. **ç®€å•ç›´æ¥**
- ä¸éœ€è¦çŠ¶æ€æšä¸¾ï¼ˆempty/reserved/occupiedï¼‰
- ä¸éœ€è¦æŸ¥æ‰¾ç©ºé—²åŒºåŸŸ
- ä¸éœ€è¦é¢„ç•™æœºåˆ¶
- é€»è¾‘æ¸…æ™°æ˜“æ‡‚

### 2. **é¿å…ç«æ€**
- æ¯æ¬¡ä¸‹è½½å®Œæˆéƒ½åˆ›å»ºæ–°åŒºåŸŸï¼ˆæˆ–FIFOï¼‰
- ä¸ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€åŒºåŸŸ
- ä¸ä¼šæœ‰å›¾ç‰‡è¦†ç›–é—®é¢˜

### 3. **å†…å­˜é«˜æ•ˆ**
- æŒ‰éœ€åˆ›å»ºï¼Œä¸æµªè´¹èµ„æº
- æœ€å¤š20ä¸ªåŒºåŸŸï¼Œå†…å­˜å¯æ§

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. `create_device_image_tab`

**åˆå§‹åŒ–ä¸åˆ›å»ºä»»ä½•åŒºåŸŸ**

```python
def create_device_image_tab(self, device_id: str) -> QWidget:
    """ä¸ºè®¾å¤‡åˆ›å»ºå›¾ç‰‡æ˜¾ç¤ºé€‰é¡¹å¡"""
    tab = QWidget()
    # ... åˆ›å»ºå¸ƒå±€
    
    # âœ… åˆå§‹ä¸ºç©ºï¼ŒåŠ¨æ€æ·»åŠ 
    tab.image_widgets = []  # ç©ºåˆ—è¡¨
    tab.grid_layout = grid_layout
    
    return tab
```

---

### 2. `get_next_widget_for_device`

**ä¸¤ä¸ªç­–ç•¥ï¼šåˆ›å»ºæ–°åŒºåŸŸ æˆ– FIFOå‰ç§»**

```python
def get_next_widget_for_device(self, device_tab):
    """ä¸ºè®¾å¤‡è·å–ä¸‹ä¸€ä¸ªæ˜¾ç¤ºåŒºåŸŸ"""
    with self.widget_access_lock:
        image_widgets = device_tab.image_widgets
        current_count = len(image_widgets)
        
        # âœ… ç­–ç•¥1: æœªè¾¾åˆ°æœ€å¤§æ•°é‡ï¼ˆ20ï¼‰ï¼Œåˆ›å»ºæ–°åŒºåŸŸ
        if current_count < self.max_widget_count:
            index = current_count
            row = index // 2
            col = index % 2
            
            display_widget = ImageDisplayWidget(index)
            image_widgets.append(display_widget)
            grid_layout.addWidget(display_widget, row, col)
            
            return display_widget
        
        # âœ… ç­–ç•¥2: è¾¾åˆ°æœ€å¤§æ•°é‡ï¼ŒFIFOå‰ç§»
        # å°†åŒºåŸŸ1çš„å›¾ç‰‡ç§»åˆ°åŒºåŸŸ0
        # å°†åŒºåŸŸ2çš„å›¾ç‰‡ç§»åˆ°åŒºåŸŸ1
        # ...
        # å°†åŒºåŸŸ19çš„å›¾ç‰‡ç§»åˆ°åŒºåŸŸ18
        # æ¸…ç©ºåŒºåŸŸ19ï¼Œå‡†å¤‡æ¥æ”¶æ–°å›¾ç‰‡
        for i in range(self.max_widget_count - 1):
            source = image_widgets[i + 1]
            target = image_widgets[i]
            
            if source.original_image_path:
                target.load_original_image(source.original_image_path)
            else:
                target.clear()
        
        # è¿”å›æœ€åä¸€ä¸ªåŒºåŸŸ
        last_widget = image_widgets[self.max_widget_count - 1]
        last_widget.clear()
        return last_widget
```

---

## ğŸ“Š æ‰§è¡Œæµç¨‹

### å‰20å¼ å›¾ç‰‡ï¼ˆåˆ›å»ºé˜¶æ®µï¼‰

```
å›¾ç‰‡1: [é”å®š] åˆ›å»ºåŒºåŸŸ0 â†’ åŠ è½½å›¾ç‰‡1 [é‡Šæ”¾é”]
       åŒºåŸŸ: [å›¾1]

å›¾ç‰‡2: [é”å®š] åˆ›å»ºåŒºåŸŸ1 â†’ åŠ è½½å›¾ç‰‡2 [é‡Šæ”¾é”]
       åŒºåŸŸ: [å›¾1][å›¾2]

å›¾ç‰‡3: [é”å®š] åˆ›å»ºåŒºåŸŸ2 â†’ åŠ è½½å›¾ç‰‡3 [é‡Šæ”¾é”]
       åŒºåŸŸ: [å›¾1][å›¾2][å›¾3]

...

å›¾ç‰‡20: [é”å®š] åˆ›å»ºåŒºåŸŸ19 â†’ åŠ è½½å›¾ç‰‡20 [é‡Šæ”¾é”]
        åŒºåŸŸ: [å›¾1][å›¾2][å›¾3]...[å›¾20]
```

### ç¬¬21å¼ å›¾ç‰‡å¼€å§‹ï¼ˆFIFOé˜¶æ®µï¼‰

```
å›¾ç‰‡21: [é”å®š]
        1. åŒºåŸŸ1å›¾ç‰‡ â†’ åŒºåŸŸ0 (å›¾2è¦†ç›–å›¾1)
        2. åŒºåŸŸ2å›¾ç‰‡ â†’ åŒºåŸŸ1 (å›¾3è¦†ç›–å›¾2)
        3. ...
        4. åŒºåŸŸ19å›¾ç‰‡ â†’ åŒºåŸŸ18 (å›¾20è¦†ç›–å›¾19)
        5. æ¸…ç©ºåŒºåŸŸ19 â†’ åŠ è½½å›¾ç‰‡21
        [é‡Šæ”¾é”]
        åŒºåŸŸ: [å›¾2][å›¾3][å›¾4]...[å›¾21]

å›¾ç‰‡22: [é”å®š]
        1. FIFOå‰ç§»
        2. åŠ è½½å›¾ç‰‡22åˆ°åŒºåŸŸ19
        [é‡Šæ”¾é”]
        åŒºåŸŸ: [å›¾3][å›¾4][å›¾5]...[å›¾22]
```

---

## ğŸ”’ çº¿ç¨‹å®‰å…¨

### ä¸¤å¤„åŠ é”

#### 1. `get_or_create_device_image_tab`
- é˜²æ­¢é‡å¤åˆ›å»ºè®¾å¤‡é€‰é¡¹å¡
- ç¡®ä¿æŸ¥æ‰¾å’Œåˆ›å»ºæ˜¯åŸå­æ“ä½œ

#### 2. `get_next_widget_for_device`
- é˜²æ­¢å¤šçº¿ç¨‹åŒæ—¶åˆ›å»ºåŒºåŸŸ
- FIFOå‰ç§»æ˜¯åŸå­æ“ä½œï¼Œä¸ä¼šè¢«æ‰“æ–­

### é”çš„ä½œç”¨èŒƒå›´

```python
with self.widget_access_lock:
    # åˆ›å»ºåŒºåŸŸ æˆ– FIFOå‰ç§»
    # æ•´ä¸ªè¿‡ç¨‹ä¸å¯åˆ†å‰²
    pass
```

---

## ğŸ¨ UIå±•ç¤ºæ•ˆæœ

### åˆå§‹çŠ¶æ€ï¼ˆ0ä¸ªåŒºåŸŸï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡: 12323                      â”‚
â”‚ æ¥æ”¶æ—¶é—´: --                     â”‚
â”‚ å›¾ç‰‡æ•°é‡: 0                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  â”‚
â”‚    (ç©ºç™½ï¼Œç­‰å¾…æ•°æ®)               â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¥æ”¶4å¼ å›¾ç‰‡åï¼ˆ4ä¸ªåŒºåŸŸï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡: 12323                      â”‚
â”‚ æ¥æ”¶æ—¶é—´: 2025-12-12 04:48:06   â”‚
â”‚ å›¾ç‰‡æ•°é‡: 4                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ ä½ç½®1   â”‚  â”‚ ä½ç½®2   â”‚       â”‚
â”‚  â”‚ å›¾ç‰‡1   â”‚  â”‚ å›¾ç‰‡2   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ ä½ç½®3   â”‚  â”‚ ä½ç½®4   â”‚       â”‚
â”‚  â”‚ å›¾ç‰‡3   â”‚  â”‚ å›¾ç‰‡4   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¥æ”¶20å¼ å›¾ç‰‡åï¼ˆæ»¡ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡: 12323                      â”‚
â”‚ æ¥æ”¶æ—¶é—´: 2025-12-12 04:48:10   â”‚
â”‚ å›¾ç‰‡æ•°é‡: 20                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å›¾1][å›¾2]  [å›¾3][å›¾4]         â”‚
â”‚  [å›¾5][å›¾6]  [å›¾7][å›¾8]         â”‚
â”‚  [å›¾9][å›¾10] [å›¾11][å›¾12]       â”‚
â”‚  ...                             â”‚
â”‚  [å›¾17][å›¾18] [å›¾19][å›¾20]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¥æ”¶ç¬¬21å¼ å›¾ç‰‡ï¼ˆFIFOï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡: 12323                      â”‚
â”‚ æ¥æ”¶æ—¶é—´: 2025-12-12 04:48:11   â”‚
â”‚ å›¾ç‰‡æ•°é‡: 20                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å›¾2][å›¾3]  [å›¾4][å›¾5]  â† å‰ç§»â”‚
â”‚  [å›¾6][å›¾7]  [å›¾8][å›¾9]         â”‚
â”‚  [å›¾10][å›¾11] [å›¾12][å›¾13]      â”‚
â”‚  ...                             â”‚
â”‚  [å›¾18][å›¾19] [å›¾20][å›¾21] â† æ–°â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å…³é”®ä»£ç å˜æ›´

### ç§»é™¤çš„å†…å®¹

- âŒ `STATUS_EMPTY / RESERVED / OCCUPIED` çŠ¶æ€æšä¸¾
- âŒ `reserve()` æ–¹æ³•
- âŒ `occupy()` æ–¹æ³•
- âŒ `is_available()` æ–¹æ³•
- âŒ åˆå§‹åˆ›å»º8ä¸ªåŒºåŸŸçš„ä»£ç 
- âŒ æŸ¥æ‰¾ç©ºé—²åŒºåŸŸçš„é€»è¾‘
- âŒ `next_index` ç´¢å¼•ç®¡ç†

### æ–°å¢çš„å†…å®¹

- âœ… åˆå§‹ `image_widgets = []` ç©ºåˆ—è¡¨
- âœ… æŒ‰éœ€åˆ›å»ºåŒºåŸŸé€»è¾‘
- âœ… FIFOå‰ç§»é€»è¾‘
- âœ… ç®€åŒ–çš„æ—¥å¿—è¾“å‡º

---

## ğŸ†š å¯¹æ¯”ï¼šæ—§æ–¹æ¡ˆ vs æ–°æ–¹æ¡ˆ

### æ—§æ–¹æ¡ˆï¼ˆçŠ¶æ€ç®¡ç†ï¼‰

```python
# åˆå§‹åŒ–
image_widgets = [widget0, widget1, ..., widget7]  # 8ä¸ªç©ºåŒºåŸŸ
widget.status = 'empty'

# æŸ¥æ‰¾ç©ºé—²åŒºåŸŸ
for widget in image_widgets:
    if widget.is_available():  # status == 'empty'
        widget.reserve()  # status = 'reserved'
        return widget

# åŠ è½½å®Œæˆ
widget.occupy()  # status = 'occupied'
```

**é—®é¢˜**ï¼š
- çŠ¶æ€ç®¡ç†å¤æ‚
- å¤šçº¿ç¨‹ç«æ€é—®é¢˜
- é‡å¤åˆ›å»ºtabé—®é¢˜
- éš¾ä»¥è°ƒè¯•

### æ–°æ–¹æ¡ˆï¼ˆæŒ‰éœ€åˆ›å»ºï¼‰

```python
# åˆå§‹åŒ–
image_widgets = []  # ç©ºåˆ—è¡¨

# åˆ›å»ºæ–°åŒºåŸŸ
if len(image_widgets) < 20:
    widget = create_new_widget()
    image_widgets.append(widget)
    return widget

# FIFOå‰ç§»
for i in range(19):
    image_widgets[i].load_image(image_widgets[i+1].image_path)
return image_widgets[19]
```

**ä¼˜ç‚¹**ï¼š
- é€»è¾‘ç®€å•æ¸…æ™°
- æ²¡æœ‰ç«æ€é—®é¢˜
- æ²¡æœ‰çŠ¶æ€ç®¡ç†
- æ˜“äºç†è§£å’Œç»´æŠ¤

---

## âœ… æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼š4å¼ å›¾ç‰‡åŒæ—¶ä¸‹è½½

```
é¢„æœŸç»“æœï¼š
åŒºåŸŸ0: å›¾ç‰‡1 âœ…
åŒºåŸŸ1: å›¾ç‰‡2 âœ…
åŒºåŸŸ2: å›¾ç‰‡3 âœ…
åŒºåŸŸ3: å›¾ç‰‡4 âœ…
æ€»åŒºåŸŸæ•°: 4
```

### åœºæ™¯2ï¼š21å¼ å›¾ç‰‡

```
é¢„æœŸç»“æœï¼š
åŒºåŸŸ0: å›¾ç‰‡2  (å›¾ç‰‡1è¢«æŒ¤å‡º)
åŒºåŸŸ1: å›¾ç‰‡3
...
åŒºåŸŸ18: å›¾ç‰‡20
åŒºåŸŸ19: å›¾ç‰‡21
æ€»åŒºåŸŸæ•°: 20
```

### åœºæ™¯3ï¼šå¤šè®¾å¤‡

```
è®¾å¤‡001: 10ä¸ªåŒºåŸŸ
è®¾å¤‡002: 15ä¸ªåŒºåŸŸ
è®¾å¤‡003: 20ä¸ªåŒºåŸŸ

æ¯ä¸ªè®¾å¤‡ç‹¬ç«‹ç®¡ç†ï¼Œäº’ä¸å½±å“ âœ…
```

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **ç§»é™¤çŠ¶æ€ç®¡ç†**ï¼šä¸éœ€è¦ empty/reserved/occupied
2. **æŒ‰éœ€åˆ›å»º**ï¼šä»0å¼€å§‹ï¼Œéœ€è¦æ—¶æ‰åˆ›å»º
3. **FIFOç®€å•**ï¼šç›´æ¥å‰ç§»ï¼Œé€»è¾‘æ¸…æ™°
4. **çº¿ç¨‹å®‰å…¨**ï¼šä¸¤å¤„åŠ é”ï¼Œé¿å…ç«æ€

### ä»£ç é‡

- **æ—§æ–¹æ¡ˆ**ï¼š~200è¡Œ (çŠ¶æ€ç®¡ç† + æŸ¥æ‰¾é€»è¾‘)
- **æ–°æ–¹æ¡ˆ**ï¼š~50è¡Œ (åˆ›å»º + FIFO)

**å‡å°‘75%ä»£ç ï¼Œæé«˜100%å¯é æ€§ï¼**

ç°åœ¨ä¸ä¼šå†æœ‰å›¾ç‰‡è¦†ç›–ã€åŒºåŸŸæ··ä¹±çš„é—®é¢˜äº†ï¼ğŸ‰

