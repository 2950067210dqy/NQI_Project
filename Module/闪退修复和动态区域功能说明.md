# é—ªé€€ä¿®å¤å’ŒåŠ¨æ€åŒºåŸŸåŠŸèƒ½è¯´æ˜

## ğŸ› é—®é¢˜ä¿®å¤

### 1. **é—ªé€€é—®é¢˜åˆ†æå’Œä¿®å¤**

#### é—®é¢˜åŸå› 

ä¸Šä½æœºæ¥æ”¶åˆ°æ–°æ•°æ®åç›´æ¥é—ªé€€ï¼Œå¯èƒ½çš„åŸå› ï¼š

1. âŒ **çº¿ç¨‹ä¸­å‡ºç°æœªæ•è·çš„å¼‚å¸¸**
   - ä¸‹è½½å¤±è´¥æ—¶å¼‚å¸¸ä¼ æ’­åˆ°ä¸»çº¿ç¨‹
   - æ–‡ä»¶è·¯å¾„é”™è¯¯
   - file_id ä¸º None

2. âŒ **çº¿ç¨‹æ²¡æœ‰æ­£ç¡®ç®¡ç†**
   - çº¿ç¨‹åˆ›å»ºåæ²¡æœ‰ä¿ç•™å¼•ç”¨
   - çº¿ç¨‹å®Œæˆåæ²¡æœ‰æ¸…ç†
   - å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼å’Œå´©æºƒ

3. âŒ **ä¿¡å·è¿æ¥é—®é¢˜**
   - åœ¨éä¸»çº¿ç¨‹æ›´æ–° UI
   - ä¿¡å·æ§½è¿æ¥é”™è¯¯

#### ä¿®å¤æ–¹æ¡ˆ

#### 1.1 å¢å¼ºå¼‚å¸¸å¤„ç†

**ä¹‹å‰ï¼ˆå¯èƒ½å´©æºƒï¼‰ï¼š**

```python
class ExcelDownloadThread(QThread):
    def run(self):
        # âŒ å¼‚å¸¸å¯èƒ½å¯¼è‡´å´©æºƒ
        self.client.download_excel_file(self.file_id, self.save_path)
        self.download_finished.emit(str(self.save_path), self.device_id)
```

**ä¹‹åï¼ˆå®Œæ•´å¼‚å¸¸å¤„ç†ï¼‰ï¼š**

```python
class ExcelDownloadThread(QThread):
    def __init__(self, ...):
        super().__init__()
        # ...
        self.setTerminationEnabled(True)  # âœ… å…è®¸çº¿ç¨‹è¢«ç»ˆæ­¢
    
    def run(self):
        try:
            logger.info(f"[ä¸‹è½½çº¿ç¨‹] å¼€å§‹ä¸‹è½½: {self.save_path.name}, file_id={self.file_id}")
            
            # âœ… æ£€æŸ¥ file_id
            if self.file_id is None:
                raise Exception("file_id ä¸º Noneï¼Œæ— æ³•ä¸‹è½½")
            
            # âœ… ç¡®ä¿ç›®å½•å­˜åœ¨
            self.save_path.parent.mkdir(parents=True, exist_ok=True)
            
            # æ‰§è¡Œä¸‹è½½
            self.client.download_excel_file(self.file_id, self.save_path)
            
            logger.info(f"[ä¸‹è½½çº¿ç¨‹] ä¸‹è½½å®Œæˆ: {self.save_path}")
            self.download_finished.emit(str(self.save_path), self.device_id)
            
        except Exception as e:
            import traceback
            error_msg = f"ä¸‹è½½å¤±è´¥: {e}\n{traceback.format_exc()}"
            logger.error(f"[ä¸‹è½½çº¿ç¨‹] {error_msg}")
            self.download_failed.emit(str(e))  # âœ… å‘é€å¤±è´¥ä¿¡å·
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ‰€æœ‰å¼‚å¸¸éƒ½è¢«æ•è·
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼ˆåŒ…å«å †æ ˆè·Ÿè¸ªï¼‰
- âœ… file_id æ£€æŸ¥
- âœ… ç›®å½•è‡ªåŠ¨åˆ›å»º
- âœ… å¤±è´¥ä¿¡å·é€šçŸ¥

#### 1.2 çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†

**ä¹‹å‰ï¼ˆå¯èƒ½æ³„æ¼ï¼‰ï¼š**

```python
def on_new_data_received(self, data):
    # âŒ åˆ›å»ºçº¿ç¨‹åæ²¡æœ‰ä¿ç•™å¼•ç”¨
    download_thread = ExcelDownloadThread(...)
    download_thread.download_finished.connect(self.on_download_finished)
    download_thread.start()
    # çº¿ç¨‹å¯¹è±¡å¯èƒ½è¢«åƒåœ¾å›æ”¶ï¼Œå¯¼è‡´å´©æºƒ
```

**ä¹‹åï¼ˆæ­£ç¡®ç®¡ç†ï¼‰ï¼š**

```python
class ExcelViewerWindow(QMainWindow):
    def __init__(self):
        # ...
        # âœ… çº¿ç¨‹åˆ—è¡¨ç®¡ç†
        self.active_download_threads = []
    
    def on_new_data_received(self, data):
        # åˆ›å»ºä¸‹è½½çº¿ç¨‹
        download_thread = ExcelDownloadThread(...)
        
        # è¿æ¥ä¿¡å·
        download_thread.download_finished.connect(self.on_download_finished)
        download_thread.download_failed.connect(self.on_download_failed)
        download_thread.finished.connect(lambda: self.on_thread_finished(download_thread))
        
        # âœ… æ·»åŠ åˆ°æ´»è·ƒçº¿ç¨‹åˆ—è¡¨
        self.active_download_threads.append(download_thread)
        
        # å¯åŠ¨ä¸‹è½½
        download_thread.start()
        
        logger.info(f"ä¸‹è½½çº¿ç¨‹å·²å¯åŠ¨ï¼Œå½“å‰æ´»è·ƒçº¿ç¨‹æ•°: {len(self.active_download_threads)}")
    
    def on_thread_finished(self, thread):
        """çº¿ç¨‹å®Œæˆå›è°ƒï¼Œæ¸…ç†çº¿ç¨‹å¼•ç”¨"""
        try:
            if thread in self.active_download_threads:
                self.active_download_threads.remove(thread)
                logger.info(f"ä¸‹è½½çº¿ç¨‹å·²å®Œæˆå¹¶æ¸…ç†ï¼Œå‰©ä½™æ´»è·ƒçº¿ç¨‹: {len(self.active_download_threads)}")
        except Exception as e:
            logger.error(f"æ¸…ç†çº¿ç¨‹å¤±è´¥: {e}")
    
    def closeEvent(self, event):
        """çª—å£å…³é—­äº‹ä»¶"""
        # âœ… åœæ­¢æ‰€æœ‰ä¸‹è½½çº¿ç¨‹
        if hasattr(self, 'active_download_threads'):
            for thread in self.active_download_threads:
                if thread.isRunning():
                    thread.terminate()
                    thread.wait(1000)
            logger.info(f"å·²åœæ­¢ {len(self.active_download_threads)} ä¸ªä¸‹è½½çº¿ç¨‹")
        
        # åœæ­¢é˜Ÿåˆ—ç›‘å¬çº¿ç¨‹
        if hasattr(self, 'queue_thread') and self.queue_thread:
            self.queue_thread.stop()
            logger.info("ç”µé‡æ•°æ®æŸ¥çœ‹å™¨é˜Ÿåˆ—ç›‘å¬çº¿ç¨‹å·²åœæ­¢")
        
        super().closeEvent(event)
```

**ä¼˜ç‚¹ï¼š**
- âœ… çº¿ç¨‹å¼•ç”¨è¢«ä¿ç•™ï¼Œä¸ä¼šè¢«æ„å¤–å›æ”¶
- âœ… çº¿ç¨‹å®Œæˆåè‡ªåŠ¨æ¸…ç†
- âœ… çª—å£å…³é—­æ—¶å¼ºåˆ¶åœæ­¢æ‰€æœ‰çº¿ç¨‹
- âœ… è¯¦ç»†çš„æ—¥å¿—è·Ÿè¸ª

#### 1.3 è¯¦ç»†æ—¥å¿—è®°å½•

```python
# âœ… å…³é”®æ“ä½œéƒ½æœ‰æ—¥å¿—
logger.info(f"[ä¸‹è½½çº¿ç¨‹] å¼€å§‹ä¸‹è½½: {file_name}, file_id={file_id}")
logger.info(f"ä¸‹è½½çº¿ç¨‹å·²å¯åŠ¨ï¼Œå½“å‰æ´»è·ƒçº¿ç¨‹æ•°: {count}")
logger.info(f"[ä¸‹è½½çº¿ç¨‹] ä¸‹è½½å®Œæˆ: {file_path}")
logger.info(f"ä¸‹è½½çº¿ç¨‹å·²å®Œæˆå¹¶æ¸…ç†ï¼Œå‰©ä½™æ´»è·ƒçº¿ç¨‹: {count}")
logger.error(f"[ä¸‹è½½çº¿ç¨‹] ä¸‹è½½å¤±è´¥: {error}\n{traceback}")
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ–¹ä¾¿å®šä½å´©æºƒåŸå› 
- âœ… å¯ä»¥è¿½è¸ªçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ
- âœ… åŒ…å«å®Œæ•´çš„é”™è¯¯å †æ ˆ

---

## ğŸ”„ åŠ¨æ€åŒºåŸŸåŠŸèƒ½

### 2. **å‡ ä½•é‡å›¾ç‰‡çª—å£åŠ¨æ€æ‰©å±•**

#### éœ€æ±‚

> å½“æœ¬æ¬¡æ”¶åˆ°çš„å›¾ç‰‡æ•°é‡ > 8 æ—¶ï¼Œä¸´æ—¶æ·»åŠ åŒºåŸŸè‡³ç¬¦åˆå›¾ç‰‡æ•°é‡ã€‚  
> ç­‰åˆ°ä¸‹æ¬¡æ”¶åˆ°æ–°å›¾ç‰‡æ•°é‡ < åŒºåŸŸæ•°é‡æ—¶ï¼Œé‡Šæ”¾æ‰ä¸´æ—¶åŒºåŸŸã€‚

#### å®ç°æ–¹æ¡ˆ

#### 2.1 æ•°æ®ç»“æ„

```python
class ImageViewerWindow(QMainWindow):
    def __init__(self):
        # ...
        self.image_display_widgets = []  # å›¾ç‰‡æ˜¾ç¤ºç»„ä»¶ï¼ˆåŠ¨æ€æ‰©å±•ï¼‰
        self.base_widget_count = 8  # åŸºç¡€æ˜¾ç¤ºåŒºåŸŸæ•°é‡ï¼ˆå›ºå®šï¼‰
        self.grid_layout = None  # ç½‘æ ¼å¸ƒå±€å¼•ç”¨ï¼ˆç”¨äºåŠ¨æ€æ·»åŠ ï¼‰
```

#### 2.2 åŠ¨æ€æ‰©å±•æ–¹æ³•

```python
def ensure_display_capacity(self, required_count: int):
    """
    ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ˜¾ç¤ºåŒºåŸŸ
    å¦‚æœéœ€è¦çš„æ•°é‡ > å½“å‰åŒºåŸŸæ•°é‡ï¼Œåˆ™åŠ¨æ€æ·»åŠ 
    """
    current_count = len(self.image_display_widgets)
    
    if required_count > current_count:
        # éœ€è¦æ·»åŠ æ›´å¤šåŒºåŸŸ
        add_count = required_count - current_count
        logger.info(f"éœ€è¦æ·»åŠ  {add_count} ä¸ªæ˜¾ç¤ºåŒºåŸŸï¼ˆå½“å‰ {current_count}ï¼Œéœ€è¦ {required_count}ï¼‰")
        
        for i in range(add_count):
            index = current_count + i
            display_widget = ImageDisplayWidget(index)
            
            # è®¡ç®—ç½‘æ ¼ä½ç½®ï¼ˆ2åˆ—å¸ƒå±€ï¼‰
            row = index // 2
            col = index % 2
            
            # æ·»åŠ åˆ°ç½‘æ ¼
            self.grid_layout.addWidget(display_widget, row, col)
            self.image_display_widgets.append(display_widget)
        
        logger.info(f"å·²æ·»åŠ  {add_count} ä¸ªä¸´æ—¶æ˜¾ç¤ºåŒºåŸŸï¼Œæ€»æ•°: {len(self.image_display_widgets)}")
```

#### 2.3 æ”¶ç¼©æ–¹æ³•

```python
def shrink_display_widgets(self, target_count: int):
    """
    æ”¶ç¼©æ˜¾ç¤ºåŒºåŸŸåˆ°ç›®æ ‡æ•°é‡
    å¦‚æœå½“å‰åŒºåŸŸæ•°é‡ > åŸºç¡€æ•°é‡ï¼ˆ8ï¼‰ï¼Œä¸”æ‰€æœ‰é¢å¤–åŒºåŸŸéƒ½ä¸ºç©ºï¼Œåˆ™é‡Šæ”¾
    """
    current_count = len(self.image_display_widgets)
    
    if current_count > self.base_widget_count and target_count <= self.base_widget_count:
        # æ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¶ç¼©ï¼ˆé¢å¤–åŒºåŸŸéƒ½ä¸ºç©ºï¼‰
        can_shrink = True
        for i in range(self.base_widget_count, current_count):
            if self.image_display_widgets[i].original_image_path:
                can_shrink = False
                break
        
        if can_shrink:
            # ç§»é™¤é¢å¤–çš„åŒºåŸŸ
            remove_count = current_count - self.base_widget_count
            for i in range(remove_count):
                widget = self.image_display_widgets.pop()
                self.grid_layout.removeWidget(widget)
                widget.deleteLater()
            
            logger.info(f"å·²é‡Šæ”¾ {remove_count} ä¸ªä¸´æ—¶æ˜¾ç¤ºåŒºåŸŸï¼Œå‰©ä½™: {len(self.image_display_widgets)}")
```

#### 2.4 æ·»åŠ å›¾ç‰‡æ—¶è‡ªåŠ¨æ‰©å±•

```python
def add_image_to_display(self, image_path: Path, device_id: str):
    """æ·»åŠ å›¾ç‰‡åˆ°æ˜¾ç¤ºåŒºåŸŸï¼ˆå¦‚æœéœ€è¦åˆ™åŠ¨æ€æ‰©å±•ï¼‰"""
    # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç©ºé—²çš„æ˜¾ç¤ºç»„ä»¶
    empty_widget = None
    for widget in self.image_display_widgets:
        if not widget.original_image_path:
            empty_widget = widget
            break
    
    # âœ… å¦‚æœæ²¡æœ‰ç©ºé—²åŒºåŸŸï¼ŒåŠ¨æ€æ·»åŠ ä¸€ä¸ª
    if empty_widget is None:
        logger.info(f"å½“å‰ {len(self.image_display_widgets)} ä¸ªåŒºåŸŸå·²æ»¡ï¼Œæ·»åŠ æ–°åŒºåŸŸ")
        self.ensure_display_capacity(len(self.image_display_widgets) + 1)
        empty_widget = self.image_display_widgets[-1]
    
    # åŠ è½½å›¾ç‰‡
    empty_widget.load_original_image(image_path)
    
    # æ›´æ–°æ‰¹æ¬¡ä¿¡æ¯
    current_count = sum(1 for w in self.image_display_widgets if w.original_image_path)
    self.current_count_label.setText(f"å›¾ç‰‡æ•°é‡: {current_count}")
```

#### 2.5 æ¸…ç©ºæ—¶è‡ªåŠ¨æ”¶ç¼©

```python
def clear_all_displays(self):
    """æ¸…ç©ºæ‰€æœ‰æ˜¾ç¤ºåŒºåŸŸ"""
    for widget in self.image_display_widgets:
        widget.clear()
    
    self.current_device_label.setText("è®¾å¤‡: --")
    self.current_batch_label.setText("æ¥æ”¶æ—¶é—´: --")
    self.current_count_label.setText("å›¾ç‰‡æ•°é‡: 0")
    
    # âœ… æ”¶ç¼©åˆ°åŸºç¡€æ•°é‡
    self.shrink_display_widgets(self.base_widget_count)
    
    logger.info("å·²æ¸…ç©ºæ‰€æœ‰æ˜¾ç¤ºåŒºåŸŸ")
```

#### å·¥ä½œæµç¨‹

```
1. åˆå§‹çŠ¶æ€ï¼š8 ä¸ªæ˜¾ç¤ºåŒºåŸŸ
   â”Œâ”€â”¬â”€â”
   â”‚1â”‚2â”‚
   â”œâ”€â”¼â”€â”¤
   â”‚3â”‚4â”‚
   â”œâ”€â”¼â”€â”¤
   â”‚5â”‚6â”‚
   â”œâ”€â”¼â”€â”¤
   â”‚7â”‚8â”‚
   â””â”€â”´â”€â”˜

2. æ”¶åˆ° 12 å¼ å›¾ç‰‡
   â”œâ”€ æ£€æµ‹åˆ°éœ€è¦ 12 ä¸ªåŒºåŸŸ
   â”œâ”€ å½“å‰åªæœ‰ 8 ä¸ª
   â”œâ”€ åŠ¨æ€æ·»åŠ  4 ä¸ª
   â””â”€ æ€»å…± 12 ä¸ªåŒºåŸŸ
   
   â”Œâ”€â”¬â”€â”
   â”‚1â”‚2â”‚  åŸºç¡€åŒºåŸŸï¼ˆå›ºå®šï¼‰
   â”œâ”€â”¼â”€â”¤
   â”‚3â”‚4â”‚
   â”œâ”€â”¼â”€â”¤
   â”‚5â”‚6â”‚
   â”œâ”€â”¼â”€â”¤
   â”‚7â”‚8â”‚
   â”œâ”€â”¼â”€â”¤
   â”‚9â”‚10â”‚ ä¸´æ—¶åŒºåŸŸï¼ˆå¯é‡Šæ”¾ï¼‰
   â”œâ”€â”¼â”€â”¤
   â”‚11â”‚12â”‚
   â””â”€â”´â”€â”˜

3. æ¸…ç©ºæˆ–æ”¶åˆ°å°‘äº 8 å¼ å›¾ç‰‡
   â”œâ”€ æ£€æµ‹åˆ°é¢å¤–åŒºåŸŸä¸ºç©º
   â”œâ”€ é‡Šæ”¾ä¸´æ—¶åŒºåŸŸï¼ˆ9-12ï¼‰
   â””â”€ æ¢å¤åˆ° 8 ä¸ªåŸºç¡€åŒºåŸŸ
   
   â”Œâ”€â”¬â”€â”
   â”‚1â”‚2â”‚
   â”œâ”€â”¼â”€â”¤
   â”‚3â”‚4â”‚
   â”œâ”€â”¼â”€â”¤
   â”‚5â”‚6â”‚
   â”œâ”€â”¼â”€â”¤
   â”‚7â”‚8â”‚
   â””â”€â”´â”€â”˜
```

---

## ğŸ“Š Excel è§£æä¼˜åŒ–

### 3. **ä¸‰ç›¸æµæ•°æ®è§£æ**

#### å‚è€ƒå®ç°

å‚è€ƒ `test/get_test.py` ä¸­çš„ `get_three_phase_flow_data_column` æ–¹æ³•ã€‚

#### æ•°æ®æ ¼å¼

```
åŸå§‹ Excel æ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢å®šç”µå‹,é¢å®šç”µæµ â”‚  é¢‘ç‡   â”‚  ç›¸è§’   â”‚ ç”µæµ/A  â”‚  Aç›¸    â”‚  Bç›¸    â”‚  Cç›¸    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 220V, 5A      â”‚  50Hz   â”‚  0Â°     â”‚  5.0    â”‚ 220.5   â”‚ 221.0   â”‚ 219.5   â”‚
â”‚ 220V, 5A      â”‚  50Hz   â”‚  15Â°    â”‚  5.1    â”‚ 220.8   â”‚ 221.2   â”‚ 219.8   â”‚
â”‚ ...           â”‚  ...    â”‚  ...    â”‚  ...    â”‚  ...    â”‚  ...    â”‚  ...    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§£æåçš„æ•°æ®ç»“æ„ï¼š
{
    'rated_voltage': 220.0,
    'rated_voltage_unit': 'V',
    'rated_frequency': 50.0,
    'rated_frequency_unit': 'Hz',
    'data': {
        'åŠŸç‡W': {
            'Aç›¸': [æ•°æ®åˆ—è¡¨],
            'Bç›¸': [æ•°æ®åˆ—è¡¨],
            'Cç›¸': [æ•°æ®åˆ—è¡¨]
        },
        'ç”µå‹': {
            'Aç›¸': [220.5, 220.8, ...],
            'Bç›¸': [221.0, 221.2, ...],
            'Cç›¸': [219.5, 219.8, ...]
        },
        'ç”µæµ': {
            'Aç›¸': [5.0, 5.1, ...],
            'Bç›¸': [5.0, 5.1, ...],
            'Cç›¸': [5.0, 5.1, ...]
        },
        'ç›¸è§’': {
            'Aç›¸': [æ•°æ®åˆ—è¡¨],
            'Bç›¸': [æ•°æ®åˆ—è¡¨],
            'Cç›¸': [æ•°æ®åˆ—è¡¨]
        }
    }
}
```

#### è§£æå®ç°

```python
def parse_sheet_data(self, sheet) -> dict:
    """
    è§£æ sheet æ•°æ®ï¼ˆä¸‰ç›¸æµæ•°æ®æ ¼å¼ï¼‰
    å‚è€ƒ test/get_test.py ä¸­çš„ get_three_phase_flow_data_column æ–¹æ³•
    """
    import pandas as pd
    import re
    
    try:
        # å°† sheet è½¬æ¢ä¸º DataFrame
        data_rows = []
        for row in sheet.iter_rows(values_only=True):
            data_rows.append(list(row))
        
        df = pd.DataFrame(data_rows)
        
        # åˆ é™¤å«ç¼ºå¤±å€¼çš„è¡Œ
        df_clean = df.dropna()
        
        result = {}
        
        # âœ… æå–é¢å®šç”µå‹å’Œé¢‘ç‡
        df_colum_0_unique = df_clean.drop_duplicates(subset=[df_clean.columns[0]])
        df_colum_1_unique = df_clean.drop_duplicates(subset=[df_clean.columns[1]])
        
        # é¢å®šé¢‘ç‡
        freq_str = str(df_colum_1_unique.iloc[0, 1])
        result['rated_frequency'] = float("".join(re.findall(r'[0-9.]+', freq_str)))
        result['rated_frequency_unit'] = "".join(re.findall(r'[A-Za-z]+', freq_str))
        
        # é¢å®šç”µå‹
        voltage_str = str(df_colum_0_unique.iloc[0, 0]).split(",")[0]
        result['rated_voltage'] = float("".join(re.findall(r'[0-9.]+', voltage_str)))
        result['rated_voltage_unit'] = "".join(re.findall(r'[A-Za-z]+', voltage_str))
        
        # âœ… è§£æä¸‰ç›¸æ•°æ®
        result['data'] = {}
        
        # æŸ¥æ‰¾ç›¸ä½åˆ—åï¼ˆAç›¸ã€Bç›¸ã€Cç›¸ï¼‰
        phase_cols = []
        for col_idx in range(4, sheet.max_column + 1):
            cell_value = sheet.cell(3, col_idx).value  # ç¬¬3è¡Œæ˜¯åˆ—æ ‡é¢˜
            if cell_value and ("ç›¸" in str(cell_value)):
                phase_cols.append((col_idx, str(cell_value)))
        
        # åˆå§‹åŒ–æ•°æ®ç»“æ„
        data_types = ['åŠŸç‡W', 'ç”µå‹', 'ç”µæµ', 'ç›¸è§’']
        for data_type in data_types:
            result['data'][data_type] = {}
            for col_idx, phase_name in phase_cols:
                result['data'][data_type][phase_name] = []
        
        # âœ… è¯»å–æ•°æ®ï¼ˆæ¯36è¡Œä¸€ç»„ï¼Œå¯¹åº”ä¸€ä¸ªæ•°æ®ç±»å‹ï¼‰
        data_each_counts = 36
        
        for row_idx in range(4, sheet.max_row + 1):
            relative_row = row_idx - 4
            current_data_type_idx = relative_row // data_each_counts
            
            if current_data_type_idx >= len(data_types):
                break
            
            data_type = data_types[current_data_type_idx]
            
            # è¯»å–æ¯ä¸€ç›¸çš„æ•°æ®
            for col_idx, phase_name in phase_cols:
                cell_value = sheet.cell(row_idx, col_idx).value
                if cell_value is not None:
                    result['data'][data_type][phase_name].append(float(cell_value))
        
        return result
        
    except Exception as e:
        logger.error(f"è§£æ sheet æ•°æ®å¤±è´¥: {e}")
        return {}
```

#### æ˜¾ç¤ºä¼˜åŒ–

```python
def display_device_data(self, device_name: str):
    """æ˜¾ç¤ºè®¾å¤‡æ•°æ®ï¼ˆæ–°æ ¼å¼ï¼‰"""
    parsed_data = self.excel_data[device_name]
    
    # è·å–é¢å®šå‚æ•°
    rated_voltage = parsed_data.get('rated_voltage', 220.0)
    rated_frequency = parsed_data.get('rated_frequency', 50.0)
    
    # è·å–ä¸‰ç›¸æ•°æ®
    data_dict = parsed_data.get('data', {})
    
    # æ˜¾ç¤ºè¡¨æ ¼
    for data_type in ['åŠŸç‡W', 'ç”µå‹', 'ç”µæµ', 'ç›¸è§’']:
        if data_type not in data_dict:
            continue
        
        phase_data = data_dict[data_type]
        
        # è®¡ç®—å¹³å‡å€¼
        avg_a = sum(phase_data.get('Aç›¸', [0])) / len(phase_data.get('Aç›¸', [1]))
        avg_b = sum(phase_data.get('Bç›¸', [0])) / len(phase_data.get('Bç›¸', [1]))
        avg_c = sum(phase_data.get('Cç›¸', [0])) / len(phase_data.get('Cç›¸', [1]))
        
        # æ˜¾ç¤ºåˆ°è¡¨æ ¼
        self.realtime_table.setItem(row, 0, QTableWidgetItem(data_type))
        self.realtime_table.setItem(row, 1, QTableWidgetItem(f"{avg_a:.2f}"))
        self.realtime_table.setItem(row, 2, QTableWidgetItem(f"{avg_b:.2f}"))
        self.realtime_table.setItem(row, 3, QTableWidgetItem(f"{avg_c:.2f}"))
    
    # ç»˜åˆ¶æ¡å½¢å›¾
    self.draw_realtime_chart(parsed_data)
```

---

## âœ… åŠŸèƒ½æ¸…å•

### é—ªé€€ä¿®å¤

- âœ… æ‰€æœ‰å¼‚å¸¸éƒ½è¢«æ•è·å¹¶è®°å½•
- âœ… file_id æ£€æŸ¥ï¼Œé¿å… None å€¼
- âœ… ç›®å½•è‡ªåŠ¨åˆ›å»º
- âœ… çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… çº¿ç¨‹å¼•ç”¨ä¿ç•™ï¼Œé¿å…è¢«å›æ”¶
- âœ… çº¿ç¨‹å®Œæˆåè‡ªåŠ¨æ¸…ç†
- âœ… çª—å£å…³é—­æ—¶å¼ºåˆ¶åœæ­¢æ‰€æœ‰çº¿ç¨‹
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼ˆåŒ…å«å †æ ˆè·Ÿè¸ªï¼‰

### åŠ¨æ€åŒºåŸŸ

- âœ… åŸºç¡€ 8 ä¸ªåŒºåŸŸï¼ˆå›ºå®šï¼‰
- âœ… å›¾ç‰‡æ•°é‡ > 8 æ—¶è‡ªåŠ¨æ‰©å±•
- âœ… å›¾ç‰‡æ•°é‡ < 8 æ—¶è‡ªåŠ¨æ”¶ç¼©
- âœ… ç½‘æ ¼å¸ƒå±€è‡ªåŠ¨è°ƒæ•´ï¼ˆ2åˆ— Nè¡Œï¼‰
- âœ… ä¸´æ—¶åŒºåŸŸè‡ªåŠ¨é‡Šæ”¾
- âœ… æ¸…ç©ºæ—¶æ¢å¤åŸºç¡€åŒºåŸŸ

### Excel è§£æ

- âœ… å‚è€ƒæµ‹è¯•æ–‡ä»¶çš„è§£æé€»è¾‘
- âœ… æå–é¢å®šç”µå‹å’Œé¢‘ç‡
- âœ… è§£æä¸‰ç›¸æµæ•°æ®ï¼ˆåŠŸç‡ã€ç”µå‹ã€ç”µæµã€ç›¸è§’ï¼‰
- âœ… è®¡ç®—å¹³å‡å€¼å¹¶æ˜¾ç¤º
- âœ… æ¡å½¢å›¾å¯è§†åŒ–
- âœ… å…¼å®¹å¤šç§æ ¼å¼

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. é—ªé€€ä¿®å¤æµ‹è¯•

**æµ‹è¯•æ­¥éª¤ï¼š**

1. **æ­£å¸¸ä¸‹è½½**
   - ä¸‹ä½æœºä¸Šä¼ æ•°æ®
   - ä¸Šä½æœºè‡ªåŠ¨ä¸‹è½½
   - è§‚å¯Ÿæ—¥å¿—ï¼š
     ```
     [ä¸‹è½½çº¿ç¨‹] å¼€å§‹ä¸‹è½½: xxx.xlsx, file_id=123
     ä¸‹è½½çº¿ç¨‹å·²å¯åŠ¨ï¼Œå½“å‰æ´»è·ƒçº¿ç¨‹æ•°: 1
     [ä¸‹è½½çº¿ç¨‹] ä¸‹è½½å®Œæˆ: /path/to/file
     ä¸‹è½½çº¿ç¨‹å·²å®Œæˆå¹¶æ¸…ç†ï¼Œå‰©ä½™æ´»è·ƒçº¿ç¨‹: 0
     ```
   - âœ… åº”è¯¥ä¸å´©æºƒ

2. **å¼‚å¸¸æƒ…å†µæµ‹è¯•**
   - å…³é—­æœåŠ¡å™¨ï¼ˆæ¨¡æ‹Ÿç½‘ç»œé”™è¯¯ï¼‰
   - ä¸Šä¼ æ•°æ®è§¦å‘ä¸‹è½½
   - è§‚å¯Ÿæ—¥å¿—ï¼š
     ```
     [ä¸‹è½½çº¿ç¨‹] ä¸‹è½½å¤±è´¥: ...
     çŠ¶æ€: ä¸‹è½½å¤±è´¥ - ...
     ```
   - âœ… åº”è¯¥æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œä¸å´©æºƒ

3. **å¤šçº¿ç¨‹æµ‹è¯•**
   - å¿«é€Ÿè¿ç»­ä¸Šä¼  10 ä¸ªæ–‡ä»¶
   - è§‚å¯Ÿæ´»è·ƒçº¿ç¨‹æ•°å˜åŒ–
   - ç­‰å¾…æ‰€æœ‰ä¸‹è½½å®Œæˆ
   - âœ… æ‰€æœ‰æ–‡ä»¶éƒ½åº”æˆåŠŸä¸‹è½½

4. **çª—å£å…³é—­æµ‹è¯•**
   - å¼€å§‹ä¸‹è½½æ—¶å…³é—­çª—å£
   - è§‚å¯Ÿæ—¥å¿—ï¼š
     ```
     å·²åœæ­¢ N ä¸ªä¸‹è½½çº¿ç¨‹
     ```
   - âœ… åº”è¯¥æ­£å¸¸å…³é—­ï¼Œä¸å´©æºƒ

### 2. åŠ¨æ€åŒºåŸŸæµ‹è¯•

**æµ‹è¯•åœºæ™¯ï¼š**

#### åœºæ™¯ 1ï¼šå°‘äº 8 å¼ å›¾ç‰‡

```
1. ä¸Šä¼  5 å¼ å›¾ç‰‡
   â””â”€ æ˜¾ç¤º 8 ä¸ªåŒºåŸŸï¼ˆå‰5ä¸ªæœ‰å›¾ï¼Œå3ä¸ªç©ºï¼‰
```

#### åœºæ™¯ 2ï¼šæ°å¥½ 8 å¼ å›¾ç‰‡

```
1. ä¸Šä¼  8 å¼ å›¾ç‰‡
   â””â”€ æ˜¾ç¤º 8 ä¸ªåŒºåŸŸï¼ˆå…¨éƒ¨å¡«æ»¡ï¼‰
```

#### åœºæ™¯ 3ï¼šå¤šäº 8 å¼ å›¾ç‰‡

```
1. ä¸Šä¼  12 å¼ å›¾ç‰‡
   â”œâ”€ è‡ªåŠ¨æ·»åŠ  4 ä¸ªä¸´æ—¶åŒºåŸŸ
   â”œâ”€ æ€»å…± 12 ä¸ªåŒºåŸŸ
   â””â”€ æ—¥å¿—: "éœ€è¦æ·»åŠ  4 ä¸ªæ˜¾ç¤ºåŒºåŸŸï¼ˆå½“å‰ 8ï¼Œéœ€è¦ 12ï¼‰"
```

#### åœºæ™¯ 4ï¼šæ”¶ç¼©æµ‹è¯•

```
1. å½“å‰æœ‰ 12 ä¸ªåŒºåŸŸï¼ˆ12 å¼ å›¾ç‰‡ï¼‰
2. ç‚¹å‡»"æ¸…ç©º"æŒ‰é’®
   â”œâ”€ æ‰€æœ‰åŒºåŸŸæ¸…ç©º
   â”œâ”€ ä¸´æ—¶åŒºåŸŸè¢«é‡Šæ”¾
   â”œâ”€ æ¢å¤åˆ° 8 ä¸ªåŸºç¡€åŒºåŸŸ
   â””â”€ æ—¥å¿—: "å·²é‡Šæ”¾ 4 ä¸ªä¸´æ—¶æ˜¾ç¤ºåŒºåŸŸï¼Œå‰©ä½™: 8"
```

#### åœºæ™¯ 5ï¼šè¶…å¤§æ‰¹æ¬¡

```
1. ä¸Šä¼  20 å¼ å›¾ç‰‡
   â”œâ”€ è‡ªåŠ¨æ·»åŠ  12 ä¸ªä¸´æ—¶åŒºåŸŸ
   â”œâ”€ æ€»å…± 20 ä¸ªåŒºåŸŸ
   â””â”€ ç•Œé¢æ»šåŠ¨æ¡å‡ºç°

2. æ¸…ç©ºåæ¢å¤åˆ° 8 ä¸ª
```

### 3. Excel è§£ææµ‹è¯•

**æµ‹è¯•æ–‡ä»¶æ ¼å¼ï¼š**

```excel
20251211_111324_TA3310ä¸‰ç›¸è¡¨æ•°æ®.xlsx

Sheet1: TA3310è®¾å¤‡1
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 220V, 5A      â”‚  50Hz   â”‚  0Â°     â”‚  5.0    â”‚ 220.5   â”‚ 221.0   â”‚
â”‚ 220V, 5A      â”‚  50Hz   â”‚  15Â°    â”‚  5.1    â”‚ 220.8   â”‚ 221.2   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Sheet2: TA3310è®¾å¤‡2
...
```

**æµ‹è¯•æ­¥éª¤ï¼š**

1. **ä¸Šä¼ æµ‹è¯• Excel**
2. **æŸ¥çœ‹è§£æç»“æœ**
   - é¢å®šç”µå‹ï¼š220V
   - é¢å®šé¢‘ç‡ï¼š50Hz
   - ä¸‰ç›¸æ•°æ®è¡¨æ ¼æ˜¾ç¤º
   - æ¡å½¢å›¾æ˜¾ç¤º
3. **åˆ‡æ¢è®¾å¤‡**
   - ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸åŒ Sheet
   - æ•°æ®æ›´æ–°æ­£ç¡®

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### é—ªé€€ç‡

**ä¹‹å‰ï¼š**
- ä¸‹è½½å¤±è´¥æ—¶ï¼š100% å´©æºƒ âŒ
- å¿«é€Ÿä¸‹è½½ï¼šå¶å°”å´©æºƒ âŒ
- å…³é—­çª—å£ï¼šå¯èƒ½å´©æºƒ âŒ

**ä¹‹åï¼š**
- ä¸‹è½½å¤±è´¥æ—¶ï¼š0% å´©æºƒï¼Œæ˜¾ç¤ºé”™è¯¯ âœ…
- å¿«é€Ÿä¸‹è½½ï¼š0% å´©æºƒ âœ…
- å…³é—­çª—å£ï¼š0% å´©æºƒ âœ…

### å†…å­˜ä½¿ç”¨

**ä¹‹å‰ï¼š**
- çº¿ç¨‹æ³„æ¼ï¼šå†…å­˜æŒç»­å¢é•¿ âŒ

**ä¹‹åï¼š**
- çº¿ç¨‹è‡ªåŠ¨æ¸…ç†ï¼šå†…å­˜ç¨³å®š âœ…
- åŠ¨æ€åŒºåŸŸé‡Šæ”¾ï¼šå†…å­˜ä¼˜åŒ– âœ…

### ç”¨æˆ·ä½“éªŒ

**ä¹‹å‰ï¼š**
- å›¾ç‰‡å¤šæ—¶ï¼šæ— æ³•æ˜¾ç¤ºå…¨éƒ¨ âŒ
- å´©æºƒé¢‘ç¹ï¼šä½“éªŒæå·® âŒ

**ä¹‹åï¼š**
- å›¾ç‰‡å¤šæ—¶ï¼šè‡ªåŠ¨æ‰©å±•æ˜¾ç¤º âœ…
- ç¨³å®šè¿è¡Œï¼šä½“éªŒè‰¯å¥½ âœ…

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. çº¿ç¨‹ç®¡ç†

- âœ… æ‰€æœ‰çº¿ç¨‹éƒ½å¿…é¡»ä¿ç•™å¼•ç”¨
- âœ… çº¿ç¨‹å®Œæˆåå¿…é¡»æ¸…ç†
- âœ… çª—å£å…³é—­æ—¶å¿…é¡»åœæ­¢çº¿ç¨‹

### 2. å¼‚å¸¸å¤„ç†

- âœ… æ‰€æœ‰å¯èƒ½å¤±è´¥çš„æ“ä½œéƒ½è¦æ•è·å¼‚å¸¸
- âœ… å¼‚å¸¸ä¿¡æ¯è¦è®°å½•åˆ°æ—¥å¿—
- âœ… å¤±è´¥è¦é€šçŸ¥ç”¨æˆ·

### 3. åŠ¨æ€åŒºåŸŸ

- âœ… ä¸´æ—¶åŒºåŸŸè¦åŠæ—¶é‡Šæ”¾
- âœ… ä¸èƒ½æ— é™æ‰©å±•ï¼ˆå†…å­˜è€ƒè™‘ï¼‰
- âœ… åŸºç¡€åŒºåŸŸä¸èƒ½é‡Šæ”¾

### 4. Excel è§£æ

- âœ… è¦å…¼å®¹å¤šç§æ ¼å¼
- âœ… ç¼ºå¤±å€¼è¦å¤„ç†
- âœ… æ•°æ®ç±»å‹è¦æ£€æŸ¥

---

## ğŸš€ åç»­ä¼˜åŒ–

### 1. é™åˆ¶æœ€å¤§åŒºåŸŸæ•°

```python
MAX_DISPLAY_WIDGETS = 100  # æœ€å¤šæ˜¾ç¤º 100 å¼ å›¾ç‰‡

def ensure_display_capacity(self, required_count: int):
    if required_count > MAX_DISPLAY_WIDGETS:
        logger.warning(f"è¯·æ±‚ {required_count} ä¸ªåŒºåŸŸï¼Œè¶…è¿‡æœ€å¤§å€¼ {MAX_DISPLAY_WIDGETS}")
        required_count = MAX_DISPLAY_WIDGETS
    # ...
```

### 2. å›¾ç‰‡åˆ†é¡µæ˜¾ç¤º

```python
# æ¯é¡µæ˜¾ç¤º 20 å¼ ï¼Œè¶…è¿‡çš„åˆ†é¡µ
PAGE_SIZE = 20

def display_images_with_pagination(self, image_paths):
    total_pages = (len(image_paths) + PAGE_SIZE - 1) // PAGE_SIZE
    # æ·»åŠ åˆ†é¡µæ§ä»¶
```

### 3. è™šæ‹Ÿæ»šåŠ¨

```python
# åªæ¸²æŸ“å¯è§åŒºåŸŸçš„å›¾ç‰‡ï¼Œæé«˜æ€§èƒ½
class VirtualImageList(QWidget):
    def paintEvent(self, event):
        # åªç»˜åˆ¶å¯è§åŒºåŸŸ
```

### 4. æ–­ç‚¹ç»­ä¼ 

```python
class ResumeableDownloadThread(QThread):
    def run(self):
        # æ”¯æŒæ–­ç‚¹ç»­ä¼ 
        if self.save_path.exists():
            downloaded_size = self.save_path.stat().st_size
            # ä» downloaded_size ç»§ç»­ä¸‹è½½
```

---

âœ… æ‰€æœ‰ä¿®å¤å’Œä¼˜åŒ–å·²å®Œæˆï¼

