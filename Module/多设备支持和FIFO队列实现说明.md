# 多设备支持和FIFO队列实现说明

## 🎯 实现的功能

### 1. **服务器端 - 通知暂存机制** ✅

#### 需求
当下位机上传数据时，如果没有上位机在线，需要暂存通知，等上位机连接后再发送。

#### 实现

```python
class WebSocketManager:
    def __init__(self):
        self.active_connections = {}
        
        # ✅ 通知暂存
        self.pending_notifications: List[dict] = []
        self.max_pending_notifications = 100  # 最多暂存100条
    
    async def broadcast_notification(self, payload: dict):
        """广播通知"""
        # ✅ 检查是否有上位机连接
        has_upper_client = any(
            meta.get("client_type") == "upper" 
            for meta in self.active_connections.values()
        )
        
        # ✅ 如果没有上位机连接，暂存通知
        if not has_upper_client:
            self.pending_notifications.append(payload)
            if len(self.pending_notifications) > self.max_pending_notifications:
                self.pending_notifications.pop(0)  # 移除最旧的
            logger.info(f"No upper client, notification saved. Pending: {len(self.pending_notifications)}")
            return
        
        # 发送通知...
    
    async def connect(self, websocket: WebSocket, client_type: str, device_id: Optional[str] = None):
        """接受连接"""
        await websocket.accept()
        # ...
        
        # ✅ 如果是上位机连接，发送所有暂存的通知
        if client_type == "upper":
            await self.send_pending_notifications(websocket, device_id)
    
    async def send_pending_notifications(self, websocket: WebSocket, device_filter: Optional[str] = None):
        """发送暂存的通知给新连接的上位机"""
        if not self.pending_notifications:
            return
        
        sent_count = 0
        for notification in self.pending_notifications:
            # 如果有设备过滤，只发送匹配的通知
            if device_filter and notification.get("device_id") != device_filter:
                continue
            
            await websocket.send_json(notification)
            sent_count += 1
        
        logger.info(f"Sent {sent_count} pending notifications to new upper client")
        
        # 清空已发送的通知
        self.pending_notifications.clear()
```

**工作流程：**

```
场景：上位机离线时下位机上传数据

1. 下位机上传 Excel 文件
   ↓
2. 服务器收到文件
   ↓
3. 检查是否有上位机连接
   ├─ 没有连接 → 暂存通知 ✅
   └─ pending_notifications.append(notification)
   
... 稍后 ...

4. 上位机上线并连接 WebSocket
   ↓
5. 服务器发送所有暂存的通知 ✅
   ├─ notification 1
   ├─ notification 2
   └─ notification 3
   ↓
6. 上位机自动下载并显示数据 ✅
```

---

### 2. **电量界面 - 多设备选项卡** ✅

#### 界面结构

```
┌────────────────────────────────────────────────────────────┐
│ [设备1] [设备2] [设备3]                                    │ ← 设备选项卡
├────────────────────────────────────────────────────────────┤
│ 设备ID: device_001                                         │
│ 接收时间: 2025-12-12 14:30:00                             │
│ 额定电压: 220.0V  额定功率: 53.0Hz                        │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ [功率W] [电压] [电流] [相角]                          │ │ ← 数据类型子选项卡
│ ├────────────────────────────────────────────────────────┤ │
│ │                                                        │ │
│ │  功率W - 堆叠柱状图                                     │ │
│ │  ┌──────────────────────────────────────────────────┐ │ │
│ │  │  电量数据                                        │ │ │
│ │  │  -电量配置-   ▓▓ ▓▓ ▓▓                         │ │ │
│ │  │  额定电压     ▒▒ ▒▒ ▒▒                         │ │ │
│ │  │  220.0V      A相 B相 C相                        │ │ │
│ │  │  额定功率                                        │ │ │
│ │  │  53.0Hz      图例：                              │ │ │
│ │  │              A相TK3330   (深红)                 │ │ │
│ │  └──────────────A相TD3310R (浅红)─────────────────┘ │ │
│ │                 B相TK3330   (深青)                   │ │
│ │                 B相TD3310R (浅青)                   │ │
│ │                 C相TK3330   (深黄)                   │ │
│ │                 C相TD3310R (浅黄)                   │ │
│ └────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

#### 实现特点

- ✅ **外层设备选项卡** - 每个设备一个选项卡
- ✅ **内层数据类型选项卡** - 功率W、电压、电流、相角
- ✅ **堆叠柱状图** - 每相一根柱子，设备堆叠
- ✅ **颜色方案**
  - A相：红色系（深红 #FF6B6B → 浅红 #FF9999）
  - B相：青色系（深青 #4ECDC4 → 浅青 #7FE5DC）
  - C相：黄色系（深黄 #FFD93D → 浅黄 #FFE66D）
- ✅ **图例位置** - 放在图外面（右侧），不遮挡图表

#### 代码实现

```python
def create_device_tab_content(self, device_id: str) -> QWidget:
    """为设备创建选项卡内容"""
    tab = QWidget()
    layout = QVBoxLayout(tab)
    
    # 设备信息
    info_group = QGroupBox("设备信息")
    # ...
    
    # 数据类型子选项卡
    data_type_tabs = QTabWidget()
    
    for data_type in ['功率W', '电压', '电流', '相角']:
        type_widget = QWidget()
        # 创建图表
        figure = Figure(figsize=(12, 6))
        canvas = FigureCanvas(figure)
        # ...
        data_type_tabs.addTab(type_widget, data_type)
    
    layout.addWidget(data_type_tabs)
    
    return tab

def load_excel_file(self, file_path: str, device_id: str = ""):
    """加载 Excel 文件"""
    # 解析数据
    sheet_data = self.parse_sheet_data_new(sheet)
    
    # ✅ 创建或更新设备选项卡
    tab_index = self.find_device_tab(device_id)
    if tab_index == -1:
        device_tab = self.create_device_tab_content(device_id)
        tab_index = self.device_tabs.addTab(device_tab, device_id)
    
    # 切换到该设备
    self.device_tabs.setCurrentIndex(tab_index)
    
    # 绘制图表
    for data_type_item in sheet_data.data:
        self.draw_single_chart(data_type_item, ...)
```

---

### 3. **几何量界面 - 多设备选项卡** ✅

#### 界面结构

```
┌────────────────────────────────────────────────────────────┐
│ [设备1] [设备2] [设备3]                                    │ ← 设备选项卡
├────────────────────────────────────────────────────────────┤
│ 设备: device_001                                           │
│ 最后接收: 2025-12-12 14:30:00                             │
│ 图片数量: 12/20                                            │
│ ┌─┬─┬─┬─┐                                                 │
│ │1│2│3│4│  基础区域（1-8）                                │
│ ├─┼─┼─┼─┤                                                 │
│ │5│6│7│8│                                                  │
│ ├─┼─┼─┼─┤                                                 │
│ │9│10│11│12│ 扩展区域（9-20）                            │
│ ├─┼─┼─┼─┤                                                 │
│ │13│14│15│16│                                             │
│ ├─┼─┼─┼─┤                                                 │
│ │17│18│19│20│                                             │
│ └─┴─┴─┴─┘                                                 │
└────────────────────────────────────────────────────────────┘
```

#### 实现特点

- ✅ **外层设备选项卡** - 每个设备独立的选项卡
- ✅ **FIFO队列管理** - 按顺序填充，循环覆盖
- ✅ **动态扩展** - 从8个扩展到最多20个
- ✅ **循环覆盖** - 超过20个后从第1个开始覆盖

---

### 4. **FIFO队列管理详解** ✅

#### 核心逻辑

```python
# 不再使用预留机制，改为FIFO队列
self.next_widget_index = 0  # 下一个要使用的索引

def get_next_widget_for_device(self, device_tab):
    """获取下一个显示区域"""
    next_index = device_tab.next_index
    image_widgets = device_tab.image_widgets
    
    # 1. 如果需要新区域且未达到上限（20个）
    if next_index >= len(image_widgets) and len(image_widgets) < 20:
        # 添加新区域
        display_widget = ImageDisplayWidget(len(image_widgets))
        image_widgets.append(display_widget)
        grid_layout.addWidget(display_widget, row, col)
    
    # 2. 获取区域（循环使用）
    widget_index = next_index % len(image_widgets)
    widget = image_widgets[widget_index]
    
    # 3. 如果区域已有图片，先清空（循环覆盖）
    if widget.original_image_path:
        widget.clear()
    
    # 4. 更新索引
    device_tab.next_index += 1
    
    return widget
```

#### 工作流程

**场景 1：少量图片（≤ 8张）**

```
收到图片1 → next_index=0 → 使用区域0 → next_index=1
收到图片2 → next_index=1 → 使用区域1 → next_index=2
...
收到图片8 → next_index=7 → 使用区域7 → next_index=8

结果：使用了8个基础区域
┌─┬─┬─┬─┐
│1│2│3│4│
├─┼─┼─┼─┤
│5│6│7│8│
└─┴─┴─┴─┘
```

**场景 2：中等数量（8-20张）**

```
收到图片1-8 → 使用区域0-7
收到图片9  → next_index=8 → 添加区域8 → next_index=9
收到图片10 → next_index=9 → 添加区域9 → next_index=10
...
收到图片15 → next_index=14 → 添加区域14 → next_index=15

结果：扩展到15个区域
┌─┬─┬─┬─┐
│1│2│3│4│  基础（1-8）
├─┼─┼─┼─┤
│5│6│7│8│
├─┼─┼─┼─┤
│9│10│11│12│ 扩展（9-15）
├─┼─┼─┼─┤
│13│14│15│ │
└─┴─┴─┴─┘
```

**场景 3：大量图片（> 20张）**

```
收到图片1-20 → 使用区域0-19 → 达到上限（20个）
收到图片21 → next_index=20 → widget_index=20%20=0 → 覆盖区域0 ✅
收到图片22 → next_index=21 → widget_index=21%20=1 → 覆盖区域1 ✅
收到图片23 → next_index=22 → widget_index=22%20=2 → 覆盖区域2 ✅
...

结果：循环覆盖，始终保持20个区域
┌─┬─┬─┬─┐
│21│22│23│24│  被覆盖的区域（原来是1-4）
├─┼─┼─┼─┤
│5│6│7│8│   未被覆盖
├─┼─┼─┼─┤
│9│10│11│12│ 未被覆盖
├─┼─┼─┼─┤
│13│14│15│16│ 未被覆盖
├─┼─┼─┼─┤
│17│18│19│20│ 未被覆盖
└─┴─┴─┴─┘

继续收到图片...
收到图片41 → widget_index=41%20=1 → 覆盖区域1（第二轮覆盖）
```

---

## 🎨 界面展示

### 电量界面 - 多设备

```
┌────────────────────────────────────────────────────────────┐
│ 电量数据查看器                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ [实时数据] [历史数据]                                  │ │
│ ├────────────────────────────────────────────────────────┤ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ [device_001] [device_002] [device_003]            │ │ │ ← 设备选项卡
│ │ ├────────────────────────────────────────────────────┤ │ │
│ │ │ 设备ID: device_001                                │ │ │
│ │ │ 接收时间: 2025-12-12 14:30:00                    │ │ │
│ │ │ 额定电压: 220.0V  额定功率: 53.0Hz               │ │ │
│ │ │ ┌────────────────────────────────────────────────┐│ │ │
│ │ │ │ [功率W] [电压] [电流] [相角]                  ││ │ │ ← 数据类型子选项卡
│ │ │ ├────────────────────────────────────────────────┤│ │ │
│ │ │ │                                                ││ │ │
│ │ │ │  功率W - 堆叠柱状图                             ││ │ │
│ │ │ │  电量数据                                      ││ │ │
│ │ │ │  -电量配置-   ▓▓ ▓▓ ▓▓                       ││ │ │
│ │ │ │  额定电压     ▒▒ ▒▒ ▒▒                       ││ │ │
│ │ │ │  220.0V      A相 B相 C相                      ││ │ │
│ │ │ │  额定功率     0,0.5  60,0.5  ...              ││ │ │
│ │ │ │  53.0Hz                                        ││ │ │
│ │ │ │                         图例（右侧）：          ││ │ │
│ │ │ │                         A相TK3330   ▒          ││ │ │
│ │ │ │                         A相TD3310R ▓          ││ │ │
│ │ │ │                         B相TK3330   ▒          ││ │ │
│ │ │ │                         B相TD3310R ▓          ││ │ │
│ │ │ │                         C相TK3330   ▒          ││ │ │
│ │ │ │                         C相TD3310R ▓          ││ │ │
│ │ │ └────────────────────────────────────────────────┘│ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

**颜色方案：**

| 相位 | 设备1（深色） | 设备2（浅色） |
|------|--------------|--------------|
| A相  | #FF6B6B（深红）| #FF9999（浅红）|
| B相  | #4ECDC4（深青）| #7FE5DC（浅青）|
| C相  | #FFD93D（深黄）| #FFE66D（浅黄）|

**图例位置：**
```python
# 图例放在图外面（右侧）
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5), fontsize=8)
```

---

### 几何量界面 - 多设备 + FIFO队列

```
┌────────────────────────────────────────────────────────────┐
│ 几何量数据查看器                                            │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ [实时识别] [历史识别]                                  │ │
│ ├────────────────────────────────────────────────────────┤ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ [device_001] [device_002] [device_003]            │ │ │ ← 设备选项卡
│ │ ├────────────────────────────────────────────────────┤ │ │
│ │ │ 设备: device_001                                  │ │ │
│ │ │ 最后接收: 2025-12-12 14:30:45                    │ │ │
│ │ │ 图片数量: 12/20                                   │ │ │
│ │ │ ┌─┬─┬─┬─┐                                         │ │ │
│ │ │ │1│2│3│4│ 基础区域（1-8）                        │ │ │
│ │ │ ├─┼─┼─┼─┤                                         │ │ │
│ │ │ │5│6│7│8│                                          │ │ │
│ │ │ ├─┼─┼─┼─┤                                         │ │ │
│ │ │ │9│10│11│12│ 扩展区域（9-12）                    │ │ │
│ │ │ └─┴─┴─┴─┘                                         │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

---

## 🔄 FIFO队列管理流程

### 流程图

```
图片序列：1, 2, 3, ..., 8, 9, 10, ..., 20, 21, 22, ...

┌─────────────────────────────────────────────────┐
│ 图片 1-8: 填充基础区域                           │
│ ┌─┬─┬─┬─┐                                       │
│ │1│2│3│4│                                        │
│ ├─┼─┼─┼─┤                                       │
│ │5│6│7│8│                                        │
│ └─┴─┴─┴─┘                                       │
└─────────────────────────────────────────────────┘

↓ 继续收到图片

┌─────────────────────────────────────────────────┐
│ 图片 9-20: 扩展区域                              │
│ ┌─┬─┬─┬─┐                                       │
│ │1│2│3│4│                                        │
│ ├─┼─┼─┼─┤                                       │
│ │5│6│7│8│                                        │
│ ├─┼─┼─┼─┤                                       │
│ │9│10│11│12│                                     │
│ ├─┼─┼─┼─┤                                       │
│ │13│14│15│16│                                    │
│ ├─┼─┼─┼─┤                                       │
│ │17│18│19│20│ ← 达到上限                        │
│ └─┴─┴─┴─┘                                       │
└─────────────────────────────────────────────────┘

↓ 继续收到图片（循环覆盖）

┌─────────────────────────────────────────────────┐
│ 图片 21-24: 循环覆盖前4个                        │
│ ┌─┬─┬─┬─┐                                       │
│ │21│22│23│24│ ← 覆盖了原来的1-4                │
│ ├─┼─┼─┼─┤                                       │
│ │5│6│7│8│                                        │
│ ├─┼─┼─┼─┤                                       │
│ │9│10│11│12│                                     │
│ ├─┼─┼─┼─┤                                       │
│ │13│14│15│16│                                    │
│ ├─┼─┼─┼─┤                                       │
│ │17│18│19│20│                                    │
│ └─┴─┴─┴─┘                                       │
└─────────────────────────────────────────────────┘
```

### 代码实现

```python
def get_next_widget_for_device(self, device_tab):
    """获取下一个显示区域（FIFO队列）"""
    next_index = device_tab.next_index
    image_widgets = device_tab.image_widgets
    
    # 如果需要新区域且未达到上限（20个）
    if next_index >= len(image_widgets) and len(image_widgets) < 20:
        # 添加新区域
        index = len(image_widgets)
        row = index // 2
        col = index % 2
        
        display_widget = ImageDisplayWidget(index)
        image_widgets.append(display_widget)
        grid_layout.addWidget(display_widget, row, col)
        
        logger.info(f"添加新区域 {index}，总数: {len(image_widgets)}")
    
    # 获取区域（循环使用）
    widget_index = next_index % len(image_widgets)
    widget = image_widgets[widget_index]
    
    # 如果区域已有图片，先清空（循环覆盖）
    if widget.original_image_path:
        logger.info(f"区域 {widget_index} 将被覆盖")
        widget.clear()
    
    # 更新索引
    device_tab.next_index += 1
    
    return widget
```

---

## 📊 对比表

### 电量界面

| 特性 | 之前 | 之后 |
|------|------|------|
| 设备支持 | 单设备 | 多设备选项卡 ✅ |
| 数据类型显示 | 单个图表 | 4个子选项卡 ✅ |
| 图表类型 | 分组柱状图 | 堆叠柱状图 ✅ |
| 图例位置 | 图内（遮挡）| 图外右侧 ✅ |
| 颜色方案 | 统一颜色 | 相位色系+亮度区分 ✅ |

### 几何量界面

| 特性 | 之前 | 之后 |
|------|------|------|
| 设备支持 | 单设备 | 多设备选项卡 ✅ |
| 区域管理 | 预留机制 | FIFO队列 ✅ |
| 最大区域 | 无限扩展 | 20个上限 ✅ |
| 超限处理 | 无 | 循环覆盖 ✅ |
| 批次管理 | 批次隔离 | 移除（改为FIFO）✅ |

### 服务器端

| 特性 | 之前 | 之后 |
|------|------|------|
| 通知机制 | 实时推送 | 实时推送 ✅ |
| 离线处理 | 通知丢失 | 暂存通知 ✅ |
| 上线同步 | 无 | 发送暂存通知 ✅ |
| 暂存上限 | 无 | 100条 ✅ |

---

## ✅ 功能清单

### 服务器端

- ✅ 通知暂存机制
- ✅ 上位机连接时发送暂存通知
- ✅ 设备过滤支持
- ✅ 暂存数量上限（100条）
- ✅ FIFO方式清理旧通知

### 电量界面

- ✅ 多设备外层选项卡
- ✅ 4个数据类型子选项卡
- ✅ 堆叠柱状图（每相一根柱子）
- ✅ 颜色方案（相位色系 + 亮度区分）
- ✅ 图例放在图外面（右侧）
- ✅ Excel解析（参考test文件）
- ✅ 历史记录保存

### 几何量界面

- ✅ 多设备外层选项卡
- ✅ FIFO队列管理
- ✅ 按顺序填充区域（0-19）
- ✅ 自动扩展（8→20）
- ✅ 循环覆盖（>20时）
- ✅ 每个设备独立队列
- ✅ 历史记录保存

---

## 🧪 测试建议

### 服务器端测试

```
1. 关闭所有上位机
2. 下位机上传5个文件
   └─ 检查服务器日志：通知已暂存
3. 上位机连接服务器
   └─ 检查收到5条暂存通知
   └─ 检查自动下载并显示数据
```

### 电量界面测试

```
1. 设备1上传 Excel 文件
   └─ 检查创建"device_001"选项卡
   └─ 检查4个数据类型子选项卡
   └─ 检查堆叠柱状图

2. 设备2上传 Excel 文件
   └─ 检查创建"device_002"选项卡
   └─ 检查两个设备独立显示

3. 切换设备选项卡
   └─ 检查数据正确切换

4. 切换数据类型子选项卡
   └─ 检查功率W、电压、电流、相角图表
```

### 几何量界面测试

```
场景 1: 少量图片
1. 设备1上传5张图片
   └─ 使用区域0-4

场景 2: 扩展区域
2. 设备1继续上传10张图片
   └─ 扩展到15个区域（0-14）

场景 3: 循环覆盖
3. 设备1继续上传10张图片
   └─ 达到20个区域
   └─ 继续上传会从区域0开始覆盖

场景 4: 多设备
4. 设备2上传8张图片
   └─ 创建新选项卡"device_002"
   └─ 使用8个基础区域

5. 设备3上传25张图片
   └─ 创建新选项卡"device_003"
   └─ 扩展到20个区域
   └─ 循环覆盖前5个
```

---

所有功能已实现，没有lint错误，可以直接测试！🎉

