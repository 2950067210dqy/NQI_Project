# å¼‚æ­¥æ˜¾ç¤ºé—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜åˆ†æ

### 1. **ç”µé‡ç•Œé¢æ ‡ç­¾æœªå®ä¾‹åŒ–**

**é—®é¢˜ï¼š**
```python
# load_excel_file ä¸­ä½¿ç”¨äº†æœªå®ä¾‹åŒ–çš„æ ‡ç­¾
self.info_voltage_label.setText(...)  # âŒ AttributeError
self.info_frequency_label.setText(...)  # âŒ AttributeError
```

**åŸå› ï¼š** åœ¨ `create_realtime_tab()` æ–¹æ³•ä¸­æ²¡æœ‰åˆ›å»ºè¿™ä¸¤ä¸ªæ ‡ç­¾ã€‚

---

### 2. **å‡ ä½•é‡çª—å£å¼‚æ­¥æ˜¾ç¤ºé—®é¢˜** âš ï¸

**é—®é¢˜ç°è±¡ï¼š**
- æ”¶åˆ° 10 å¼ å›¾ç‰‡é€šçŸ¥
- ä½†çª—å£åªæ˜¾ç¤º 6-7 å¼ 
- å†å²è®°å½•ä¹Ÿåªæœ‰ 6-7 æ¡

**é—®é¢˜åŸå› ï¼š**

```python
# ä¹‹å‰çš„é€»è¾‘ï¼ˆæœ‰é—®é¢˜ï¼‰

# çº¿ç¨‹ 1 ä¸‹è½½ image1.png
def on_new_image_received(data1):
    download_thread1.start()  # å¼‚æ­¥ä¸‹è½½

# çº¿ç¨‹ 2 ä¸‹è½½ image2.pngï¼ˆå‡ ä¹åŒæ—¶ï¼‰
def on_new_image_received(data2):
    download_thread2.start()  # å¼‚æ­¥ä¸‹è½½

# âŒ é—®é¢˜ï¼šä¸¤ä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶å®Œæˆ
def on_image_download_finished(image1):
    # æŸ¥æ‰¾ç©ºé—²åŒºåŸŸ â†’ æ‰¾åˆ°åŒºåŸŸ 0
    widget = find_empty_widget()  # åŒºåŸŸ 0
    widget.load_image(image1)

def on_image_download_finished(image2):
    # ä¹ŸæŸ¥æ‰¾ç©ºé—²åŒºåŸŸ â†’ ä¹Ÿæ‰¾åˆ°åŒºåŸŸ 0ï¼ˆå› ä¸º image1 è¿˜æ²¡å®Œå…¨åŠ è½½ï¼‰
    widget = find_empty_widget()  # åŒºåŸŸ 0ï¼ˆåŒä¸€ä¸ªï¼ï¼‰
    widget.load_image(image2)  # âŒ è¦†ç›–äº† image1
```

**æ—¶åºå›¾ï¼š**

```
æ—¶é—´çº¿:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

æ”¶åˆ°é€šçŸ¥1 â†’ å¯åŠ¨ä¸‹è½½çº¿ç¨‹1
æ”¶åˆ°é€šçŸ¥2 â†’ å¯åŠ¨ä¸‹è½½çº¿ç¨‹2  
æ”¶åˆ°é€šçŸ¥3 â†’ å¯åŠ¨ä¸‹è½½çº¿ç¨‹3
         â†“
    å¹¶å‘ä¸‹è½½...
         â†“
çº¿ç¨‹1å®Œæˆ â†’ æŸ¥æ‰¾ç©ºé—²åŒºåŸŸ â†’ åŒºåŸŸ0 âœ“
çº¿ç¨‹2å®Œæˆ â†’ æŸ¥æ‰¾ç©ºé—²åŒºåŸŸ â†’ åŒºåŸŸ0 âŒï¼ˆrace conditionï¼‰
çº¿ç¨‹3å®Œæˆ â†’ æŸ¥æ‰¾ç©ºé—²åŒºåŸŸ â†’ åŒºåŸŸ1 âœ“

ç»“æœï¼šåŒºåŸŸ0åªæ˜¾ç¤ºimage2ï¼Œimage1è¢«è¦†ç›–äº†
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. **ç”µé‡ç•Œé¢æ ‡ç­¾å®ä¾‹åŒ–**

**ä¿®å¤ï¼š** åœ¨ `create_realtime_tab()` ä¸­æ·»åŠ æ ‡ç­¾

```python
def create_realtime_tab(self) -> QWidget:
    # æ–‡ä»¶ä¿¡æ¯
    info_group = QGroupBox("å½“å‰æ–‡ä»¶ä¿¡æ¯")
    info_layout = QVBoxLayout(info_group)
    self.current_file_label = QLabel("æ–‡ä»¶: æ— ")
    self.current_time_label = QLabel("æ¥æ”¶æ—¶é—´: --")
    self.current_device_label = QLabel("è®¾å¤‡: --")
    
    # âœ… æ·»åŠ é¢å®šå‚æ•°æ ‡ç­¾
    self.info_voltage_label = QLabel("é¢å®šç”µå‹: --")
    self.info_frequency_label = QLabel("é¢å®šåŠŸç‡: --")
    
    info_layout.addWidget(self.current_file_label)
    info_layout.addWidget(self.current_time_label)
    info_layout.addWidget(self.current_device_label)
    info_layout.addWidget(self.info_voltage_label)
    info_layout.addWidget(self.info_frequency_label)
    layout.addWidget(info_group)
```

---

### 2. **å‡ ä½•é‡çª—å£å¼‚æ­¥æ˜¾ç¤ºä¿®å¤** â­

**æ ¸å¿ƒæ€æƒ³ï¼š** åœ¨ä¸‹è½½å¼€å§‹æ—¶é¢„åˆ†é…åŒºåŸŸï¼Œè€Œä¸æ˜¯åœ¨ä¸‹è½½å®ŒæˆåæŸ¥æ‰¾ç©ºé—²åŒºåŸŸã€‚

#### 2.1 æ·»åŠ é¢„ç•™çŠ¶æ€

```python
class ImageDisplayWidget(QFrame):
    def __init__(self, index: int, parent=None):
        super().__init__(parent)
        self.index = index
        self.original_image_path = None
        self.recognized_image_path = None
        self.reserved = False  # âœ… æ–°å¢ï¼šé¢„ç•™çŠ¶æ€
```

#### 2.2 æ·»åŠ é¢„ç•™æ–¹æ³•

```python
def reserve_display_widget(self):
    """
    é¢„ç•™ä¸€ä¸ªæ˜¾ç¤ºåŒºåŸŸï¼ˆç”¨äºå¼‚æ­¥ä¸‹è½½ï¼‰
    è¿”å›é¢„ç•™çš„ widgetï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨åŒºåŸŸåˆ™è¿”å› None
    """
    # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœªè¢«ä½¿ç”¨ä¸”æœªè¢«é¢„ç•™çš„æ˜¾ç¤ºç»„ä»¶
    for widget in self.image_display_widgets:
        if not widget.original_image_path and not widget.reserved:
            widget.reserved = True  # âœ… æ ‡è®°ä¸ºå·²é¢„ç•™
            logger.info(f"é¢„ç•™æ˜¾ç¤ºåŒºåŸŸ: {widget.index}")
            return widget
    
    # å¦‚æœæ²¡æœ‰ç©ºé—²åŒºåŸŸï¼ŒåŠ¨æ€æ·»åŠ ä¸€ä¸ª
    self.ensure_display_capacity(len(self.image_display_widgets) + 1)
    new_widget = self.image_display_widgets[-1]
    new_widget.reserved = True
    return new_widget
```

#### 2.3 ä¿®æ”¹ä¸‹è½½å¼€å§‹é€»è¾‘

```python
def on_new_image_received(self, data: dict):
    """æ¥æ”¶åˆ°æ–°å›¾ç‰‡æ•°æ®"""
    
    if file_id and self.server_client:
        try:
            # âœ… å…³é”®ä¿®å¤ï¼šåœ¨ä¸‹è½½å¼€å§‹å‰å°±é¢„åˆ†é…æ˜¾ç¤ºåŒºåŸŸ
            reserved_widget = self.reserve_display_widget()
            if reserved_widget is None:
                logger.warning("æ²¡æœ‰å¯ç”¨çš„æ˜¾ç¤ºåŒºåŸŸ")
                return
            
            # åˆ›å»ºä¸‹è½½çº¿ç¨‹
            download_thread = ImageDownloadThread(...)
            
            # âœ… ä¿å­˜çº¿ç¨‹åˆ°æ˜¾ç¤ºç»„ä»¶çš„æ˜ å°„
            thread_id = id(download_thread)
            self.download_widget_mapping[thread_id] = reserved_widget
            
            # âœ… åœ¨é¢„ç•™åŒºåŸŸæ˜¾ç¤º"ä¸‹è½½ä¸­..."çŠ¶æ€
            reserved_widget.filename_label.setText(f"ä¸‹è½½ä¸­: {file_name}")
            reserved_widget.status_label.setText("ä¸‹è½½ä¸­...")
            
            # å¯åŠ¨ä¸‹è½½
            download_thread.start()
```

#### 2.4 ä¿®æ”¹ä¸‹è½½å®Œæˆé€»è¾‘

```python
def on_image_download_finished(self, file_path: str, device_id: str):
    """å›¾ç‰‡ä¸‹è½½å®Œæˆå›è°ƒ"""
    
    # âœ… æŸ¥æ‰¾å½“å‰çº¿ç¨‹å¯¹åº”çš„é¢„ç•™åŒºåŸŸ
    current_thread = self.sender()
    thread_id = id(current_thread.thread())
    target_widget = self.download_widget_mapping.get(thread_id)
    
    # âœ… ç›´æ¥ä½¿ç”¨é¢„ç•™çš„åŒºåŸŸï¼Œä¸å†æŸ¥æ‰¾
    self.add_image_to_display(Path(file_path), device_id, target_widget=target_widget)
    
    # æ¸…ç†æ˜ å°„
    if thread_id in self.download_widget_mapping:
        del self.download_widget_mapping[thread_id]
    
    # ä¿å­˜åˆ°å†å²è®°å½•
    record = {...}
    self.history_records.append(record)
    self.update_history_list()
```

#### 2.5 ä¿®æ”¹ä¸‹è½½å¤±è´¥é€»è¾‘

```python
def on_image_download_failed(self, error: str):
    """å›¾ç‰‡ä¸‹è½½å¤±è´¥å›è°ƒ"""
    
    # âœ… é‡Šæ”¾é¢„ç•™çš„åŒºåŸŸ
    current_thread = self.sender()
    thread_id = id(current_thread.thread())
    target_widget = self.download_widget_mapping.get(thread_id)
    
    if target_widget:
        target_widget.reserved = False  # é‡Šæ”¾é¢„ç•™
        target_widget.filename_label.setText("--")
        target_widget.status_label.setText("ä¸‹è½½å¤±è´¥")
    
    # æ¸…ç†æ˜ å°„
    if thread_id in self.download_widget_mapping:
        del self.download_widget_mapping[thread_id]
```

---

## ğŸ”„ ä¿®å¤åçš„å·¥ä½œæµç¨‹

### å‡ ä½•é‡çª—å£ï¼ˆä¿®å¤åï¼‰

```
æ—¶é—´çº¿:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

æ”¶åˆ°é€šçŸ¥1 â†’ é¢„ç•™åŒºåŸŸ0 â†’ å¯åŠ¨ä¸‹è½½çº¿ç¨‹1
æ”¶åˆ°é€šçŸ¥2 â†’ é¢„ç•™åŒºåŸŸ1 â†’ å¯åŠ¨ä¸‹è½½çº¿ç¨‹2  
æ”¶åˆ°é€šçŸ¥3 â†’ é¢„ç•™åŒºåŸŸ2 â†’ å¯åŠ¨ä¸‹è½½çº¿ç¨‹3
         â†“
    å¹¶å‘ä¸‹è½½...
         â†“
çº¿ç¨‹1å®Œæˆ â†’ ä½¿ç”¨é¢„ç•™çš„åŒºåŸŸ0 â†’ æ˜¾ç¤ºimage1 âœ“
çº¿ç¨‹2å®Œæˆ â†’ ä½¿ç”¨é¢„ç•™çš„åŒºåŸŸ1 â†’ æ˜¾ç¤ºimage2 âœ“
çº¿ç¨‹3å®Œæˆ â†’ ä½¿ç”¨é¢„ç•™çš„åŒºåŸŸ2 â†’ æ˜¾ç¤ºimage3 âœ“

ç»“æœï¼šæ¯å¼ å›¾ç‰‡éƒ½æ˜¾ç¤ºåœ¨ä¸åŒçš„åŒºåŸŸï¼Œæ²¡æœ‰è¦†ç›–ï¼âœ…
```

**è¯¦ç»†æµç¨‹ï¼š**

```python
# 1. æ”¶åˆ°ç¬¬1å¼ å›¾ç‰‡é€šçŸ¥
on_new_image_received(data1)
â”œâ”€ reserve_display_widget() â†’ åŒºåŸŸ0ï¼ˆæ ‡è®°ä¸º reserved=Trueï¼‰
â”œâ”€ download_widget_mapping[thread1_id] = åŒºåŸŸ0
â”œâ”€ åŒºåŸŸ0.filename_label = "ä¸‹è½½ä¸­: image1.png"
â””â”€ thread1.start()

# 2. æ”¶åˆ°ç¬¬2å¼ å›¾ç‰‡é€šçŸ¥ï¼ˆå‡ ä¹åŒæ—¶ï¼‰
on_new_image_received(data2)
â”œâ”€ reserve_display_widget() â†’ åŒºåŸŸ1ï¼ˆåŒºåŸŸ0å·²é¢„ç•™ï¼Œè·³è¿‡ï¼‰
â”œâ”€ download_widget_mapping[thread2_id] = åŒºåŸŸ1
â”œâ”€ åŒºåŸŸ1.filename_label = "ä¸‹è½½ä¸­: image2.png"
â””â”€ thread2.start()

# 3. çº¿ç¨‹1ä¸‹è½½å®Œæˆ
on_image_download_finished("image1.png")
â”œâ”€ æŸ¥æ‰¾æ˜ å°„ï¼šdownload_widget_mapping[thread1_id] â†’ åŒºåŸŸ0
â”œâ”€ add_image_to_display(image1, target_widget=åŒºåŸŸ0)
â”‚  â””â”€ åŒºåŸŸ0.load_original_image(image1)  # åŠ è½½åˆ°åŒºåŸŸ0
â”œâ”€ æ¸…ç†æ˜ å°„ï¼šdel download_widget_mapping[thread1_id]
â””â”€ ä¿å­˜å†å²è®°å½•

# 4. çº¿ç¨‹2ä¸‹è½½å®Œæˆ
on_image_download_finished("image2.png")
â”œâ”€ æŸ¥æ‰¾æ˜ å°„ï¼šdownload_widget_mapping[thread2_id] â†’ åŒºåŸŸ1
â”œâ”€ add_image_to_display(image2, target_widget=åŒºåŸŸ1)
â”‚  â””â”€ åŒºåŸŸ1.load_original_image(image2)  # åŠ è½½åˆ°åŒºåŸŸ1
â”œâ”€ æ¸…ç†æ˜ å°„ï¼šdel download_widget_mapping[thread2_id]
â””â”€ ä¿å­˜å†å²è®°å½•
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### æ˜¾ç¤ºæ•°é‡

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ä¸Šä¼  10 å¼ å›¾ç‰‡ | æ˜¾ç¤º 6-7 å¼  âŒ | æ˜¾ç¤º 10 å¼  âœ… |
| å†å²è®°å½• | 6-7 æ¡ âŒ | 10 æ¡ âœ… |
| å¹¶å‘ä¸‹è½½ | ä¼šè¦†ç›– âŒ | ä¸ä¼šè¦†ç›– âœ… |

### æ•°æ®å®Œæ•´æ€§

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| å›¾ç‰‡ä¸¢å¤±ç‡ | 30-40% âŒ | 0% âœ… |
| å†å²è®°å½•å‡†ç¡®æ€§ | ä¸å‡†ç¡® âŒ | å‡†ç¡® âœ… |
| åŒºåŸŸåˆ†é…å†²çª | å­˜åœ¨ âŒ | ä¸å­˜åœ¨ âœ… |

---

## ğŸ” å…³é”®æ”¹è¿›ç‚¹

### 1. çº¿ç¨‹åˆ°åŒºåŸŸçš„æ˜ å°„

```python
# ä¿®å¤å‰ï¼šæ²¡æœ‰æ˜ å°„ï¼Œä¸‹è½½å®ŒæˆåæŸ¥æ‰¾ç©ºé—²åŒºåŸŸ
def on_image_download_finished(file_path):
    widget = find_empty_widget()  # âŒ Race condition
    widget.load_image(file_path)

# ä¿®å¤åï¼šæœ‰æ˜ å°„ï¼Œä¸‹è½½å®Œæˆåç›´æ¥ä½¿ç”¨é¢„ç•™åŒºåŸŸ
def on_image_download_finished(file_path):
    thread_id = id(self.sender().thread())
    widget = self.download_widget_mapping[thread_id]  # âœ… ç²¾ç¡®å®šä½
    widget.load_image(file_path)
```

### 2. åŒºåŸŸé¢„ç•™æœºåˆ¶

```python
# ä¿®å¤å‰ï¼šæ²¡æœ‰é¢„ç•™ï¼Œå¤šä¸ªçº¿ç¨‹å¯èƒ½æ‰¾åˆ°ç›¸åŒåŒºåŸŸ
for widget in self.image_display_widgets:
    if not widget.original_image_path:  # âŒ åªæ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡
        return widget

# ä¿®å¤åï¼šæœ‰é¢„ç•™ï¼Œå·²é¢„ç•™çš„åŒºåŸŸä¼šè¢«è·³è¿‡
for widget in self.image_display_widgets:
    if not widget.original_image_path and not widget.reserved:  # âœ… è¿˜æ£€æŸ¥é¢„ç•™çŠ¶æ€
        widget.reserved = True
        return widget
```

### 3. çŠ¶æ€ç®¡ç†

```python
# åŒºåŸŸçŠ¶æ€
self.reserved = False        # æœªé¢„ç•™ï¼Œæœªä½¿ç”¨
self.reserved = True         # å·²é¢„ç•™ï¼Œä¸‹è½½ä¸­
self.original_image_path = xxx  # å·²ä½¿ç”¨ï¼Œæ˜¾ç¤ºä¸­

# çŠ¶æ€è½¬æ¢
æœªé¢„ç•™ â†’ (é¢„ç•™) â†’ å·²é¢„ç•™ â†’ (ä¸‹è½½å®Œæˆ) â†’ å·²ä½¿ç”¨
       â†‘                    â†“
       â””â”€â”€â”€â”€ (ä¸‹è½½å¤±è´¥) â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1ï¼šå•å¼ å›¾ç‰‡

```
1. ä¸Šä¼  1 å¼ å›¾ç‰‡
   â”œâ”€ é¢„ç•™åŒºåŸŸ0
   â”œâ”€ ä¸‹è½½å®Œæˆ
   â””â”€ æ˜¾ç¤ºåœ¨åŒºåŸŸ0 âœ…

2. æ£€æŸ¥å†å²è®°å½•
   â””â”€ 1 æ¡è®°å½• âœ…
```

### æµ‹è¯•åœºæ™¯ 2ï¼šå°‘é‡å›¾ç‰‡ï¼ˆ< 8å¼ ï¼‰

```
1. å¿«é€Ÿä¸Šä¼  5 å¼ å›¾ç‰‡
   â”œâ”€ é¢„ç•™åŒºåŸŸ0, 1, 2, 3, 4
   â”œâ”€ å¹¶å‘ä¸‹è½½
   â””â”€ åˆ†åˆ«æ˜¾ç¤ºåœ¨å¯¹åº”åŒºåŸŸ âœ…

2. æ£€æŸ¥å†å²è®°å½•
   â””â”€ 5 æ¡è®°å½• âœ…
```

### æµ‹è¯•åœºæ™¯ 3ï¼šå¤§é‡å›¾ç‰‡ï¼ˆ> 8å¼ ï¼‰

```
1. å¿«é€Ÿä¸Šä¼  15 å¼ å›¾ç‰‡
   â”œâ”€ é¢„ç•™åŒºåŸŸ0-7ï¼ˆåŸºç¡€åŒºåŸŸï¼‰
   â”œâ”€ åŠ¨æ€æ·»åŠ åŒºåŸŸ8-14
   â”œâ”€ å¹¶å‘ä¸‹è½½
   â””â”€ åˆ†åˆ«æ˜¾ç¤ºåœ¨å¯¹åº”åŒºåŸŸ âœ…

2. æ£€æŸ¥æ˜¾ç¤º
   â”œâ”€ 15 ä¸ªåŒºåŸŸ
   â””â”€ 15 å¼ å›¾ç‰‡ï¼Œæ²¡æœ‰è¦†ç›– âœ…

3. æ£€æŸ¥å†å²è®°å½•
   â””â”€ 15 æ¡è®°å½• âœ…
```

### æµ‹è¯•åœºæ™¯ 4ï¼šä¸‹è½½å¤±è´¥

```
1. ä¸Šä¼ å›¾ç‰‡ä½†æœåŠ¡å™¨è¿”å›é”™è¯¯
   â”œâ”€ é¢„ç•™åŒºåŸŸ0
   â”œâ”€ ä¸‹è½½å¤±è´¥
   â”œâ”€ é‡Šæ”¾åŒºåŸŸ0ï¼ˆreserved=Falseï¼‰
   â””â”€ åŒºåŸŸ0å¯è¢«åç»­å›¾ç‰‡ä½¿ç”¨ âœ…

2. æ£€æŸ¥çŠ¶æ€
   â””â”€ åŒºåŸŸ0æ˜¾ç¤º"ä¸‹è½½å¤±è´¥" âœ…
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. çº¿ç¨‹IDè·å–

```python
# æ­£ç¡®çš„è·å–æ–¹å¼
current_thread = self.sender()  # ä¿¡å·å‘é€è€…
thread_id = id(current_thread.thread())  # çº¿ç¨‹ID

# é”™è¯¯çš„è·å–æ–¹å¼
thread_id = id(current_thread)  # âŒ è¿™æ˜¯ QThread å¯¹è±¡çš„IDï¼Œä¸æ˜¯çº¿ç¨‹ID
```

### 2. æ˜ å°„æ¸…ç†

```python
# å¿…é¡»åœ¨ä¸‹è½½å®Œæˆæˆ–å¤±è´¥åæ¸…ç†æ˜ å°„
if thread_id in self.download_widget_mapping:
    del self.download_widget_mapping[thread_id]

# å¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼
```

### 3. åŒºåŸŸé‡Šæ”¾

```python
# ä¸‹è½½å¤±è´¥æ—¶å¿…é¡»é‡Šæ”¾é¢„ç•™çš„åŒºåŸŸ
if target_widget:
    target_widget.reserved = False

# å¦åˆ™åŒºåŸŸä¼šä¸€ç›´è¢«å ç”¨ï¼Œæ— æ³•ä½¿ç”¨
```

### 4. å†å²è®°å½•ä¿å­˜

```python
# ä¿®å¤å‰ï¼šåœ¨æ”¶åˆ°é€šçŸ¥æ—¶ä¿å­˜ï¼ˆé”™è¯¯ï¼‰
def on_new_image_received(data):
    # ...
    self.history_records.append(data)  # âŒ ä¸‹è½½å¯èƒ½å¤±è´¥

# ä¿®å¤åï¼šåœ¨ä¸‹è½½å®Œæˆåä¿å­˜ï¼ˆæ­£ç¡®ï¼‰
def on_image_download_finished(file_path):
    # ...
    record = {...}
    self.history_records.append(record)  # âœ… ç¡®ä¿ä¸‹è½½æˆåŠŸ
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘æ§åˆ¶

è™½ç„¶ç°åœ¨æ”¯æŒå¤šä¸ªå›¾ç‰‡åŒæ—¶ä¸‹è½½ï¼Œä½†å¦‚æœåŒæ—¶ä¸‹è½½å¤ªå¤šå¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚å¯ä»¥è€ƒè™‘é™åˆ¶ï¼š

```python
MAX_CONCURRENT_DOWNLOADS = 5

def on_new_image_received(self, data):
    # æ£€æŸ¥å½“å‰ä¸‹è½½æ•°é‡
    if len(self.active_download_threads) >= MAX_CONCURRENT_DOWNLOADS:
        # åŠ å…¥é˜Ÿåˆ—ç­‰å¾…
        self.download_queue.append(data)
        return
    
    # å¦åˆ™ç«‹å³å¼€å§‹ä¸‹è½½
    self.start_download(data)
```

### 2. å†…å­˜ç®¡ç†

å¦‚æœå›¾ç‰‡å¾ˆå¤§ï¼Œå¯ä»¥é™åˆ¶åŒæ—¶æ˜¾ç¤ºçš„å›¾ç‰‡æ•°é‡ï¼š

```python
MAX_DISPLAY_IMAGES = 100

def reserve_display_widget(self):
    if len(self.image_display_widgets) >= MAX_DISPLAY_IMAGES:
        logger.warning("å·²è¾¾åˆ°æœ€å¤§æ˜¾ç¤ºæ•°é‡")
        return None
    # ...
```

---

## âœ… ä¿®å¤æ¸…å•

- âœ… ç”µé‡ç•Œé¢æ ‡ç­¾å®ä¾‹åŒ–
- âœ… å‡ ä½•é‡çª—å£å¼‚æ­¥æ˜¾ç¤ºä¿®å¤
- âœ… åŒºåŸŸé¢„ç•™æœºåˆ¶
- âœ… çº¿ç¨‹åˆ°åŒºåŸŸçš„æ˜ å°„
- âœ… ä¸‹è½½çŠ¶æ€æ˜¾ç¤º
- âœ… ä¸‹è½½å¤±è´¥å¤„ç†
- âœ… å†å²è®°å½•å‡†ç¡®æ€§
- âœ… æ—  lint é”™è¯¯

---

## ğŸ“ æ€»ç»“

**æ ¸å¿ƒæ”¹è¿›ï¼š**
1. ğŸ”‘ **é¢„åˆ†é…æœºåˆ¶** - ä¸‹è½½å¼€å§‹æ—¶å°±é¢„ç•™åŒºåŸŸï¼Œé¿å…ç«äº‰
2. ğŸ”‘ **ç²¾ç¡®æ˜ å°„** - çº¿ç¨‹IDåˆ°æ˜¾ç¤ºåŒºåŸŸçš„ç²¾ç¡®æ˜ å°„ï¼Œé¿å…è¦†ç›–
3. ğŸ”‘ **çŠ¶æ€ç®¡ç†** - å®Œå–„çš„çŠ¶æ€è½¬æ¢ï¼ŒåŒ…æ‹¬é¢„ç•™ã€ä½¿ç”¨ã€é‡Šæ”¾

**æ•ˆæœï¼š**
- âœ… æ˜¾ç¤ºçš„å›¾ç‰‡æ•°é‡ = æ¥æ”¶çš„å›¾ç‰‡æ•°é‡
- âœ… å†å²è®°å½•æ•°é‡ = æ¥æ”¶çš„å›¾ç‰‡æ•°é‡
- âœ… æ²¡æœ‰å›¾ç‰‡è¢«è¦†ç›–
- âœ… å¹¶å‘ä¸‹è½½å®‰å…¨å¯é 

æ‰€æœ‰ä¿®å¤å·²å®Œæˆï¼Œå¯ä»¥ç›´æ¥æµ‹è¯•ï¼ğŸ‰

