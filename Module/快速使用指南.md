# 数据缓存功能 - 快速使用指南

## 功能说明

现在电量数据页面和几何量数据页面都支持SQLite缓存功能：
- ✅ 历史记录持久化存储
- ✅ 窗口关闭时自动缓存新数据
- ✅ 窗口打开时自动恢复最新数据
- ✅ 历史记录查询和筛选

## 使用方法

### 1. 正常使用（推荐）

1. **打开数据页面**
   - 点击"电量数据查看器"或"几何量数据查看器"

2. **接收数据**
   - 下位机发送数据到服务器
   - 上位机自动下载并显示
   - 数据自动保存到缓存

3. **查看历史**
   - 切换到"历史数据"选项卡
   - 按设备、日期筛选记录
   - 点击记录查看详情

### 2. 窗口隐藏模式

1. **启动程序但不打开数据页面**
   - 程序在后台运行

2. **下位机发送数据**
   - 上位机收到通知
   - **自动保存到缓存**（不下载文件）
   - 节省网络流量和存储空间

3. **稍后打开页面**
   - 页面会提示有新数据
   - 可以选择查看历史记录

### 3. 数据恢复

1. **关闭程序**
   - 所有数据已保存到缓存数据库

2. **重新启动程序**
   - 打开数据页面

3. **自动恢复**
   - 页面自动显示最新数据
   - 电量数据：每个设备的最新记录
   - 几何量数据：每个设备的最新20张图片

## 缓存位置

```
NQI_Project/
├── cache/
│   ├── excel_data_cache.db    # 电量数据缓存
│   └── image_data_cache.db    # 几何量数据缓存
```

## 状态提示

### 电量数据页面

**状态栏提示**：
- `状态: 等待数据...` - 初始状态
- `状态: 正在下载 - 设备 XXX` - 正在下载
- `状态: 加载完成 - 设备 XXX` - 下载并显示完成
- `状态: 已从缓存加载 X 个设备的数据` - 从缓存恢复

**日志信息**：
```
✅ 从缓存加载了 3 个设备的最新数据
✅ 从缓存加载了 15 条历史记录
✅ 历史记录已保存到缓存: xxx.xlsx
```

### 几何量数据页面

**状态栏提示**：
- `状态: 等待数据...` - 初始状态
- `状态: 正在下载 - 设备 XXX` - 正在下载
- `状态: 下载完成 - 设备 XXX` - 下载完成
- `状态: 已从缓存加载 X 张图片` - 从缓存恢复

**日志信息**：
```
✅ 从缓存加载了 20 张图片
✅ 从缓存加载了 50 条图片历史记录
✅ 图片记录已保存到缓存: xxx.png
```

## 常见问题

### Q1: 缓存数据会占用多少空间？

**A**: 缓存数据库本身很小（通常<10MB），主要占用空间的是下载的文件：
- 电量数据：Excel文件，每个约几百KB
- 几何量数据：图片文件，每个约几MB

### Q2: 窗口隐藏时，新数据会丢失吗？

**A**: 不会。新数据的**元信息**会保存到缓存数据库，包括：
- 设备ID、文件名、时间戳
- 文件ID（用于后续下载）
- 标记为"待下载"状态

虽然文件本身没有下载，但记录不会丢失。

### Q3: 如何清理旧缓存？

**A**: 目前支持程序化清理，可以在代码中调用：

```python
from public.function.Cache.cache_manager import cache_manager

# 清理30天前的记录
cache_manager.clear_old_records(days=30)
```

建议在程序启动时自动执行。

### Q4: 缓存会影响性能吗？

**A**: 不会。SQLite写入非常快，且操作都是异步的，不会阻塞UI。

### Q5: 如何查看缓存统计？

**A**: 可以调用统计接口：

```python
from public.function.Cache.cache_manager import cache_manager

stats = cache_manager.get_statistics()
print(f"电量数据记录数: {stats['excel_count']}")
print(f"图片数据记录数: {stats['image_count']}")
```

### Q6: 缓存数据库损坏怎么办？

**A**: 删除缓存数据库文件，程序会自动重建：

```bash
# Windows
del cache\excel_data_cache.db
del cache\image_data_cache.db

# Linux/Mac
rm cache/excel_data_cache.db
rm cache/image_data_cache.db
```

原始的数据文件（Excel和图片）不受影响。

### Q7: 可以导出缓存数据吗？

**A**: 缓存数据库是标准的SQLite格式，可以使用任何SQLite工具打开：
- [DB Browser for SQLite](https://sqlitebrowser.org/) （推荐）
- SQLite命令行工具
- Python sqlite3 库

也可以在代码中实现导出功能（未来扩展）。

## 技术细节

### 窗口可见性检测

使用两个条件判断窗口是否可见：

```python
if not self.is_visible or not self.isVisible():
    # 窗口不可见，保存到缓存
```

- `self.is_visible`：手动维护的状态标志
- `self.isVisible()`：PyQt内置方法

### 缓存数据结构

**电量数据记录**：
```python
{
    'device_id': '12323',
    'file_path': 'data/excel/12323/xxx.xlsx',
    'file_name': 'xxx.xlsx',
    'timestamp': '2025-12-12 14:30:00',
    'sheet_count': 3,
    'rated_voltage': 220.0,
    'rated_voltage_unit': 'V',
    'rated_frequency': 50.0,
    'rated_frequency_unit': 'Hz'
}
```

**几何量数据记录**：
```python
{
    'device_id': '12323',
    'file_path': 'data/image/12323/xxx.png',
    'file_name': 'xxx.png',
    'original_path': 'data/image/12323/xxx.png',
    'recognized_path': 'data/image/12323/xxx_recognized.png',
    'timestamp': '2025-12-12 14:30:00',
    'file_size': 2048576  # 字节
}
```

## 最佳实践

1. **定期备份**：定期备份 `cache/` 目录
2. **定期清理**：定期清理30天前的旧记录
3. **监控日志**：关注日志中的缓存相关信息
4. **磁盘空间**：确保有足够的磁盘空间存储缓存

## 更新日志

### 2025-12-12
- ✅ 实现SQLite缓存功能
- ✅ 修复子线程UI更新问题
- ✅ 支持窗口隐藏时的智能缓存
- ✅ 支持窗口打开时的自动恢复

## 联系支持

如有问题或建议，请查看详细文档：
- `Module/本次修改总结.md`
- `Module/SQLite缓存功能实现说明.md`
- `Module/子线程UI更新问题修复说明.md`

