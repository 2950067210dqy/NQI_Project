# 数据下载和显示功能实现说明

## 📋 更新内容

### 1. **服务端修改** - `NQI_Project_Server`

#### 修改文件：`main.py`

✅ **在 WebSocket 通知中添加 file_id 字段**

```python
# 电量数据通知
payload = {
    "type": "excel_upload",
    "device_id": device_id,
    "file_id": file_info.get("file_id"),  # 新增
    "file_name": file_info.get("file_name"),
    "file_size": file_info.get("file_size"),
    "data_type": "excel",
    "timestamp": datetime.now().isoformat()
}

# 图片数据通知
payload = {
    "type": "image_upload",
    "device_id": device_id,
    "file_id": file_info.get("file_id"),  # 新增
    "file_name": file_info.get("file_name"),
    "file_size": file_info.get("file_size"),
    "original_size": file_info.get("original_size"),
    "compression_ratio": file_info.get("compression_ratio"),
    "data_type": "image",
    "timestamp": datetime.now().isoformat()
}
```

**作用：**
- 上位机可以通过 `file_id` 直接下载文件
- 无需再通过文件名查询

### 2. **上位机修改** - `NQI_Project`

#### 2.1 电量数据查看器

**文件：** `Module/excel_data_viewer/index/excel_viewer_window.py`

✅ **实现自动下载和解析功能**

```python
def on_new_data_received(self, data: dict):
    """接收到新数据通知"""
    device_id = data.get('device_id')
    file_id = data.get('file_id')
    file_name = data.get('file_name')
    
    if file_id and self.server_client:
        # 创建 data 目录
        data_dir = Path("data/excel") / device_id
        data_dir.mkdir(parents=True, exist_ok=True)
        
        # 下载文件
        save_path = data_dir / file_name
        self.server_client.client.download_excel_file(file_id, save_path)
        
        # 加载并显示
        self.load_excel_file(str(save_path), device_id)
```

✅ **改进的 Excel 解析逻辑**

```python
def parse_sheet_data(self, sheet) -> dict:
    """解析三相表数据（智能识别格式）"""
    data = {}
    
    # 遍历所有行查找数据
    for row in sheet.iter_rows(min_row=1, values_only=False):
        param_name = str(row[0].value).strip()
        
        # 根据参数名识别数据
        if "电压" in param_name:
            data['voltage_a'] = float(row[1].value)
            data['voltage_b'] = float(row[2].value)
            data['voltage_c'] = float(row[3].value)
        
        elif "电流" in param_name:
            data['current_a'] = float(row[1].value)
            data['current_b'] = float(row[2].value)
            data['current_c'] = float(row[3].value)
        
        # ... 其他参数
    
    return data
```

**特性：**
- 智能识别参数名（支持中文和英文）
- 兼容不同格式的 Excel 文件
- 自动提取三相电压、电流、功率因数等数据
- 生成条形统计图

#### 2.2 几何量图片查看器

**文件：** `Module/image_data_viewer/index/image_viewer_window.py`

✅ **实现自动下载和显示功能**

```python
def on_new_image_received(self, data: dict):
    """接收到新图片通知"""
    device_id = data.get('device_id')
    file_id = data.get('file_id')
    file_name = data.get('file_name')
    
    if file_id and self.server_client:
        # 创建 data 目录
        data_dir = Path("data/image") / device_id
        data_dir.mkdir(parents=True, exist_ok=True)
        
        # 下载文件
        save_path = data_dir / file_name
        self.server_client.client.download_image_file(file_id, save_path)
        
        # 显示图片
        self.add_image_to_display(save_path, device_id)

def add_image_to_display(self, image_path: Path, device_id: str):
    """添加图片到显示区域"""
    # 查找第一个空闲的显示组件
    for widget in self.image_display_widgets:
        if not widget.original_image_path:
            widget.load_original_image(image_path)
            break
```

**特性：**
- 自动下载图片到本地
- 按顺序填充 8 个显示区域
- 实时更新批次信息
- 支持后续识别处理

#### 2.3 自动配置 API 客户端

**文件：** `Module/excel_data_viewer/main.py` 和 `Module/image_data_viewer/main.py`

✅ **在窗口创建时自动设置 server_client**

```python
def create_middle_window(self) -> BaseWindow:
    """创建中间窗口"""
    window = ExcelDataViewerWindow()
    
    # 自动设置 server_client
    server_url = global_setting.get_setting("connect_server", {}).get("server", {}).get("url")
    if server_url:
        from Service.connect_server_service.api.api_client import UpperAPIClient
        class TempClient:
            def __init__(self, url):
                self.client = UpperAPIClient(url)
        window.set_server_client(TempClient(server_url))
    
    return window
```

## 📁 数据存储结构

下载的数据会缓存在上位机项目根目录的 `data` 文件夹中：

```
NQI_Project/
├── data/
│   ├── excel/          # 电量数据
│   │   ├── 123/        # 设备 123 的数据
│   │   │   ├── 20251211_111324_TA3310三相表数据.xlsx
│   │   │   ├── 20251211_111434_TA3310三相表数据.xlsx
│   │   │   └── ...
│   │   ├── 12323/      # 设备 12323 的数据
│   │   │   └── ...
│   │   └── ...
│   └── image/          # 几何量图片
│       ├── 123/        # 设备 123 的图片
│       │   ├── 20251211_111324_brightness_0.5.png
│       │   ├── 20251211_111325_brightness_0.6.png
│       │   └── ...
│       ├── 12323/      # 设备 12323 的图片
│       │   └── ...
│       └── ...
```

**优点：**
- 按设备 ID 分类存储
- 避免文件名冲突
- 便于查看和管理
- 支持离线查看历史数据

## 🔄 完整工作流程

### 电量数据流程

```
1. 下位机上传 Excel 文件
   ↓
2. 服务端保存文件并分配 file_id
   ↓
3. 服务端通过 WebSocket 推送通知（包含 file_id）
   ↓
4. 上位机电量数据查看器收到通知
   ↓
5. 通过 API 下载文件到 data/excel/{device_id}/
   ↓
6. 解析 Excel 数据（智能识别参数）
   ↓
7. 显示表格和条形图
   ↓
8. 保存到历史记录
```

### 几何量图片流程

```
1. 下位机上传图片
   ↓
2. 服务端保存文件并分配 file_id
   ↓
3. 服务端通过 WebSocket 推送通知（包含 file_id）
   ↓
4. 上位机图片查看器收到通知
   ↓
5. 通过 API 下载图片到 data/image/{device_id}/
   ↓
6. 显示在 8 个区域之一
   ↓
7. 更新批次信息
   ↓
8. 保存到历史记录
```

## 📝 使用示例

### 电量数据查看器

1. **打开查看器**
   - 从菜单选择"数据监控 -> 电量数据查看器"

2. **等待通知**
   - 当下位机上传数据时，会自动：
     - 显示下载状态
     - 下载文件到本地
     - 解析并显示数据
     - 生成图表

3. **查看数据**
   - 实时数据选项卡：查看最新数据和条形图
   - 历史数据选项卡：查看历史趋势

### 几何量图片查看器

1. **打开查看器**
   - 从菜单选择"数据监控 -> 几何量图片查看器"

2. **等待通知**
   - 当下位机上传图片时，会自动：
     - 显示下载状态
     - 下载图片到本地
     - 显示在空闲区域
     - 更新批次信息

3. **查看图片**
   - 实时识别选项卡：查看最新图片和识别结果
   - 历史识别选项卡：查看所有历史记录

## 🎨 界面展示

### 电量数据查看器

```
┌─────────────────────────────────────────────────┐
│ 状态: 下载完成 - 设备 123            [刷新数据] │
├─────────────────────────────────────────────────┤
│ [实时数据] [历史数据]                           │
├─────────────────────────────────────────────────┤
│ 当前文件信息                                    │
│ 文件: 20251211_111324_TA3310三相表数据.xlsx     │
│ 接收时间: 2025-12-11 11:13:24                  │
│ 设备: 123                                       │
├─────────────────────────────────────────────────┤
│ 选择设备: [Sheet1 ▼]                           │
├─────────────────────────────────────────────────┤
│ 数据表格                                        │
│ ┌─────────┬──────┬──────┬──────┬────────┐      │
│ │ 参数    │ A相  │ B相  │ C相  │ 总计   │      │
│ ├─────────┼──────┼──────┼──────┼────────┤      │
│ │ 电压(V) │ 220  │ 221  │ 219  │ --     │      │
│ │ 电流(A) │ 5.0  │ 5.1  │ 4.9  │ --     │      │
│ └─────────┴──────┴──────┴──────┴────────┘      │
├─────────────────────────────────────────────────┤
│ [三相电压条形图]  [三相电流条形图]             │
│      ▓▓▓             ▓▓▓                        │
│      ▓▓▓             ▓▓▓                        │
│   A  B  C         A  B  C                       │
└─────────────────────────────────────────────────┘
```

### 几何量图片查看器

```
┌─────────────────────────────────────────────────┐
│ 状态: 下载完成 - 设备 123  [批量识别] [清空]   │
├─────────────────────────────────────────────────┤
│ [实时识别] [历史识别]                           │
├─────────────────────────────────────────────────┤
│ 当前批次信息                                    │
│ 设备: 123  接收时间: 2025-12-11 11:13:24       │
│ 图片数量: 3                                     │
├─────────────────────────────────────────────────┤
│ ┌───────────┬───────────┐ ┌───────────┬───────────┐
│ │位置 1     │位置 2     │ │位置 3     │位置 4     │
│ │ [原图][识别] [原图][识别]│ [原图][识别] [  ][  ] │
│ │ 🖼️   🖼️  │ 🖼️   🖼️  │ │ 🖼️   🖼️  │         │
│ │ [识别]    │ [识别]    │ │ [识别]    │         │
│ └───────────┴───────────┘ └───────────┴───────────┘
│ ┌───────────┬───────────┐ ┌───────────┬───────────┐
│ │位置 5     │位置 6     │ │位置 7     │位置 8     │
│ │ [  ][  ]  │ [  ][  ]  │ │ [  ][  ]  │ [  ][  ]  │
│ │           │           │ │           │           │
│ └───────────┴───────────┘ └───────────┴───────────┘
└─────────────────────────────────────────────────┘
```

## ⚠️ 注意事项

1. **网络连接**
   - 确保上位机能访问服务端 API
   - 下载大文件时可能需要等待

2. **磁盘空间**
   - data 目录会持续增长
   - 定期清理不需要的历史数据

3. **Excel 格式**
   - 解析器会智能识别参数名
   - 如果格式特殊，可能需要调整解析逻辑

4. **图片显示**
   - 最多同时显示 8 张图片
   - 超过 8 张时需要清空后重新接收

## 🔧 故障排除

### 问题：窗口显示"缺少 file_id 或 server_client 未初始化"

**解决方法：**
1. 检查服务端是否更新（包含 file_id 字段）
2. 检查上位机是否正确配置服务器地址
3. 重启上位机程序

### 问题：Excel 数据解析失败

**解决方法：**
1. 打开下载的 Excel 文件检查格式
2. 修改 `parse_sheet_data` 方法适配实际格式
3. 查看日志了解具体错误

### 问题：图片不显示

**解决方法：**
1. 检查图片文件是否下载成功（查看 data/image 目录）
2. 检查图片格式是否支持（png, jpg, jpeg, bmp）
3. 查看日志了解具体错误

### 问题：下载失败

**解决方法：**
1. 检查网络连接
2. 检查服务端是否运行
3. 检查 file_id 是否有效
4. 查看日志了解具体错误

## 🚀 后续优化

1. **下载进度显示** - 大文件下载时显示进度条
2. **断点续传** - 支持下载中断后继续
3. **批量下载** - 一次下载多个文件
4. **缓存管理** - 自动清理旧数据
5. **离线模式** - 支持查看已下载的数据
6. **数据对比** - 多个设备数据横向对比
7. **导出报表** - 导出分析结果

---

✅ 所有功能已实现并测试通过！

