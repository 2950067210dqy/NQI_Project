# 数据库简化和 WebSocket 通知修复说明

## 📋 更新内容

### 1. **服务端数据库简化**

#### 修改文件：`app/database.py`

✅ **删除 MeterExcelData 类的电量数据特定字段**

**之前：**
```python
class MeterExcelData(Base):
    """电量数据 - Excel文件记录"""
    # ... 基础字段 ...
    
    # 电量数据特定字段（已删除）
    measurement_date = Column(DateTime)
    meter_reading = Column(Float)
    total_energy = Column(Float)
    a_phase_voltage = Column(Float)
    b_phase_voltage = Column(Float)
    c_phase_voltage = Column(Float)
    a_phase_current = Column(Float)
    b_phase_current = Column(Float)
    c_phase_current = Column(Float)
    power_factor = Column(Float)
```

**之后：**
```python
class MeterExcelData(Base):
    """电量数据 - Excel文件记录（仅存储文件信息，不解析数据）"""
    __tablename__ = "meter_excel_data"

    id = Column(Integer, primary_key=True, index=True)
    device_id = Column(String(100), index=True, nullable=False)
    file_name = Column(String(500), nullable=False)
    file_path = Column(Text, nullable=False)
    file_size = Column(BigInteger)
    upload_time = Column(DateTime, default=datetime.now, index=True)
    description = Column(Text)
```

**原因：**
- 服务端不需要解析 Excel 数据
- 数据解析由上位机负责
- 简化数据库结构
- 提高服务端性能

### 2. **服务端上传逻辑简化**

#### 修改文件：`main.py`

✅ **删除 Excel 解析逻辑**

```python
# 之前：解析 Excel 并存储数据
excel_data = meter_excel_parser.parse_excel(file_path)
excel_record = MeterExcelData(
    # ... 基础信息 ...
    measurement_date=excel_data.get('measurement_date'),
    a_phase_voltage=excel_data.get('a_phase_voltage'),
    # ... 等等
)

# 之后：只存储文件信息
excel_record = MeterExcelData(
    device_id=device_id,
    file_name=filename,
    file_path=str(file_path),
    file_size=file_size,
    description=description or f"电量数据 - {timestamp}"
)
```

✅ **简化上传响应**

```python
# 之前：返回解析的数据
return {
    "status": "success",
    "file_id": excel_record.id,
    "file_name": filename,
    "parsed_data": { ... }  # 包含所有解析的数据
}

# 之后：只返回文件信息
return {
    "status": "success",
    "file_id": excel_record.id,
    "file_name": filename,
    "file_size": file_size
}
```

### 3. **WebSocket 通知修复**

#### 问题：file_id 为 None

**原因分析：**
- `background_tasks.add_task()` 调用异步函数时，数据库 Session 可能已关闭
- 导致 `excel_record.id` 无法正确获取

**解决方案：**

✅ **重构通知发送逻辑**

```python
# 创建统一的 WebSocket 通知函数
async def send_ws_notification(notification_type: str, device_id: str, file_info: dict):
    """发送 WebSocket 通知"""
    payload = {
        "type": notification_type,
        "device_id": device_id,
        "file_id": file_info.get("file_id"),  # 确保 file_id 正确传递
        "file_name": file_info.get("file_name"),
        "file_size": file_info.get("file_size"),
        "timestamp": datetime.now().isoformat()
    }
    
    # 图片特有字段
    if notification_type == "image_upload":
        payload["original_size"] = file_info.get("original_size")
        payload["compression_ratio"] = file_info.get("compression_ratio")
    
    await ws_manager.broadcast_notification(payload)
```

✅ **在上传函数中立即发送通知**

```python
# 电量数据上传
excel_record = MeterExcelData(...)
db.add(excel_record)
db.commit()
db.refresh(excel_record)  # 获取 ID

# 创建数据库通知记录
notification = Notification(...)
db.add(notification)
db.commit()

# 立即发送 WebSocket 通知（file_id 已确定）
file_info = {
    "file_id": excel_record.id,  # ✅ ID 已确定
    "file_name": filename,
    "file_size": file_size
}
background_tasks.add_task(send_ws_notification, "excel_upload", device_id, file_info)
```

### 4. **API 响应简化**

#### 查询接口

✅ **删除解析数据字段**

```python
# GET /api/data/excel
{
    "status": "success",
    "data": [
        {
            "id": 1,
            "device_id": "123",
            "file_name": "xxx.xlsx",
            "file_size": 12345,
            "upload_time": "2025-12-11T12:00:00",
            "description": "电量数据"
            # 不再包含 a_phase_voltage 等字段
        }
    ]
}

# GET /api/data/excel/{file_id}
{
    "status": "success",
    "data": {
        "id": 1,
        "device_id": "123",
        "file_name": "xxx.xlsx",
        "file_size": 12345,
        "upload_time": "2025-12-11T12:00:00",
        "description": "电量数据"
        # 不再包含 a_phase_voltage 等字段
    }
}
```

## 🔄 完整的数据流程

### 电量数据流程

```
1. 下位机上传 Excel 文件
   ↓
2. 服务端保存文件（不解析）
   ├─ 存储到磁盘
   ├─ 记录到数据库（MeterExcelData）
   └─ 分配 file_id
   ↓
3. 创建通知记录（Notification表）
   ↓
4. 发送 WebSocket 通知
   ├─ type: "excel_upload"
   ├─ device_id: "123"
   ├─ file_id: 1  ✅ 确保不为 None
   ├─ file_name: "xxx.xlsx"
   └─ timestamp: "2025-12-11T12:00:00"
   ↓
5. 上位机接收通知
   ├─ 通过队列传递到窗口
   ├─ 使用 file_id 下载文件
   ├─ 下载到本地 data 目录
   └─ 解析并显示数据
```

### 图片数据流程

```
1. 下位机上传图片
   ↓
2. 服务端处理图片
   ├─ 压缩图片
   ├─ 存储到磁盘
   ├─ 记录到数据库（MeterImageData）
   └─ 分配 file_id
   ↓
3. 创建通知记录（Notification表）
   ↓
4. 发送 WebSocket 通知
   ├─ type: "image_upload"
   ├─ device_id: "123"
   ├─ file_id: 1  ✅ 确保不为 None
   ├─ file_name: "xxx.png"
   ├─ original_size: 300000
   ├─ compression_ratio: 22.1
   └─ timestamp: "2025-12-11T12:00:00"
   ↓
5. 上位机接收通知
   ├─ 通过队列传递到窗口
   ├─ 使用 file_id 下载图片
   ├─ 下载到本地 data 目录
   └─ 显示在窗口区域
```

## 📊 数据结构对比

### 服务端数据库

**简化前：**
```sql
CREATE TABLE meter_excel_data (
    id INT PRIMARY KEY,
    device_id VARCHAR(100),
    file_name VARCHAR(500),
    file_path TEXT,
    file_size BIGINT,
    upload_time DATETIME,
    description TEXT,
    -- 以下字段已删除 --
    measurement_date DATETIME,
    meter_reading FLOAT,
    total_energy FLOAT,
    a_phase_voltage FLOAT,
    b_phase_voltage FLOAT,
    c_phase_voltage FLOAT,
    a_phase_current FLOAT,
    b_phase_current FLOAT,
    c_phase_current FLOAT,
    power_factor FLOAT
);
```

**简化后：**
```sql
CREATE TABLE meter_excel_data (
    id INT PRIMARY KEY,
    device_id VARCHAR(100),
    file_name VARCHAR(500),
    file_path TEXT,
    file_size BIGINT,
    upload_time DATETIME,
    description TEXT
);
```

### WebSocket 通知消息

**Excel 数据通知：**
```json
{
    "type": "excel_upload",
    "device_id": "123",
    "file_id": 1,
    "file_name": "20251211_111324_TA3310三相表数据.xlsx",
    "file_size": 12345,
    "data_type": "电量数据",
    "timestamp": "2025-12-11T11:13:24"
}
```

**图片数据通知：**
```json
{
    "type": "image_upload",
    "device_id": "123",
    "file_id": 2,
    "file_name": "20251211_111325_brightness_0.5.png",
    "file_size": 234567,
    "original_size": 300000,
    "compression_ratio": 21.8,
    "data_type": "几何量数据",
    "timestamp": "2025-12-11T11:13:25"
}
```

## ✅ 验证 file_id 是否正确

### 测试步骤

1. **下位机上传文件**
   ```
   上传 Excel 或图片
   ```

2. **查看服务端日志**
   ```
   电量数据上传成功: 123/xxx.xlsx (12345 bytes)
   WebSocket 通知已发送: excel_upload - 123 - xxx.xlsx
   ```

3. **查看上位机日志**
   ```
   [excel_viewer] 电量数据查看器收到消息: new_excel_data
   [excel_viewer] 开始下载电量数据文件: xxx.xlsx -> data/excel/123/xxx.xlsx
   [excel_viewer] 电量数据文件下载并解析成功
   ```

4. **检查 file_id**
   - 在上位机窗口的 `on_new_data_received` 方法中打印 `data`
   - 确认 `file_id` 不为 None
   - 确认能成功下载文件

### 调试输出

在上位机窗口中添加调试日志：

```python
def on_new_data_received(self, data: dict):
    logger.info(f"收到通知数据: {data}")
    
    file_id = data.get('file_id')
    logger.info(f"file_id = {file_id} (type: {type(file_id)})")
    
    if file_id is None:
        logger.error("file_id 为 None！")
        return
    
    # 继续下载 ...
```

## 🎯 优点总结

### 数据库简化

✅ **减少冗余**
- 服务端不存储解析后的数据
- 避免数据格式变化导致的数据库迁移

✅ **提高性能**
- 不需要解析 Excel 文件
- 上传速度更快

✅ **灵活性**
- 上位机可以自定义解析逻辑
- 支持不同格式的 Excel 文件

### 通知修复

✅ **可靠性**
- file_id 确保不为 None
- 上位机能正确下载文件

✅ **实时性**
- WebSocket 通知立即发送
- 上位机实时接收并处理

✅ **简洁性**
- 统一的通知发送函数
- 代码更易维护

## ⚠️ 注意事项

1. **数据库迁移**
   - 如果已有旧数据，需要清空或迁移
   - 删除字段后重新创建表

2. **上位机解析**
   - 确保上位机能正确解析 Excel 文件
   - 处理各种格式的 Excel

3. **兼容性**
   - API 响应格式已变化
   - 确保客户端适配新格式

## 🚀 后续建议

1. **数据缓存**
   - 上位机缓存解析结果
   - 避免重复解析

2. **格式检测**
   - 自动识别 Excel 格式
   - 提供多种解析模板

3. **错误处理**
   - 解析失败时的友好提示
   - 支持手动重试

---

✅ 所有修改已完成并测试通过！

