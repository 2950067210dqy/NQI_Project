# ç•Œé¢åŠŸèƒ½å¢å¼ºè¯´æ˜

**å®æ–½æ—¥æœŸ**: 2025-12-12

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. è‡ªå®šä¹‰çŠ¶æ€æ æ˜¾ç¤ºä¸‹è½½é€šçŸ¥

**æ–‡ä»¶**: `public/component/custom_status_bar.py`

**æ–°å¢åŠŸèƒ½**:
- âœ… æ·»åŠ ä¸‹è½½çŠ¶æ€æ ‡ç­¾æ˜¾ç¤ºå®æ—¶ä¸‹è½½ä¿¡æ¯
- âœ… è¿æ¥ä¸‹è½½ç®¡ç†å™¨ä¿¡å·ï¼Œè‡ªåŠ¨æ›´æ–°çŠ¶æ€
- âœ… ç”µé‡æ•°æ®å’Œå‡ ä½•é‡æ•°æ®ä¸‹è½½å®Œæˆåæ˜¾ç¤ºé€šçŸ¥
- âœ… 3ç§’åè‡ªåŠ¨æ¢å¤"å°±ç»ª"çŠ¶æ€

**å®ç°ä»£ç **:
```python
# æ·»åŠ ä¸‹è½½çŠ¶æ€æ˜¾ç¤º
self.download_status_label = QLabel("ä¸‹è½½: å°±ç»ª")
self.download_status_label.setStyleSheet("QLabel { color: green; font-weight: bold; }")
self.addWidget(self.download_status_label)

# è¿æ¥ä¸‹è½½ç®¡ç†å™¨ä¿¡å·
download_manager.excel_data_ready.connect(
    lambda path, device: self.on_download_completed("ç”µé‡æ•°æ®", device)
)
download_manager.image_data_ready.connect(
    lambda path, device: self.on_download_completed("å‡ ä½•é‡æ•°æ®", device)
)

def on_download_completed(self, data_type: str, device_id: str):
    """ä¸‹è½½å®Œæˆå›è°ƒ"""
    message = f"ä¸‹è½½: {data_type} (è®¾å¤‡{device_id}) âœ“"
    self.download_status_label.setText(message)
    # 3ç§’åæ¢å¤
    QTimer.singleShot(3000, lambda: self.download_status_label.setText("ä¸‹è½½: å°±ç»ª"))
```

**æ•ˆæœ**:
- å®æ—¶æ˜¾ç¤º: `ä¸‹è½½: ç”µé‡æ•°æ® (è®¾å¤‡12323) âœ“`
- ç»¿è‰²å­—ä½“ï¼ŒåŠ ç²—æ˜¾ç¤º

---

### 2. å‡ ä½•é‡é¡µé¢å›¾ç‰‡å¤§å°é™åˆ¶

**æ–‡ä»¶**: `Module/image_data_viewer/index/image_viewer_window.py`

**ä¿®æ”¹å†…å®¹**:
```python
# åŸå›¾åŒºåŸŸ - å›ºå®šå¤§å°
self.original_label.setFixedSize(150, 150)  # ä¹‹å‰æ˜¯ setMinimumSize(200, 150)

# è¯†åˆ«å›¾åŒºåŸŸ - å›ºå®šå¤§å°
self.recognized_label.setFixedSize(150, 150)  # ä¹‹å‰æ˜¯ setMinimumSize(200, 150)
```

**æ•ˆæœ**:
- å›¾ç‰‡ç»Ÿä¸€æ˜¾ç¤ºä¸º 150Ã—150 åƒç´ 
- å¸ƒå±€æ›´ç´§å‡‘ï¼Œå¯ä»¥æ˜¾ç¤ºæ›´å¤šå›¾ç‰‡
- è‡ªåŠ¨ç¼©æ”¾ä¿æŒæ¯”ä¾‹

---

### 3. å‡ ä½•é‡é¡µé¢æ˜¾ç¤ºè¯†åˆ«ç»“æœ

**æ–‡ä»¶**: `Module/image_data_viewer/index/image_viewer_window.py`

**æ–°å¢åŠŸèƒ½**:
- âœ… åœ¨è¯†åˆ«å›¾ä¸‹æ–¹æ˜¾ç¤ºè¯†åˆ«ç»“æœ
- âœ… è¯†åˆ«æ•…éšœæ˜¾ç¤ºçº¢è‰²å­—ä½“
- âœ… æœªè¯†åˆ«æ•…éšœæ˜¾ç¤ºç»¿è‰²å­—ä½“
- âœ… éšæœºç”Ÿæˆè¯†åˆ«ç»“æœï¼ˆä½œä¸ºæ¼”ç¤ºï¼‰

**å®ç°ä»£ç **:
```python
# åœ¨è¯†åˆ«å›¾ç»„ä»¶ä¸­æ·»åŠ ç»“æœæ ‡ç­¾
self.recognition_result_label = QLabel("ç­‰å¾…è¯†åˆ«...")
self.recognition_result_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
self.recognition_result_label.setStyleSheet("font-size: 10px; font-weight: bold;")
recognized_layout.addWidget(self.recognition_result_label)

# éšæœºç”Ÿæˆè¯†åˆ«ç»“æœ
import random
has_fault = random.choice([True, False])

# æ˜¾ç¤ºç»“æœ
if has_fault:
    self.recognition_result_label.setText("è¯†åˆ«æ•…éšœ âš ")
    self.recognition_result_label.setStyleSheet("color: red; font-size: 11px; font-weight: bold;")
else:
    self.recognition_result_label.setText("æœªè¯†åˆ«æ•…éšœ âœ“")
    self.recognition_result_label.setStyleSheet("color: green; font-size: 11px; font-weight: bold;")
```

**æ˜¾ç¤ºæ•ˆæœ**:
- è¯†åˆ«æ•…éšœ: çº¢è‰²å­—ä½“ `è¯†åˆ«æ•…éšœ âš `
- æœªè¯†åˆ«æ•…éšœ: ç»¿è‰²å­—ä½“ `æœªè¯†åˆ«æ•…éšœ âœ“`

---

## ğŸ“‹ å¾…å®ç°åŠŸèƒ½

### 4. ç”µé‡æ•°æ®é¡µé¢ - æ·»åŠ æ—¥å¿—æ¡†

**éœ€æ±‚**: åœ¨ç”µé‡æ•°æ®é¡µé¢æ·»åŠ æ—¥å¿—æ˜¾ç¤ºæ¡†ï¼Œå®æ—¶æ˜¾ç¤ºé¡µé¢æ“ä½œæ—¥å¿—

**å»ºè®®å®ç°æ–¹æ¡ˆ**:

```python
# åœ¨ excel_viewer_window.py ä¸­æ·»åŠ 
from PyQt6.QtWidgets import QTextEdit

class ExcelDataViewerWindow(ThemedWindow):
    def init_ui(self):
        # ... ç°æœ‰ä»£ç  ...
        
        # æ·»åŠ æ—¥å¿—æ¡†é€‰é¡¹å¡
        self.log_tab = self.create_log_tab()
        self.main_tabs.addTab(self.log_tab, "æ—¥å¿—")
    
    def create_log_tab(self):
        """åˆ›å»ºæ—¥å¿—é€‰é¡¹å¡"""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # æ—¥å¿—æ–‡æœ¬æ¡†
        self.log_text = QTextEdit()
        self.log_text.setReadOnly(True)
        self.log_text.setStyleSheet("font-family: Consolas; font-size: 10px;")
        layout.addWidget(self.log_text)
        
        # æ¸…ç©ºæŒ‰é’®
        clear_btn = QPushButton("æ¸…ç©ºæ—¥å¿—")
        clear_btn.clicked.connect(self.log_text.clear)
        layout.addWidget(clear_btn)
        
        return tab
    
    def log_message(self, message: str):
        """æ·»åŠ æ—¥å¿—æ¶ˆæ¯"""
        timestamp = datetime.now().strftime('%H:%M:%S')
        self.log_text.append(f"[{timestamp}] {message}")
```

---

### 5. ç”µé‡æ•°æ®é¡µé¢ - æ·»åŠ æ—¶é—´è½´æŠ˜çº¿å›¾

**éœ€æ±‚**: æ ¹æ®ç¼“å­˜ä¸­æ¯ä¸ªexcelæ•°æ®ï¼Œå½¢æˆä»¥æ—¶é—´ä¸ºXè½´çš„æ•°æ®æŠ˜çº¿å›¾

**å»ºè®®å®ç°æ–¹æ¡ˆ**:

```python
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg
from matplotlib.figure import Figure
import matplotlib.dates as mdates

class ExcelDataViewerWindow(ThemedWindow):
    def create_trend_chart_tab(self):
        """åˆ›å»ºè¶‹åŠ¿å›¾é€‰é¡¹å¡"""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # è®¾å¤‡é€‰æ‹©
        device_combo = QComboBox()
        device_combo.addItems(cache_manager.get_excel_devices())
        device_combo.currentTextChanged.connect(self.update_trend_chart)
        layout.addWidget(device_combo)
        
        # å›¾è¡¨
        self.trend_figure = Figure(figsize=(12, 6))
        self.trend_canvas = FigureCanvasQTAgg(self.trend_figure)
        layout.addWidget(self.trend_canvas)
        
        return tab
    
    def update_trend_chart(self, device_id: str):
        """æ›´æ–°è¶‹åŠ¿å›¾"""
        # ä»ç¼“å­˜è¯»å–å†å²æ•°æ®
        records = cache_manager.get_excel_records(device_id=device_id, limit=50)
        
        # è§£ææ•°æ®
        timestamps = []
        values = []
        
        for record in records:
            timestamps.append(datetime.strptime(record['timestamp'], '%Y-%m-%d %H:%M:%S'))
            # è§£æExcelè·å–æ•°å€¼
            # values.append(...)
        
        # ç»˜åˆ¶æŠ˜çº¿å›¾
        ax = self.trend_figure.add_subplot(111)
        ax.clear()
        ax.plot(timestamps, values, marker='o')
        ax.set_xlabel('æ—¶é—´')
        ax.set_ylabel('æ•°å€¼')
        ax.set_title(f'è®¾å¤‡ {device_id} æ•°æ®è¶‹åŠ¿')
        ax.xaxis.set_major_formatter(mdates.DateFormatter('%H:%M'))
        ax.grid(True, alpha=0.3)
        
        self.trend_canvas.draw()
```

---

### 6. ç”µé‡æ•°æ®é¡µé¢ - æ·»åŠ ç¼“å­˜æ•°æ®è¡¨æ ¼

**éœ€æ±‚**: æ˜¾ç¤ºç¼“å­˜ä¸­æ¯ä¸ªexcelçš„è§£ææ•°æ®

**å»ºè®®å®ç°æ–¹æ¡ˆ**:

```python
from PyQt6.QtWidgets import QTableWidget, QTableWidgetItem

class ExcelDataViewerWindow(ThemedWindow):
    def create_cache_table_tab(self):
        """åˆ›å»ºç¼“å­˜æ•°æ®è¡¨æ ¼é€‰é¡¹å¡"""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # è¡¨æ ¼
        self.cache_table = QTableWidget()
        self.cache_table.setColumnCount(7)
        self.cache_table.setHorizontalHeaderLabels([
            "è®¾å¤‡ID", "æ–‡ä»¶å", "æ—¶é—´", "Sheetæ•°é‡", 
            "é¢å®šç”µå‹", "é¢å®šé¢‘ç‡", "æ“ä½œ"
        ])
        layout.addWidget(self.cache_table)
        
        # åˆ·æ–°æŒ‰é’®
        refresh_btn = QPushButton("åˆ·æ–°")
        refresh_btn.clicked.connect(self.load_cache_data_to_table)
        layout.addWidget(refresh_btn)
        
        # åˆå§‹åŠ è½½
        self.load_cache_data_to_table()
        
        return tab
    
    def load_cache_data_to_table(self):
        """åŠ è½½ç¼“å­˜æ•°æ®åˆ°è¡¨æ ¼"""
        records = cache_manager.get_excel_records(limit=100)
        
        self.cache_table.setRowCount(len(records))
        
        for row, record in enumerate(records):
            self.cache_table.setItem(row, 0, QTableWidgetItem(record['device_id']))
            self.cache_table.setItem(row, 1, QTableWidgetItem(record['file_name']))
            self.cache_table.setItem(row, 2, QTableWidgetItem(record['timestamp']))
            self.cache_table.setItem(row, 3, QTableWidgetItem(str(record['sheet_count'])))
            self.cache_table.setItem(row, 4, 
                QTableWidgetItem(f"{record['rated_voltage']}{record['rated_voltage_unit']}"))
            self.cache_table.setItem(row, 5, 
                QTableWidgetItem(f"{record['rated_frequency']}{record['rated_frequency_unit']}"))
            
            # æŸ¥çœ‹æŒ‰é’®
            view_btn = QPushButton("æŸ¥çœ‹")
            view_btn.clicked.connect(lambda checked, r=record: self.view_record(r))
            self.cache_table.setCellWidget(row, 6, view_btn)
```

---

### 7. å‡ ä½•é‡é¡µé¢ - æ·»åŠ æ—¥å¿—æ¡†

**å®ç°æ–¹å¼åŒç”µé‡æ•°æ®é¡µé¢**ï¼Œå‚è€ƒç¬¬4ç‚¹ã€‚

---

### 8. å‡ ä½•é‡é¡µé¢ - æ·»åŠ ç¼“å­˜æ•°æ®è¡¨æ ¼

**éœ€æ±‚**: æ˜¾ç¤ºç¼“å­˜ä¸­æ¯ä¸ªå›¾ç‰‡åŠè¯†åˆ«ç»“æœ

**å»ºè®®å®ç°æ–¹æ¡ˆ**:

```python
class ImageDataViewerWindow(ThemedWindow):
    def create_cache_table_tab(self):
        """åˆ›å»ºç¼“å­˜æ•°æ®è¡¨æ ¼é€‰é¡¹å¡"""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # è¡¨æ ¼
        self.cache_table = QTableWidget()
        self.cache_table.setColumnCount(6)
        self.cache_table.setHorizontalHeaderLabels([
            "è®¾å¤‡ID", "æ–‡ä»¶å", "æ—¶é—´", "è¯†åˆ«ç»“æœ", "ç¼©ç•¥å›¾", "æ“ä½œ"
        ])
        self.cache_table.setRowHeight(0, 80)  # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºç¼©ç•¥å›¾
        layout.addWidget(self.cache_table)
        
        # åˆ·æ–°æŒ‰é’®
        refresh_btn = QPushButton("åˆ·æ–°")
        refresh_btn.clicked.connect(self.load_cache_images_to_table)
        layout.addWidget(refresh_btn)
        
        # åˆå§‹åŠ è½½
        self.load_cache_images_to_table()
        
        return tab
    
    def load_cache_images_to_table(self):
        """åŠ è½½ç¼“å­˜å›¾ç‰‡åˆ°è¡¨æ ¼"""
        records = cache_manager.get_image_records(limit=100)
        
        self.cache_table.setRowCount(len(records))
        
        for row, record in enumerate(records):
            self.cache_table.setItem(row, 0, QTableWidgetItem(record['device_id']))
            self.cache_table.setItem(row, 1, QTableWidgetItem(record['file_name']))
            self.cache_table.setItem(row, 2, QTableWidgetItem(record['timestamp']))
            
            # è¯†åˆ«ç»“æœï¼ˆéšæœºï¼‰
            import random
            has_fault = random.choice([True, False])
            result_text = "è¯†åˆ«æ•…éšœ" if has_fault else "æœªè¯†åˆ«æ•…éšœ"
            result_item = QTableWidgetItem(result_text)
            result_item.setForeground(Qt.GlobalColor.red if has_fault else Qt.GlobalColor.green)
            self.cache_table.setItem(row, 3, result_item)
            
            # ç¼©ç•¥å›¾
            if Path(record['original_path']).exists():
                thumbnail_label = QLabel()
                pixmap = QPixmap(record['original_path'])
                thumbnail_label.setPixmap(pixmap.scaled(60, 60, 
                    Qt.AspectRatioMode.KeepAspectRatio))
                self.cache_table.setCellWidget(row, 4, thumbnail_label)
            
            # æŸ¥çœ‹æŒ‰é’®
            view_btn = QPushButton("æŸ¥çœ‹")
            view_btn.clicked.connect(lambda checked, r=record: self.view_image_record(r))
            self.cache_table.setCellWidget(row, 5, view_btn)
```

---

## ğŸ“ å®ç°ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆå»ºè®®ç«‹å³å®ç°ï¼‰
1. âœ… è‡ªå®šä¹‰çŠ¶æ€æ æ˜¾ç¤ºä¸‹è½½é€šçŸ¥ - **å·²å®Œæˆ**
2. âœ… å‡ ä½•é‡é¡µé¢é™åˆ¶å›¾ç‰‡å¤§å° - **å·²å®Œæˆ**
3. âœ… å‡ ä½•é‡é¡µé¢æ˜¾ç¤ºè¯†åˆ«ç»“æœ - **å·²å®Œæˆ**
4. ğŸ”² ç”µé‡æ•°æ®é¡µé¢æ·»åŠ æ—¥å¿—æ¡† - **å¾…å®ç°**
5. ğŸ”² å‡ ä½•é‡é¡µé¢æ·»åŠ æ—¥å¿—æ¡† - **å¾…å®ç°**

### ä¸­ä¼˜å…ˆçº§ï¼ˆåç»­å®ç°ï¼‰
6. ğŸ”² ç”µé‡æ•°æ®é¡µé¢æ·»åŠ ç¼“å­˜æ•°æ®è¡¨æ ¼
7. ğŸ”² å‡ ä½•é‡é¡µé¢æ·»åŠ ç¼“å­˜æ•°æ®è¡¨æ ¼

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰
8. ğŸ”² ç”µé‡æ•°æ®é¡µé¢æ·»åŠ æ—¶é—´è½´æŠ˜çº¿å›¾ï¼ˆéœ€è¦å¤æ‚çš„æ•°æ®å¤„ç†ï¼‰

---

## ğŸ”¨ å¿«é€Ÿå®ç°æŒ‡å—

### æ·»åŠ æ—¥å¿—æ¡†ï¼ˆé€šç”¨æ–¹æ³•ï¼‰

**æ­¥éª¤1**: åˆ›å»ºæ—¥å¿—å¤„ç†å™¨ç±»

```python
# public/util/qt_log_handler.py
from PyQt6.QtCore import QObject, pyqtSignal

class QtLogHandler(QObject):
    """Qtæ—¥å¿—å¤„ç†å™¨"""
    log_signal = pyqtSignal(str)
    
    def emit_log(self, message: str):
        self.log_signal.emit(message)

# å…¨å±€å®ä¾‹
qt_log_handler = QtLogHandler()
```

**æ­¥éª¤2**: åœ¨é¡µé¢ä¸­ä½¿ç”¨

```python
# å¯¼å…¥
from public.util.qt_log_handler import qt_log_handler

# åˆå§‹åŒ–æ—¶è¿æ¥
def __init__(self):
    qt_log_handler.log_signal.connect(self.append_log)

# æ·»åŠ æ—¥å¿—æ–¹æ³•
def append_log(self, message: str):
    timestamp = datetime.now().strftime('%H:%M:%S')
    self.log_text.append(f"[{timestamp}] {message}")

# ä½¿ç”¨
qt_log_handler.emit_log("æ•°æ®åŠ è½½å®Œæˆ")
```

---

## ğŸ“Š æ•ˆæœé¢„è§ˆ

### å·²å®ŒæˆåŠŸèƒ½æ•ˆæœ

**1. çŠ¶æ€æ ä¸‹è½½é€šçŸ¥**:
```
æ—¶é—´: 14:30:25 | RUNNING | å½“å‰æœªè¿æ¥æœåŠ¡å™¨ | ä¸‹è½½: ç”µé‡æ•°æ® (è®¾å¤‡12323) âœ“ | [æ•™ç¨‹å¸®åŠ©]
```

**2. å‡ ä½•é‡é¡µé¢å›¾ç‰‡æ˜¾ç¤º**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½ç½® 1                              â”‚
â”‚ filename.png                        â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ â”‚ åŸå›¾   â”‚        â”‚ è¯†åˆ«å›¾ â”‚       â”‚
â”‚ â”‚150x150 â”‚        â”‚150x150 â”‚       â”‚
â”‚ â”‚        â”‚        â”‚        â”‚       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚è¯†åˆ«æ•…éšœâš â”‚       â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                   (çº¢è‰²å­—ä½“)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ åç»­æ‰©å±•å»ºè®®

### 1. å®æ—¶æ—¥å¿—æ¨é€

ä½¿ç”¨ loguru çš„ handler å°†æ—¥å¿—å®æ—¶æ¨é€åˆ°UI:

```python
from loguru import logger

# åˆ›å»ºè‡ªå®šä¹‰handler
def qt_log_sink(message):
    qt_log_handler.emit_log(message)

# æ·»åŠ handler
logger.add(qt_log_sink, format="{time:HH:mm:ss} | {level} | {message}")
```

### 2. è¯†åˆ«ç»“æœæŒä¹…åŒ–

å°†è¯†åˆ«ç»“æœä¿å­˜åˆ°ç¼“å­˜:

```python
# åœ¨cache_managerä¸­æ·»åŠ 
def update_image_recognition_result(self, file_path: str, has_fault: bool):
    """æ›´æ–°å›¾ç‰‡è¯†åˆ«ç»“æœ"""
    conn = sqlite3.connect(str(self.image_db_path))
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE image_records 
        SET extra_data = json_set(extra_data, '$.has_fault', ?)
        WHERE file_path = ?
    """, (has_fault, file_path))
    conn.commit()
    conn.close()
```

### 3. æ•°æ®å¯¼å‡ºåŠŸèƒ½

æ·»åŠ å¯¼å‡ºåˆ°ExcelåŠŸèƒ½:

```python
import pandas as pd

def export_cache_to_excel(self):
    """å¯¼å‡ºç¼“å­˜æ•°æ®åˆ°Excel"""
    records = cache_manager.get_excel_records(limit=1000)
    df = pd.DataFrame(records)
    df.to_excel('cache_export.xlsx', index=False)
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- `Module/ç»Ÿä¸€ä¸‹è½½æ¶æ„è¯´æ˜.md` - ä¸‹è½½æ¶æ„è¯´æ˜
- `Module/SQLiteç¼“å­˜åŠŸèƒ½å®ç°è¯´æ˜.md` - ç¼“å­˜åŠŸèƒ½è¯´æ˜
- `Module/å¿«é€Ÿä½¿ç”¨æŒ‡å—.md` - ä½¿ç”¨æŒ‡å—

---

**æ›´æ–°æ—¥æœŸ**: 2025-12-12  
**å®ŒæˆçŠ¶æ€**: 3/8 åŠŸèƒ½å·²å®ç°ï¼Œ5/8 åŠŸèƒ½å¾…å®ç°

