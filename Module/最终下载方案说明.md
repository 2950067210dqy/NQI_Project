# æœ€ç»ˆä¸‹è½½æ–¹æ¡ˆï¼šå¤šçº¿ç¨‹ + é˜Ÿåˆ— + è½®è¯¢

## ğŸ¯ è®¾è®¡æ€æƒ³

**ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼**

### æ ¸å¿ƒç»„ä»¶
1. **ç”Ÿäº§è€…**ï¼šå¤šä¸ªä¸‹è½½çº¿ç¨‹å¹¶è¡Œä¸‹è½½
2. **ç¼“å†²åŒº**ï¼šç»“æœé˜Ÿåˆ—ï¼ˆ`queue.Queue`ï¼‰
3. **æ¶ˆè´¹è€…**ï¼šä¸»çº¿ç¨‹å®šæ—¶å™¨è½®è¯¢é˜Ÿåˆ—

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¸»çº¿ç¨‹ï¼ˆUIï¼‰                          â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å®šæ—¶å™¨     â”‚ æ¯100msè½®è¯¢             â”‚ å¤„ç†ç»“æœ     â”‚    â”‚
â”‚  â”‚ QTimer     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚ åŠ è½½ã€æ˜¾ç¤º    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â†‘                                                     â”‚
â”‚         â”‚ ä»é˜Ÿåˆ—å–ç»“æœ                                        â”‚
â”‚         â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ç»“æœé˜Ÿåˆ— (queue.Queue)                    â”‚   â”‚
â”‚  â”‚  [ç»“æœA] [ç»“æœB] [ç»“æœC] [ç»“æœD] ...                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â†‘           â†‘           â†‘           â†‘                â”‚
â”‚         â”‚           â”‚           â”‚           â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ çº¿ç¨‹1   â”‚  â”‚ çº¿ç¨‹2   â”‚ â”‚ çº¿ç¨‹3   â”‚ â”‚ çº¿ç¨‹4   â”‚  å¹¶è¡Œ    â”‚
â”‚  â”‚ ä¸‹è½½A   â”‚  â”‚ ä¸‹è½½B   â”‚ â”‚ ä¸‹è½½C   â”‚ â”‚ ä¸‹è½½D   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. `ThreadedDownloader`ï¼ˆä¸‹è½½ç®¡ç†å™¨ï¼‰

```python
class ThreadedDownloader:
    def __init__(self):
        self.result_queue = queue.Queue()  # ç»“æœé˜Ÿåˆ—
        self.active_threads = []           # æ´»è·ƒçº¿ç¨‹åˆ—è¡¨
    
    def download(self, task_type, client, file_id, save_path, device_id):
        """å¯åŠ¨ä¸‹è½½çº¿ç¨‹"""
        thread = DownloadThread(..., self.result_queue)
        self.active_threads.append(thread)
        thread.start()
    
    def get_result(self):
        """ä»é˜Ÿåˆ—è·å–ç»“æœï¼ˆéé˜»å¡ï¼‰"""
        return self.result_queue.get_nowait()
    
    def has_results(self):
        """æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦æœ‰ç»“æœ"""
        return not self.result_queue.empty()
```

### 2. `DownloadThread`ï¼ˆä¸‹è½½çº¿ç¨‹ï¼‰

```python
class DownloadThread(QThread):
    def run(self):
        # æ‰§è¡Œä¸‹è½½
        self.client.download_xxx_file(self.file_id, self.save_path)
        
        # âœ… ä¸‹è½½å®Œæˆï¼Œåˆ›å»ºç»“æœå¯¹è±¡
        result = DownloadResult(
            task_type=self.task_type,
            file_path=str(self.save_path),
            device_id=self.device_id,
            success=True
        )
        
        # âœ… æ”¾å…¥é˜Ÿåˆ—ï¼ˆä¸å‘é€ä¿¡å·ï¼‰
        self.result_queue.put(result)
```

### 3. QTimerï¼ˆå®šæ—¶å™¨è½®è¯¢ï¼‰

```python
# åœ¨çª—å£åˆå§‹åŒ–æ—¶
self.result_timer = QTimer(self)
self.result_timer.timeout.connect(self.check_download_results)
self.result_timer.start(100)  # æ¯100msè§¦å‘ä¸€æ¬¡

def check_download_results(self):
    """å®šæ—¶å™¨å›è°ƒï¼šæ£€æŸ¥é˜Ÿåˆ—"""
    if self.downloader.has_results():
        result = self.downloader.get_result()
        if result.success:
            self.on_download_finished(result.file_path, result.device_id)
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### 4ä¸ªæ–‡ä»¶åŒæ—¶ä¸‹è½½

```
1ï¸âƒ£ æ¥æ”¶4ä¸ªä¸‹è½½é€šçŸ¥ï¼ˆå‡ ä¹åŒæ—¶ï¼‰
   
   é€šçŸ¥1 â†’ å¯åŠ¨çº¿ç¨‹1ï¼ˆä¸‹è½½æ–‡ä»¶Aï¼‰
   é€šçŸ¥2 â†’ å¯åŠ¨çº¿ç¨‹2ï¼ˆä¸‹è½½æ–‡ä»¶Bï¼‰
   é€šçŸ¥3 â†’ å¯åŠ¨çº¿ç¨‹3ï¼ˆä¸‹è½½æ–‡ä»¶Cï¼‰
   é€šçŸ¥4 â†’ å¯åŠ¨çº¿ç¨‹4ï¼ˆä¸‹è½½æ–‡ä»¶Dï¼‰

2ï¸âƒ£ å¹¶è¡Œä¸‹è½½ï¼ˆ1ç§’ï¼ŒåŒæ—¶è¿›è¡Œï¼‰
   
   çº¿ç¨‹1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ä¸‹è½½A (1s)
   çº¿ç¨‹2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ä¸‹è½½B (1s)
   çº¿ç¨‹3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ä¸‹è½½C (1s)
   çº¿ç¨‹4: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ä¸‹è½½D (1s)

3ï¸âƒ£ ç»“æœå…¥é˜Ÿï¼ˆæŒ‰å®Œæˆé¡ºåºï¼‰
   
   æ—¶åˆ»1.0s: çº¿ç¨‹2å®Œæˆ â†’ ç»“æœBå…¥é˜Ÿ â†’ é˜Ÿåˆ—: [B]
   æ—¶åˆ»1.0s: çº¿ç¨‹1å®Œæˆ â†’ ç»“æœAå…¥é˜Ÿ â†’ é˜Ÿåˆ—: [B, A]
   æ—¶åˆ»1.1s: çº¿ç¨‹4å®Œæˆ â†’ ç»“æœDå…¥é˜Ÿ â†’ é˜Ÿåˆ—: [B, A, D]
   æ—¶åˆ»1.1s: çº¿ç¨‹3å®Œæˆ â†’ ç»“æœCå…¥é˜Ÿ â†’ é˜Ÿåˆ—: [B, A, D, C]

4ï¸âƒ£ å®šæ—¶å™¨è½®è¯¢ï¼ˆ100msé—´éš”ï¼‰
   
   æ—¶åˆ»1.0s: å®šæ—¶å™¨è§¦å‘ â†’ é˜Ÿåˆ—æœ‰ç»“æœ
             â†“
             å–å‡ºç»“æœB â†’ æ˜¾ç¤ºåˆ°åŒºåŸŸ0
             â†“
   æ—¶åˆ»1.1s: å®šæ—¶å™¨è§¦å‘ â†’ é˜Ÿåˆ—æœ‰ç»“æœ
             â†“
             å–å‡ºç»“æœA â†’ æ˜¾ç¤ºåˆ°åŒºåŸŸ1
             â†“
   æ—¶åˆ»1.2s: å®šæ—¶å™¨è§¦å‘ â†’ é˜Ÿåˆ—æœ‰ç»“æœ
             â†“
             å–å‡ºç»“æœD â†’ æ˜¾ç¤ºåˆ°åŒºåŸŸ2
             â†“
   æ—¶åˆ»1.3s: å®šæ—¶å™¨è§¦å‘ â†’ é˜Ÿåˆ—æœ‰ç»“æœ
             â†“
             å–å‡ºç»“æœC â†’ æ˜¾ç¤ºåˆ°åŒºåŸŸ3

5ï¸âƒ£ æœ€ç»ˆç»“æœ
   
   åŒºåŸŸ0: æ–‡ä»¶B âœ…
   åŒºåŸŸ1: æ–‡ä»¶A âœ…
   åŒºåŸŸ2: æ–‡ä»¶D âœ…
   åŒºåŸŸ3: æ–‡ä»¶C âœ…
   
   æŒ‰å®Œæˆé¡ºåºæ˜¾ç¤ºï¼ˆä¸æ˜¯æ¥æ”¶é¡ºåºï¼‰
```

---

## ğŸ”‘ å…³é”®ç‰¹æ€§

### 1. **å¤šçº¿ç¨‹å¹¶è¡Œä¸‹è½½**

```python
# åŒæ—¶åˆ›å»ºå¤šä¸ªä¸‹è½½çº¿ç¨‹
self.downloader.download('image', client, file_id1, path1, device_id)  # çº¿ç¨‹1
self.downloader.download('image', client, file_id2, path2, device_id)  # çº¿ç¨‹2
self.downloader.download('image', client, file_id3, path3, device_id)  # çº¿ç¨‹3
self.downloader.download('image', client, file_id4, path4, device_id)  # çº¿ç¨‹4

# 4ä¸ªçº¿ç¨‹åŒæ—¶ä¸‹è½½ï¼Œæ€»æ—¶é—´çº¦1ç§’
```

### 2. **ç»“æœé˜Ÿåˆ—ï¼ˆç¼“å†²ï¼‰**

```python
# ä¸‹è½½çº¿ç¨‹å®Œæˆå
result = DownloadResult(...)
self.result_queue.put(result)  # æ”¾å…¥é˜Ÿåˆ—ï¼Œä¸é˜»å¡

# é˜Ÿåˆ—æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆä½¿ç”¨queue.Queueï¼‰
# å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶put
```

### 3. **å®šæ—¶å™¨è½®è¯¢**

```python
# ä¸»çº¿ç¨‹çš„å®šæ—¶å™¨ï¼ˆ100msé—´éš”ï¼‰
self.result_timer = QTimer(self)
self.result_timer.timeout.connect(self.check_download_results)
self.result_timer.start(100)

def check_download_results(self):
    """æ¯100msæ£€æŸ¥ä¸€æ¬¡é˜Ÿåˆ—"""
    if self.downloader.has_results():
        result = self.downloader.get_result()  # éé˜»å¡è·å–
        self.process_result(result)            # å¤„ç†ç»“æœ
```

### 4. **éé˜»å¡è·å–**

```python
def get_result(self):
    """ä»é˜Ÿåˆ—è·å–ç»“æœï¼ˆéé˜»å¡ï¼‰"""
    try:
        return self.result_queue.get_nowait()  # ç«‹å³è¿”å›
    except queue.Empty:
        return None  # é˜Ÿåˆ—ç©ºï¼Œè¿”å›None
```

---

## ğŸ“Š æ€§èƒ½åˆ†æ

### æ—¶é—´æ¶ˆè€—

| é˜¶æ®µ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| ä¸‹è½½ï¼ˆå¹¶è¡Œï¼‰ | 1ç§’ | 4ä¸ªçº¿ç¨‹åŒæ—¶ä¸‹è½½ |
| å…¥é˜Ÿï¼ˆå¹¶è¡Œï¼‰ | <0.01ç§’ | å‡ ä¹ç¬é—´ |
| è½®è¯¢é—´éš” | 0.1ç§’ Ã— 4 | æ¯æ¬¡è½®è¯¢å¤„ç†1ä¸ªç»“æœ |
| **æ€»æ—¶é—´** | **çº¦1.4ç§’** | å¿«é€Ÿï¼|

### å¯¹æ¯”å…¶ä»–æ–¹æ¡ˆ

| æ–¹æ¡ˆ | æ€»æ—¶é—´ | é¡ºåº | å¤æ‚åº¦ |
|------|--------|------|--------|
| ä¸²è¡Œä¸‹è½½ | 4ç§’ | ä¿è¯ | ä½ |
| å¤šçº¿ç¨‹+ä¿¡å· | 1ç§’ | ä¸ä¿è¯ | é«˜ï¼ˆç«æ€é—®é¢˜ï¼‰|
| **å¤šçº¿ç¨‹+é˜Ÿåˆ—** | **1.4ç§’** | **FIFO** | **ä¸­** |

---

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### åˆå§‹åŒ–

```python
def __init__(self):
    # åˆ›å»ºä¸‹è½½ç®¡ç†å™¨
    self.downloader = ThreadedDownloader()
    
    # åˆ›å»ºå®šæ—¶å™¨ï¼ˆè½®è¯¢é˜Ÿåˆ—ï¼‰
    self.result_timer = QTimer(self)
    self.result_timer.timeout.connect(self.check_download_results)
    self.result_timer.start(100)  # 100msé—´éš”
```

### å¯åŠ¨ä¸‹è½½

```python
def on_new_image_received(self, data):
    file_id = data.get('file_id')
    device_id = data.get('device_id')
    
    # å¯åŠ¨ä¸‹è½½çº¿ç¨‹
    self.downloader.download(
        task_type='image',
        client=self.client,
        file_id=file_id,
        save_path=save_path,
        device_id=device_id
    )
    # ç«‹å³è¿”å›ï¼Œä¸é˜»å¡
```

### è½®è¯¢é˜Ÿåˆ—

```python
def check_download_results(self):
    """å®šæ—¶å™¨å›è°ƒï¼ˆæ¯100msï¼‰"""
    
    # æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦æœ‰ç»“æœ
    if self.downloader.has_results():
        
        # è·å–ä¸€ä¸ªç»“æœ
        result = self.downloader.get_result()
        
        # å¤„ç†ç»“æœ
        if result.success:
            self.load_and_display(result.file_path, result.device_id)
        else:
            self.show_error(result.error)
```

---

## âœ… ä¼˜åŠ¿

### 1. **å¿«é€Ÿä¸‹è½½**
- å¤šçº¿ç¨‹å¹¶è¡Œï¼Œå……åˆ†åˆ©ç”¨å¸¦å®½
- 4ä¸ªæ–‡ä»¶åªéœ€1ç§’ï¼ˆvs ä¸²è¡Œçš„4ç§’ï¼‰

### 2. **ä¸²è¡Œå¤„ç†**
- å®šæ—¶å™¨æ¯æ¬¡å¤„ç†1ä¸ªç»“æœ
- é¿å…UIåŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡
- ä¸ä¼šæœ‰å†²çª

### 3. **è§£è€¦è®¾è®¡**
- ä¸‹è½½çº¿ç¨‹ä¸å…³å¿ƒUI
- ä¸»çº¿ç¨‹ä¸å…³å¿ƒä¸‹è½½
- é€šè¿‡é˜Ÿåˆ—è§£è€¦

### 4. **ç®€å•å¯é **
- ä¸éœ€è¦å¤æ‚çš„ä¿¡å·è¿æ¥
- ä¸éœ€è¦ç­‰å¾…æœºåˆ¶
- å®šæ—¶å™¨è‡ªåŠ¨è½®è¯¢

---

## ğŸ“ æ—¥å¿—ç¤ºä¾‹

```
2025-12-12 06:00:01 | INFO | å¯åŠ¨ä¸‹è½½çº¿ç¨‹: image, img_001.png, æ´»è·ƒçº¿ç¨‹æ•°: 1
2025-12-12 06:00:01 | INFO | å¯åŠ¨ä¸‹è½½çº¿ç¨‹: image, img_002.png, æ´»è·ƒçº¿ç¨‹æ•°: 2
2025-12-12 06:00:01 | INFO | å¯åŠ¨ä¸‹è½½çº¿ç¨‹: image, img_003.png, æ´»è·ƒçº¿ç¨‹æ•°: 3
2025-12-12 06:00:01 | INFO | å¯åŠ¨ä¸‹è½½çº¿ç¨‹: image, img_004.png, æ´»è·ƒçº¿ç¨‹æ•°: 4

2025-12-12 06:00:02 | INFO | [ä¸‹è½½çº¿ç¨‹] ä¸‹è½½å®Œæˆ image: img_002.png
2025-12-12 06:00:02 | DEBUG| [ä¸‹è½½çº¿ç¨‹] ç»“æœå·²æ”¾å…¥é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—å¤§å°: 1

2025-12-12 06:00:02 | INFO | [ä¸‹è½½çº¿ç¨‹] ä¸‹è½½å®Œæˆ image: img_001.png
2025-12-12 06:00:02 | DEBUG| [ä¸‹è½½çº¿ç¨‹] ç»“æœå·²æ”¾å…¥é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—å¤§å°: 2

2025-12-12 06:00:02 | INFO | [å®šæ—¶å™¨] è½®è¯¢é˜Ÿåˆ—ï¼Œå‘ç°ç»“æœ
2025-12-12 06:00:02 | INFO | [è®¾å¤‡12323] âœ… å›¾ç‰‡å·²åŠ è½½åˆ°åŒºåŸŸ 0: img_002.png

2025-12-12 06:00:02 | INFO | [å®šæ—¶å™¨] è½®è¯¢é˜Ÿåˆ—ï¼Œå‘ç°ç»“æœ
2025-12-12 06:00:02 | INFO | [è®¾å¤‡12323] âœ… å›¾ç‰‡å·²åŠ è½½åˆ°åŒºåŸŸ 1: img_001.png

2025-12-12 06:00:02 | INFO | [ä¸‹è½½çº¿ç¨‹] ä¸‹è½½å®Œæˆ image: img_003.png
2025-12-12 06:00:02 | DEBUG| [ä¸‹è½½çº¿ç¨‹] ç»“æœå·²æ”¾å…¥é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—å¤§å°: 1

2025-12-12 06:00:02 | INFO | [å®šæ—¶å™¨] è½®è¯¢é˜Ÿåˆ—ï¼Œå‘ç°ç»“æœ
2025-12-12 06:00:02 | INFO | [è®¾å¤‡12323] âœ… å›¾ç‰‡å·²åŠ è½½åˆ°åŒºåŸŸ 2: img_003.png
```

---

## ğŸ†š å¯¹æ¯”æ‰€æœ‰æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¼”è¿›

#### v1ï¼šå¤šçº¿ç¨‹ç›´æ¥å‘ä¿¡å·
```python
thread.download_finished.connect(self.on_finished)
thread.start()
# âŒ å¤šä¸ªä¿¡å·åŒæ—¶åˆ°è¾¾ï¼ŒUIå†²çª
```

#### v2ï¼šå•çº¿ç¨‹ + ä»»åŠ¡é˜Ÿåˆ—
```python
worker.add_task(task)
worker.run():
    while True:
        task = queue.get()
        download(task)
# âŒ ä¸‹è½½æ…¢ï¼ˆä¸²è¡Œï¼‰
```

#### v3ï¼šå¤šçº¿ç¨‹ + ç»“æœé˜Ÿåˆ— + å¤„ç†çº¿ç¨‹
```python
thread.start() â†’ result_queue.put()
processor.run():
    result = queue.get()
    emit_signal()
# âœ… å¿«ä½†å¤æ‚
```

#### v4ï¼šå¤šçº¿ç¨‹ + ç»“æœé˜Ÿåˆ— + å®šæ—¶å™¨è½®è¯¢ï¼ˆâœ… å½“å‰ï¼‰
```python
thread.start() â†’ result_queue.put()
timer.timeout:
    result = queue.get_nowait()
    process(result)
# âœ… å¿«é€Ÿã€ç®€å•ã€å¯é 
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | ä¸‹è½½é€Ÿåº¦ | UIå®‰å…¨ | å¤æ‚åº¦ | æ¨èåº¦ |
|------|---------|--------|--------|--------|
| v1ï¼ˆç›´æ¥ä¿¡å·ï¼‰ | â­â­â­â­â­ | â­ | â­ | âŒ |
| v2ï¼ˆå•çº¿ç¨‹ï¼‰ | â­â­ | â­â­â­â­â­ | â­ | âŒ |
| v3ï¼ˆå¤„ç†çº¿ç¨‹ï¼‰ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **v4ï¼ˆå®šæ—¶è½®è¯¢ï¼‰** | **â­â­â­â­â­** | **â­â­â­â­â­** | **â­â­** | **â­â­â­â­â­** |

---

## ğŸ¯ å…³é”®ä¼˜åŠ¿

### 1. **å¿«é€Ÿä¸‹è½½**
- å¤šçº¿ç¨‹å¹¶è¡Œï¼Œ1ç§’ä¸‹è½½4ä¸ªæ–‡ä»¶
- å……åˆ†åˆ©ç”¨ç½‘ç»œå¸¦å®½

### 2. **ä¸²è¡Œå¤„ç†**
- å®šæ—¶å™¨æ¯æ¬¡å¤„ç†1ä¸ªç»“æœ
- é¿å…UIå¹¶å‘æ“ä½œ
- ä¸ä¼šå‡ºç°å†²çª

### 3. **ç®€å•è®¾è®¡**
- ä¸éœ€è¦é¢å¤–çš„å¤„ç†çº¿ç¨‹
- ä½¿ç”¨PyQtçš„å®šæ—¶å™¨ï¼ˆå†…ç½®åŠŸèƒ½ï¼‰
- ä»£ç ç®€æ´æ˜“æ‡‚

### 4. **å¯æ§èŠ‚å¥**
- 100msé—´éš”ï¼Œä¸ä¼šå¤ªå¿«ä¹Ÿä¸ä¼šå¤ªæ…¢
- å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´é—´éš”
- ä¸»çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡

---

## ğŸ“‹ ä»£ç ç¤ºä¾‹

### å®Œæ•´å®ç°

```python
class ExcelDataViewerWindow:
    def __init__(self):
        # åˆ›å»ºä¸‹è½½ç®¡ç†å™¨
        self.downloader = ThreadedDownloader()
        
        # åˆ›å»ºå®šæ—¶å™¨
        self.result_timer = QTimer(self)
        self.result_timer.timeout.connect(self.check_download_results)
        self.result_timer.start(100)
    
    def on_new_data_received(self, data):
        """æ”¶åˆ°ä¸‹è½½é€šçŸ¥"""
        # å¯åŠ¨ä¸‹è½½çº¿ç¨‹
        self.downloader.download(
            task_type='excel',
            client=self.client,
            file_id=data['file_id'],
            save_path=save_path,
            device_id=data['device_id']
        )
    
    def check_download_results(self):
        """å®šæ—¶å™¨å›è°ƒï¼šæ£€æŸ¥é˜Ÿåˆ—"""
        # ä¸€æ¬¡å¤„ç†ä¸€ä¸ªç»“æœ
        if self.downloader.has_results():
            result = self.downloader.get_result()
            
            if result.success:
                self.load_excel_file(result.file_path, result.device_id)
            else:
                self.show_error(result.error)
```

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒç‰¹æ€§

1. **å¤šçº¿ç¨‹å¹¶è¡Œä¸‹è½½**ï¼šå¿«é€Ÿ
2. **ç»“æœé˜Ÿåˆ—ç¼“å†²**ï¼šè§£è€¦
3. **å®šæ—¶å™¨è½®è¯¢**ï¼šä¸²è¡Œå¤„ç†
4. **ç®€å•å¯é **ï¼šæ˜“ç»´æŠ¤

### é€‚ç”¨åœºæ™¯

- âœ… ç”µé‡æ•°æ®ä¸‹è½½
- âœ… å‡ ä½•é‡å›¾ç‰‡ä¸‹è½½
- âœ… æ‰€æœ‰éœ€è¦å¿«é€Ÿä¸‹è½½ + å®‰å…¨å¤„ç†çš„åœºæ™¯

### æ–‡ä»¶æ¸…å•

- `Module/common/threaded_downloader.py` - å¤šçº¿ç¨‹ä¸‹è½½ç®¡ç†å™¨
- `Module/excel_data_viewer/index/excel_viewer_window.py` - ç”µé‡ç•Œé¢
- `Module/image_data_viewer/index/image_viewer_window.py` - å‡ ä½•é‡ç•Œé¢

### å…³é”®ä»£ç 

```python
# åˆå§‹åŒ–
self.downloader = ThreadedDownloader()
self.result_timer = QTimer(self)
self.result_timer.timeout.connect(self.check_download_results)
self.result_timer.start(100)

# ä¸‹è½½
self.downloader.download('image', client, file_id, save_path, device_id)

# è½®è¯¢
def check_download_results(self):
    if self.downloader.has_results():
        result = self.downloader.get_result()
        self.process(result)
```

**å¿«é€Ÿã€ç®€å•ã€å¯é  - å®Œç¾çš„æ–¹æ¡ˆï¼** ğŸ‰

