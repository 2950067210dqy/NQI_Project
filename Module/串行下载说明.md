# ä¸²è¡Œä¸‹è½½æ–¹æ¡ˆ

## ğŸ¯ è®¾è®¡ç›®æ ‡

**å‡ ä½•é‡ç•Œé¢ï¼šä¸‹è½½ â†’ æ˜¾ç¤º â†’ ä¸‹è½½ â†’ æ˜¾ç¤º**

### æ ¸å¿ƒæ€æƒ³
- ä¸€æ¬¡åªä¸‹è½½ä¸€ä¸ªå›¾ç‰‡
- ä¸‹è½½å®Œæˆåç«‹å³æ˜¾ç¤ºåˆ°åŒºåŸŸ
- æ˜¾ç¤ºå®Œæˆåæ‰å¼€å§‹ä¸‹è½½ä¸‹ä¸€ä¸ª
- ç¡®ä¿å›¾ç‰‡æŒ‰é¡ºåºæ˜¾ç¤ºï¼Œä¸ä¼šå†²çª

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
ä»»åŠ¡é˜Ÿåˆ—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ä»»åŠ¡1] [ä»»åŠ¡2] [ä»»åŠ¡3] [ä»»åŠ¡4]â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ ä¸²è¡Œå¤„ç†
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸²è¡Œä¸‹è½½å™¨        â”‚
â”‚ (ä¸€æ¬¡å¤„ç†ä¸€ä¸ª)    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
ä»»åŠ¡1: ä¸‹è½½ â†’ å®Œæˆ â†’ ä¿¡å· â†’ ä¸»çº¿ç¨‹æ˜¾ç¤º
             â†“ (ç­‰å¾…æ˜¾ç¤ºå®Œæˆ)
ä»»åŠ¡2: ä¸‹è½½ â†’ å®Œæˆ â†’ ä¿¡å· â†’ ä¸»çº¿ç¨‹æ˜¾ç¤º
             â†“ (ç­‰å¾…æ˜¾ç¤ºå®Œæˆ)
ä»»åŠ¡3: ä¸‹è½½ â†’ å®Œæˆ â†’ ä¿¡å· â†’ ä¸»çº¿ç¨‹æ˜¾ç¤º
             â†“ (ç­‰å¾…æ˜¾ç¤ºå®Œæˆ)
ä»»åŠ¡4: ä¸‹è½½ â†’ å®Œæˆ â†’ ä¿¡å· â†’ ä¸»çº¿ç¨‹æ˜¾ç¤º
```

---

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. `DownloadTask`ï¼ˆä¸‹è½½ä»»åŠ¡ï¼‰

```python
class DownloadTask:
    def __init__(self, task_type: str, client, file_id, save_path: Path, device_id: str):
        self.task_type = task_type    # 'image'
        self.client = client           # ä¸‹è½½å®¢æˆ·ç«¯
        self.file_id = file_id         # æ–‡ä»¶ID
        self.save_path = save_path     # ä¿å­˜è·¯å¾„
        self.device_id = device_id     # è®¾å¤‡ID
```

### 2. `SingleDownloadThread`ï¼ˆå•æ¬¡ä¸‹è½½çº¿ç¨‹ï¼‰

```python
class SingleDownloadThread(QThread):
    download_finished = pyqtSignal(str, str)  # file_path, device_id
    download_failed = pyqtSignal(str, str)    # error, device_id
    
    def run(self):
        # ä¸‹è½½å•ä¸ªæ–‡ä»¶
        self.client.download_image_file(self.file_id, self.save_path)
        
        # å‘é€å®Œæˆä¿¡å·
        self.download_finished.emit(str(self.save_path), self.device_id)
```

### 3. `SerialDownloader`ï¼ˆä¸²è¡Œä¸‹è½½å™¨ï¼‰

```python
class SerialDownloader(QThread):
    download_finished = pyqtSignal(str, str)  # è½¬å‘ä¿¡å·
    download_failed = pyqtSignal(str, str)
    
    def run(self):
        while self.running:
            # ä»é˜Ÿåˆ—å–ä»»åŠ¡
            task = self.task_queue.get(timeout=1.0)
            
            # åˆ›å»ºä¸‹è½½çº¿ç¨‹
            thread = SingleDownloadThread(task)
            thread.download_finished.connect(self._on_download_finished)
            
            # âœ… å¯åŠ¨å¹¶ç­‰å¾…å®Œæˆ
            thread.start()
            thread.wait()  # å…³é”®ï¼šç­‰å¾…ä¸‹è½½å®Œæˆ
            
            # ä»»åŠ¡å®Œæˆï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
            self.task_queue.task_done()
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### 4ä¸ªå›¾ç‰‡ä¸‹è½½

```
1ï¸âƒ£ æ¥æ”¶4ä¸ªä¸‹è½½é€šçŸ¥
   â†’ æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—: [å›¾1, å›¾2, å›¾3, å›¾4]

2ï¸âƒ£ ä¸²è¡Œå¤„ç†
   
   æ—¶åˆ»1: å–å‡ºå›¾1
          â†“
          ä¸‹è½½å›¾1 (1ç§’)
          â†“
          å‘é€å®Œæˆä¿¡å· â†’ ä¸»çº¿ç¨‹æ˜¾ç¤ºåˆ°åŒºåŸŸ0
          â†“ (ç­‰å¾…å®Œæˆ)
   
   æ—¶åˆ»2: å–å‡ºå›¾2
          â†“
          ä¸‹è½½å›¾2 (1ç§’)
          â†“
          å‘é€å®Œæˆä¿¡å· â†’ ä¸»çº¿ç¨‹æ˜¾ç¤ºåˆ°åŒºåŸŸ1
          â†“ (ç­‰å¾…å®Œæˆ)
   
   æ—¶åˆ»3: å–å‡ºå›¾3
          â†“
          ä¸‹è½½å›¾3 (1ç§’)
          â†“
          å‘é€å®Œæˆä¿¡å· â†’ ä¸»çº¿ç¨‹æ˜¾ç¤ºåˆ°åŒºåŸŸ2
          â†“ (ç­‰å¾…å®Œæˆ)
   
   æ—¶åˆ»4: å–å‡ºå›¾4
          â†“
          ä¸‹è½½å›¾4 (1ç§’)
          â†“
          å‘é€å®Œæˆä¿¡å· â†’ ä¸»çº¿ç¨‹æ˜¾ç¤ºåˆ°åŒºåŸŸ3

3ï¸âƒ£ æœ€ç»ˆç»“æœ
   åŒºåŸŸ0: å›¾1 âœ…
   åŒºåŸŸ1: å›¾2 âœ…
   åŒºåŸŸ2: å›¾3 âœ…
   åŒºåŸŸ3: å›¾4 âœ…
   
   æŒ‰é¡ºåºæ˜¾ç¤ºï¼Œä¸ä¼šå†²çªï¼
```

---

## ğŸ”‘ å…³é”®ç‰¹æ€§

### 1. `thread.wait()`ï¼ˆç­‰å¾…å®Œæˆï¼‰

```python
# åˆ›å»ºä¸‹è½½çº¿ç¨‹
thread = SingleDownloadThread(task)
thread.start()

# âœ… å…³é”®ï¼šç­‰å¾…çº¿ç¨‹å®Œæˆæ‰ç»§ç»­
thread.wait()  # é˜»å¡ï¼Œç›´åˆ°ä¸‹è½½å®Œæˆ

# ä¸‹è½½å®Œæˆåï¼Œæ‰å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡
next_task = self.task_queue.get()
```

**ä½œç”¨**ï¼š
- ç¡®ä¿ä¸€æ¬¡åªæœ‰ä¸€ä¸ªä¸‹è½½åœ¨è¿›è¡Œ
- ä¸‹è½½å®Œæˆåæ‰å¼€å§‹ä¸‹ä¸€ä¸ª
- å›¾ç‰‡æŒ‰é¡ºåºæ˜¾ç¤º

### 2. ä»»åŠ¡é˜Ÿåˆ—ï¼ˆFIFOï¼‰

```python
self.task_queue = queue.Queue()

# æ·»åŠ ä»»åŠ¡
self.task_queue.put(task1)
self.task_queue.put(task2)
self.task_queue.put(task3)

# ä¸²è¡Œå–å‡º
task = self.task_queue.get()  # å…ˆè¿›å…ˆå‡º
```

**ç‰¹ç‚¹**ï¼š
- å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰
- ä¿è¯å¤„ç†é¡ºåº
- çº¿ç¨‹å®‰å…¨

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### 4ä¸ªæ–‡ä»¶ï¼ˆæ¯ä¸ª1MBï¼‰

| æ–¹æ¡ˆ | æ€»æ—¶é—´ | é¡ºåºä¿è¯ | UIå®‰å…¨æ€§ |
|------|--------|---------|----------|
| å¤šçº¿ç¨‹å¹¶è¡Œ | 1ç§’ | âŒ | âŒ |
| ä¸²è¡Œä¸‹è½½ | 4ç§’ | âœ… | âœ… |

**è¯´æ˜**ï¼š
- å¤šçº¿ç¨‹å¹¶è¡Œå¿«ï¼Œä½†å¯èƒ½ä¹±åºã€å†²çª
- ä¸²è¡Œä¸‹è½½æ…¢ï¼Œä½†é¡ºåºæ­£ç¡®ã€ç»å¯¹å®‰å…¨

---

## ğŸ†š å¯¹æ¯”ï¼šå¹¶è¡Œ vs ä¸²è¡Œ

### å¹¶è¡Œä¸‹è½½ï¼ˆæ—§æ–¹æ¡ˆï¼‰

```
çº¿ç¨‹1: ä¸‹è½½å›¾1 â”
çº¿ç¨‹2: ä¸‹è½½å›¾2 â”œâ”€ åŒæ—¶è¿›è¡Œï¼ˆ1ç§’ï¼‰
çº¿ç¨‹3: ä¸‹è½½å›¾3 â”‚
çº¿ç¨‹4: ä¸‹è½½å›¾4 â”˜
       â†“ (å‡ ä¹åŒæ—¶å®Œæˆ)
    [å®Œæˆé¡ºåºä¸ç¡®å®š]
       â†“
   ä¸»çº¿ç¨‹å¤„ç†ï¼šå¯èƒ½å†²çª âŒ
```

**é—®é¢˜**ï¼š
- å®Œæˆé¡ºåºä¸ç¡®å®šï¼ˆå¯èƒ½æ˜¯ 2â†’1â†’4â†’3ï¼‰
- å¤šä¸ªä¿¡å·åŒæ—¶åˆ°è¾¾
- å¯èƒ½å¤šä¸ªå›¾ç‰‡æ˜¾ç¤ºåœ¨åŒä¸€åŒºåŸŸ

### ä¸²è¡Œä¸‹è½½ï¼ˆâœ… æ–°æ–¹æ¡ˆï¼‰

```
å›¾1: ä¸‹è½½(1ç§’) â†’ å®Œæˆ â†’ æ˜¾ç¤º â†’ ç»§ç»­
      â†“
å›¾2: ä¸‹è½½(1ç§’) â†’ å®Œæˆ â†’ æ˜¾ç¤º â†’ ç»§ç»­
      â†“
å›¾3: ä¸‹è½½(1ç§’) â†’ å®Œæˆ â†’ æ˜¾ç¤º â†’ ç»§ç»­
      â†“
å›¾4: ä¸‹è½½(1ç§’) â†’ å®Œæˆ â†’ æ˜¾ç¤º â†’ å®Œæˆ

æ€»æ—¶é—´: 4ç§’
é¡ºåº: 1 â†’ 2 â†’ 3 â†’ 4 âœ…
```

**ä¼˜ç‚¹**ï¼š
- é¡ºåºç¡®å®šï¼ˆæŒ‰æ¥æ”¶é¡ºåºï¼‰
- ä¸€æ¬¡å¤„ç†ä¸€ä¸ª
- ä¸ä¼šå†²çª

---

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### åˆå§‹åŒ–

```python
# åœ¨çª—å£ __init__ ä¸­
self.serial_downloader = SerialDownloader()
self.serial_downloader.download_finished.connect(self.on_image_download_finished)
self.serial_downloader.download_failed.connect(self.on_image_download_failed)
self.serial_downloader.start()
```

### æ·»åŠ ä¸‹è½½ä»»åŠ¡

```python
# æ”¶åˆ°æ–°å›¾ç‰‡é€šçŸ¥
def on_new_image_received(self, data):
    file_id = data.get('file_id')
    device_id = data.get('device_id')
    
    # åˆ›å»ºä»»åŠ¡
    task = DownloadTask(
        task_type='image',
        client=self.client,
        file_id=file_id,
        save_path=save_path,
        device_id=device_id
    )
    
    # æ·»åŠ åˆ°ä¸²è¡Œé˜Ÿåˆ—
    self.serial_downloader.add_task(task)
    # ç«‹å³è¿”å›ï¼Œä¸é˜»å¡
```

### å¤„ç†ä¸‹è½½å®Œæˆ

```python
# ä¸‹è½½å®Œæˆå›è°ƒï¼ˆæŒ‰é¡ºåºä¸€ä¸ªä¸€ä¸ªæ¥ï¼‰
def on_image_download_finished(self, file_path: str, device_id: str):
    # è·å–è®¾å¤‡tab
    device_tab = self.get_or_create_device_image_tab(device_id)
    
    # è·å–ä¸‹ä¸€ä¸ªåŒºåŸŸ
    widget = self.get_next_widget_for_device(device_tab)
    
    # åŠ è½½å¹¶æ˜¾ç¤ºå›¾ç‰‡
    widget.load_original_image(Path(file_path))
    
    # å¤„ç†å®Œæˆï¼Œä¸²è¡Œä¸‹è½½å™¨ä¼šè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡
```

---

## ğŸ¯ å…³é”®ä¼˜åŠ¿

### 1. **é¡ºåºä¿è¯**
```
æ¥æ”¶é¡ºåº: å›¾1 â†’ å›¾2 â†’ å›¾3 â†’ å›¾4
æ˜¾ç¤ºé¡ºåº: å›¾1 â†’ å›¾2 â†’ å›¾3 â†’ å›¾4  âœ… å®Œå…¨ä¸€è‡´
```

### 2. **é¿å…å†²çª**
```
ä¸€æ¬¡åªå¤„ç†ä¸€ä¸ª:
  ä¸‹è½½å›¾1 â†’ æ˜¾ç¤ºåˆ°åŒºåŸŸ0 âœ…
  ä¸‹è½½å›¾2 â†’ æ˜¾ç¤ºåˆ°åŒºåŸŸ1 âœ…
  
ä¸ä¼šå‡ºç°:
  ä¸‹è½½å›¾1 â†’ æ˜¾ç¤ºåˆ°åŒºåŸŸ0
  ä¸‹è½½å›¾2 â†’ ä¹Ÿæ˜¾ç¤ºåˆ°åŒºåŸŸ0 âŒ è¦†ç›–
```

### 3. **ç®€å•å¯é **
- ä¸éœ€è¦å¤æ‚çš„é”æœºåˆ¶
- ä¸éœ€è¦çŠ¶æ€ç®¡ç†
- é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£
- ç»å¯¹ä¸ä¼šå‡ºé”™

### 4. **è‡ªåŠ¨ç»§ç»­**
```python
# ä¸‹è½½å®Œæˆåï¼ŒSerialDownloader ä¼šè‡ªåŠ¨ï¼š
thread.wait()              # ç­‰å¾…ä¸‹è½½å®Œæˆ
signal.emit()              # å‘é€ä¿¡å·ç»™ä¸»çº¿ç¨‹
task_queue.task_done()     # æ ‡è®°ä»»åŠ¡å®Œæˆ
next_task = queue.get()    # è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€ä¸ª
```

---

## ğŸ“ æ—¥å¿—ç¤ºä¾‹

```
2025-12-12 05:45:01 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] æ·»åŠ ä»»åŠ¡: img_001.png, é˜Ÿåˆ—å¤§å°: 1
2025-12-12 05:45:01 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] æ·»åŠ ä»»åŠ¡: img_002.png, é˜Ÿåˆ—å¤§å°: 2
2025-12-12 05:45:01 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] æ·»åŠ ä»»åŠ¡: img_003.png, é˜Ÿåˆ—å¤§å°: 3
2025-12-12 05:45:01 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] æ·»åŠ ä»»åŠ¡: img_004.png, é˜Ÿåˆ—å¤§å°: 4

2025-12-12 05:45:01 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] å¼€å§‹ä¸‹è½½ä»»åŠ¡: img_001.png
2025-12-12 05:45:02 | INFO | [ä¸²è¡Œä¸‹è½½] ä¸‹è½½å®Œæˆ: img_001.png
2025-12-12 05:45:02 | INFO | [è®¾å¤‡12323] âœ… å›¾ç‰‡å·²åŠ è½½åˆ°åŒºåŸŸ 0: img_001.png
2025-12-12 05:45:02 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] ä»»åŠ¡å®Œæˆï¼Œé˜Ÿåˆ—å‰©ä½™: 3

2025-12-12 05:45:02 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] å¼€å§‹ä¸‹è½½ä»»åŠ¡: img_002.png
2025-12-12 05:45:03 | INFO | [ä¸²è¡Œä¸‹è½½] ä¸‹è½½å®Œæˆ: img_002.png
2025-12-12 05:45:03 | INFO | [è®¾å¤‡12323] âœ… å›¾ç‰‡å·²åŠ è½½åˆ°åŒºåŸŸ 1: img_002.png
2025-12-12 05:45:03 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] ä»»åŠ¡å®Œæˆï¼Œé˜Ÿåˆ—å‰©ä½™: 2

2025-12-12 05:45:03 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] å¼€å§‹ä¸‹è½½ä»»åŠ¡: img_003.png
2025-12-12 05:45:04 | INFO | [ä¸²è¡Œä¸‹è½½] ä¸‹è½½å®Œæˆ: img_003.png
2025-12-12 05:45:04 | INFO | [è®¾å¤‡12323] âœ… å›¾ç‰‡å·²åŠ è½½åˆ°åŒºåŸŸ 2: img_003.png
2025-12-12 05:45:04 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] ä»»åŠ¡å®Œæˆï¼Œé˜Ÿåˆ—å‰©ä½™: 1

2025-12-12 05:45:04 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] å¼€å§‹ä¸‹è½½ä»»åŠ¡: img_004.png
2025-12-12 05:45:05 | INFO | [ä¸²è¡Œä¸‹è½½] ä¸‹è½½å®Œæˆ: img_004.png
2025-12-12 05:45:05 | INFO | [è®¾å¤‡12323] âœ… å›¾ç‰‡å·²åŠ è½½åˆ°åŒºåŸŸ 3: img_004.png
2025-12-12 05:45:05 | INFO | [ä¸²è¡Œä¸‹è½½å™¨] ä»»åŠ¡å®Œæˆï¼Œé˜Ÿåˆ—å‰©ä½™: 0
```

**å¯ä»¥çœ‹åˆ°**ï¼š
- ä»»åŠ¡æŒ‰é¡ºåºæ·»åŠ 
- ä¸‹è½½æŒ‰é¡ºåºæ‰§è¡Œ
- æ˜¾ç¤ºæŒ‰é¡ºåºå®Œæˆ
- å®Œç¾ï¼âœ…

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒç‰¹æ€§

1. **ä¸²è¡Œä¸‹è½½**ï¼šä¸€æ¬¡åªä¸‹è½½ä¸€ä¸ª
2. **ç­‰å¾…å®Œæˆ**ï¼š`thread.wait()` ç¡®ä¿é¡ºåº
3. **æŒ‰åºæ˜¾ç¤º**ï¼šå›¾ç‰‡æŒ‰æ¥æ”¶é¡ºåºæ˜¾ç¤º
4. **é¿å…å†²çª**ï¼šä¸ä¼šå‡ºç°å¤šå›¾åŒåŒºåŸŸ

### é€‚ç”¨åœºæ™¯

- âœ… éœ€è¦ä¿è¯é¡ºåºçš„ä¸‹è½½
- âœ… é¿å…UIå†²çªçš„åœºæ™¯
- âœ… å›¾ç‰‡é€ä¸ªæ˜¾ç¤ºçš„éœ€æ±‚

### æ–‡ä»¶æ¸…å•

- `Module/common/serial_downloader.py` - ä¸²è¡Œä¸‹è½½å™¨
- `Module/image_data_viewer/index/image_viewer_window.py` - å‡ ä½•é‡ç•Œé¢ï¼ˆå·²ä¿®æ”¹ï¼‰

### å…³é”®ä»£ç 

```python
# åˆå§‹åŒ–
self.serial_downloader = SerialDownloader()
self.serial_downloader.download_finished.connect(self.on_download_finished)
self.serial_downloader.start()

# æ·»åŠ ä»»åŠ¡
task = DownloadTask('image', client, file_id, save_path, device_id)
self.serial_downloader.add_task(task)  # æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œè‡ªåŠ¨ä¸²è¡Œå¤„ç†

# å¤„ç†ç»“æœ
def on_download_finished(self, file_path, device_id):
    self.load_and_display(file_path)  # æ˜¾ç¤ºå®Œæˆåï¼Œä¸‹è½½å™¨è‡ªåŠ¨ç»§ç»­ä¸‹ä¸€ä¸ª
```

**ç¨³å®šå¯é ï¼Œç»ä¸å‡ºé”™ï¼** ğŸ‰

