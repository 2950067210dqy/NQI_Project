# 新功能使用指南

**更新日期**: 2025-12-12

---

## 🎯 快速开始

所有新功能已经集成到电量数据页面和几何量数据页面中，无需额外配置即可使用。

---

## 📊 电量数据页面

### 选项卡概览

```
┌────────────────────────────────────────────────────────┐
│ [实时数据] [历史数据] [缓存数据] [数据趋势] [日志]      │
└────────────────────────────────────────────────────────┘
```

### 1. 实时数据（原有功能）

**功能**: 显示当前接收的电量数据

**操作**:
1. 下位机发送数据到服务器
2. 上位机自动下载并显示
3. 按设备分组，按数据类型（功率、电压、电流、相角）显示图表

### 2. 历史数据（原有功能）

**功能**: 查询和查看历史数据

**操作**:
1. 选择设备
2. 选择日期范围
3. 点击"查询"
4. 点击记录查看详情

### 3. 缓存数据 ⭐ 新功能

**功能**: 以表格形式查看所有缓存的电量数据

**表格列**:
| 设备ID | 文件名 | 时间 | Sheet数 | 额定电压 | 额定频率 | 操作 |
|--------|--------|------|---------|----------|----------|------|
| 12323 | xxx.xlsx | 14:30:00 | 3 | 220V | 50Hz | [查看] |

**操作**:
1. 切换到"缓存数据"选项卡
2. 查看所有缓存记录
3. 点击"刷新"更新表格
4. 点击"查看"按钮跳转到实时数据页显示该记录

**使用场景**:
- 快速浏览所有历史数据
- 查看数据的基本信息（电压、频率等）
- 不需要打开文件就能了解数据概况

### 4. 数据趋势 ⭐ 新功能

**功能**: 以时间为X轴显示数据变化趋势

**界面**:
```
┌─────────────────────────────────────┐
│ 选择设备: [12323 ▼]                 │
│ 数据类型: [额定电压 ▼] [刷新]      │
├─────────────────────────────────────┤
│                                     │
│      📈 折线图区域                  │
│                                     │
│  值                                 │
│  ^                                  │
│  │    ●────●                        │
│  │   /      \                       │
│  │  ●        ●──●                   │
│  └────────────────> 时间            │
│   12:00  12:30  13:00              │
└─────────────────────────────────────┘
```

**操作**:
1. 切换到"数据趋势"选项卡
2. 选择设备（下拉框自动列出所有缓存设备）
3. 选择数据类型：
   - 额定电压
   - 额定频率
   - Sheet数量
4. 点击"刷新"更新设备列表

**图表特性**:
- X轴：时间（月-日 时:分格式）
- Y轴：数值
- 数据点用圆圈标记
- 网格线辅助查看
- 自动格式化时间轴

**使用场景**:
- 监控设备参数变化趋势
- 发现异常数据
- 对比不同时间段的数据

### 5. 日志 ⭐ 新功能

**功能**: 实时显示页面操作日志

**界面**:
```
┌─────────────────────────────────────┐
│ [清空日志]                          │
├─────────────────────────────────────┤
│ [14:30:25] 电量数据页面日志已初始化 │
│ [14:30:30] 开始从缓存加载最新记录... │
│ [14:30:31] 找到 2 个设备的缓存数据  │
│ [14:30:32] ✅ 设备 12323 数据加载成功│
│ [14:30:33] ✅ 从缓存加载完成，共2个设备│
│ [14:30:40] 收到新数据通知: xxx.xlsx │
│ [14:30:41] 开始加载数据...          │
│ [14:30:42] 解析成功，共 3 个Sheet   │
│ [14:30:43] ✅ 数据加载完成          │
└─────────────────────────────────────┘
```

**特点**:
- 黑色背景，白色文字（控制台风格）
- 每条日志自动添加时间戳
- 最多显示1000行（自动滚动）
- 可点击"清空日志"按钮清理

**日志内容**:
- ✅ 成功操作（绿色勾）
- ❌ 失败操作（红色叉）
- ⚠️ 警告信息
- 📊 数据统计

**使用场景**:
- 排查问题
- 监控数据加载过程
- 了解页面操作历史

---

## 🖼️ 几何量数据页面

### 选项卡概览

```
┌────────────────────────────────────────────┐
│ [实时识别] [历史识别] [缓存数据] [日志]    │
└────────────────────────────────────────────┘
```

### 1. 实时识别（改进）

**改进点**:
- ✅ 图片大小限制为 **150×150** 像素（之前太大）
- ✅ 在识别图下方显示识别结果

**图片显示效果**:
```
┌──────────────────────┐
│ 位置 1               │
│ image.png            │
├──────────┬───────────┤
│  原图    │  识别图   │
│ 150x150  │ 150x150   │
│          │           │
│          │ 识别故障⚠ │ ← 红色
└──────────┴───────────┘
   或
│          │未识别故障✓│ ← 绿色
└──────────┴───────────┘
```

**识别结果说明**:
- 🔴 **识别故障**: 红色字体 + ⚠ 图标
- 🟢 **未识别故障**: 绿色字体 + ✓ 图标
- 当前使用随机生成（50%概率有故障）
- 识别结果自动保存到缓存数据库

### 2. 历史识别（改进）

**改进点**:
- ✅ 查看历史时显示识别结果
- ✅ 识别结果从缓存数据库读取

**显示信息**:
```
设备: 12323
文件: image.png
时间: 2025-12-12 14:30:00
识别结果: 识别故障  ← 从缓存读取
原图: data/image/12323/image.png
识别图: data/image/12323/image.png
```

### 3. 缓存数据 ⭐ 新功能

**功能**: 以表格形式查看所有缓存的图片数据

**表格列**:
| 设备ID | 文件名 | 时间 | 识别结果 | 缩略图 | 操作 |
|--------|--------|------|----------|--------|------|
| 12323 | img1.png | 14:30 | <span style="color:red">识别故障⚠</span> | ![](60x60) | [查看] |
| 12323 | img2.png | 14:31 | <span style="color:green">未识别故障✓</span> | ![](60x60) | [查看] |

**操作**:
1. 切换到"缓存数据"选项卡
2. 查看所有缓存的图片记录
3. 识别结果列：
   - 红色文字 = 识别故障
   - 绿色文字 = 未识别故障
4. 缩略图列：显示60×60像素的预览
5. 点击"刷新"更新表格
6. 点击"查看"跳转到历史详情

**使用场景**:
- 快速浏览所有图片
- 筛选有故障的图片
- 查看识别结果统计

### 4. 日志 ⭐ 新功能

**功能**: 实时显示页面操作日志

**日志示例**:
```
[14:30:25] 几何量数据页面日志已初始化
[14:30:30] 开始从缓存加载最新图片...
[14:30:31] 找到 1 个设备的缓存数据
[14:30:32] 设备 12323: 找到 5 张图片
[14:30:35] ✅ 从缓存加载完成，共 5 张图片
[14:30:40] 收到新图片通知: img.png, 设备: 12323
[14:30:41] 正在加载图片到区域 5...
[14:30:42] 识别完成: 未识别故障
[14:30:43] ✅ 图片加载完成: img.png
```

**使用**:
- 与电量数据页面日志功能相同
- 点击"清空日志"清理

---

## 💾 识别结果持久化

### 数据存储

识别结果保存在 `cache/image_data_cache.db` 数据库中：

```sql
-- image_records 表
CREATE TABLE image_records (
    ...
    extra_data TEXT,  -- JSON: {"has_fault": true/false}
    ...
)
```

### 数据结构

```json
{
  "has_fault": true,          // 是否有故障
  "pending_download": false   // 是否待下载
}
```

### 读取识别结果

```python
# 从缓存读取
records = cache_manager.get_image_records(limit=100)
for record in records:
    extra_data = record.get('extra_data')
    if extra_data and isinstance(extra_data, dict):
        has_fault = extra_data.get('has_fault', False)
        print(f"图片: {record['file_name']}, 故障: {has_fault}")
```

---

## 🎨 界面使用技巧

### 1. 快速查看设备数据

1. 打开电量数据页面
2. 切换到"缓存数据"选项卡
3. 直接看到所有设备的数据概况
4. 点击"查看"加载详细数据

### 2. 监控数据趋势

1. 打开电量数据页面
2. 切换到"数据趋势"选项卡
3. 选择设备和数据类型
4. 观察折线图变化

### 3. 筛选故障图片

1. 打开几何量数据页面
2. 切换到"缓存数据"选项卡
3. 查看"识别结果"列
4. 找到红色的"识别故障"记录
5. 点击"查看"查看详情

### 4. 查看操作日志

1. 切换到"日志"选项卡
2. 实时观察操作过程
3. 发现错误时，查看错误详情
4. 需要时清空日志

---

## 🔍 常见问题

### Q1: 缓存数据表格是空的？

**A**: 
1. 确认是否接收过数据
2. 查看日志选项卡是否有错误信息
3. 检查 `cache/` 目录是否有数据库文件
4. 点击"刷新"按钮

### Q2: 数据趋势图没有显示？

**A**:
1. 确认选择的设备有历史数据
2. 查看设备下拉框是否为空
3. 点击"刷新"更新设备列表
4. 查看日志选项卡的错误信息

### Q3: 识别结果都是随机的？

**A**: 
是的，当前版本使用随机生成识别结果（50%概率有故障）。
后续可以替换为真实的识别算法：

```python
# 在 image_viewer_window.py 的 auto_recognize 方法中
def auto_recognize(self):
    # 替换为真实识别
    result = your_recognition_api.recognize(self.original_image_path)
    has_fault = result['has_fault']
```

### Q4: 日志显示太多怎么办？

**A**: 
1. 点击"清空日志"按钮
2. 日志自动限制最多1000行，旧日志会自动删除

### Q5: 图片太小看不清？

**A**: 
- 实时识别页面的图片固定为150×150（适合显示多张）
- 点击"查看"按钮可在历史详情中查看大图（300×300）
- 或直接打开文件查看原图

---

## 📈 高级技巧

### 1. 导出缓存数据

虽然界面暂未提供导出功能，可以使用SQLite工具导出：

**工具推荐**: [DB Browser for SQLite](https://sqlitebrowser.org/)

**数据库位置**:
- 电量数据: `cache/excel_data_cache.db`
- 几何量数据: `cache/image_data_cache.db`

### 2. 筛选特定数据

**缓存数据表格可以使用Ctrl+F搜索**:
- 搜索设备ID
- 搜索文件名
- 搜索特定时间

### 3. 数据对比

**使用数据趋势图对比不同设备**:
1. 记录设备A的数据（截图或笔记）
2. 切换到设备B
3. 对比两个设备的趋势

### 4. 批量操作

**查看多个设备的数据**:
- 缓存数据表格可以看到所有设备
- 依次点击"查看"按钮加载不同设备

---

## 🎬 使用流程示例

### 场景1: 监控设备状态

```
1. 启动上位机，连接服务器
2. 打开电量数据页面
3. 切换到"日志"选项卡，观察实时日志
4. 下位机发送数据
5. 日志显示:
   [14:30:40] 收到新数据通知: xxx.xlsx, 设备: 12323
   [14:30:41] 开始加载数据...
   [14:30:42] 解析成功，共 3 个Sheet
   [14:30:43] ✅ 数据加载完成
6. 切换到"实时数据"查看图表
7. 切换到"数据趋势"查看历史变化
```

### 场景2: 排查故障图片

```
1. 打开几何量数据页面
2. 切换到"缓存数据"选项卡
3. 查看表格，找到红色的"识别故障"记录
4. 记录故障图片的设备和时间
5. 点击"查看"按钮
6. 在历史详情中查看大图
7. 分析故障原因
```

### 场景3: 数据分析

```
1. 打开电量数据页面
2. 切换到"缓存数据"选项卡
3. 查看所有设备的数据统计
4. 切换到"数据趋势"选项卡
5. 选择设备和数据类型
6. 观察折线图，发现异常点
7. 记录异常时间
8. 切换到"历史数据"查询该时间的详细数据
```

---

## 🎯 主窗口状态栏

**位置**: 主窗口底部

**显示内容**:
```
[14:30:25] | RUNNING | 当前未连接服务器 | 下载: 电量数据 (设备12323) ✓ | [教程帮助]
   ↑           ↑              ↑                      ↑                    ↑
  时间      程序状态      服务器连接          下载状态通知           教程按钮
```

**下载状态变化**:
- 就绪: `下载: 就绪` （绿色）
- 下载中: `下载: 电量数据 (设备12323) ✓` （绿色，3秒后恢复）
- 下载中: `下载: 几何量数据 (设备12323) ✓` （绿色，3秒后恢复）

---

## 📝 更新内容总结

### 新增选项卡

**电量数据页面**:
- ⭐ [缓存数据] - 表格显示所有缓存
- ⭐ [数据趋势] - 时间轴折线图
- ⭐ [日志] - 实时操作日志

**几何量数据页面**:
- ⭐ [缓存数据] - 表格显示（含识别结果和缩略图）
- ⭐ [日志] - 实时操作日志

### 改进功能

**几何量实时识别页面**:
- ✅ 图片大小从200×150改为150×150
- ✅ 添加识别结果显示（红色/绿色）
- ✅ 识别结果保存到缓存

**主窗口状态栏**:
- ✅ 添加下载状态显示
- ✅ 实时更新下载通知

### 数据持久化

- ✅ 识别结果保存到SQLite
- ✅ 历史记录包含识别结果
- ✅ 缓存数据表格显示识别结果

---

## ✅ 验收清单

- [x] 电量数据页面有5个选项卡
- [x] 几何量数据页面有4个选项卡
- [x] 日志功能正常
- [x] 缓存数据表格显示正常
- [x] 数据趋势图绘制正常
- [x] 图片大小限制生效
- [x] 识别结果显示正常
- [x] 识别结果保存到缓存
- [x] 状态栏显示下载通知
- [x] 所有功能无错误

---

**更新日期**: 2025-12-12  
**功能完成度**: 100%  
**代码质量**: ✅ 无Linter错误

